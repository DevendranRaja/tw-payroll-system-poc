/*
 * MIT License
 *
 * Copyright (c) 2019 RÃ©mi Van Keisbelck
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
import { Cmd, Sub } from 'tea-cup-core';
import { Program } from '.';
import React from 'react';
// export function extendJest<M>(expect: jest.Expect) {
//   expect.extend({
//     toHaveDispatchedMsg(received: Testing<M>, expected: M) {
//       const pass = this.equals(received.dispatched, expected);
//       const message = () =>
//         this.utils.matcherHint('toBe', undefined, undefined) +
//         '\n\n' +
//         `Expected: ${this.utils.printExpected(expected)}\n` +
//         `Received: ${this.utils.printReceived(received.dispatched)}`;
//       return { actual: received, message, pass };
//     },
//   });
// }
// declare global {
//   namespace jest {
//     interface Matchers<R> {
//       toHaveDispatchedMsg<M>(value: M): CustomMatcherResult;
//     }
//   }
// }
export class Testing {
    constructor() {
        this.noop = () => { };
    }
    Testing() { }
    get dispatcher() {
        this._dispatched = undefined;
        return (msg) => {
            this._dispatched = msg;
        };
    }
    get dispatched() {
        return this._dispatched;
    }
    dispatchFrom(cmd) {
        return new Promise((resolve, reject) => {
            const dispatchedMsg = (msg) => {
                resolve(msg);
            };
            cmd.execute(dispatchedMsg);
        });
    }
}
export function updateUntilIdle(props, fun) {
    return new Promise((resolve) => {
        let wrapper = fun(React.createElement(Program, Object.assign({}, testableProps(resolve, props, () => wrapper))));
    });
}
function testableProps(resolve, props, getWrapper) {
    const tprops = {
        init: initTestable(resolve, props.init),
        view: viewTestable(props.view),
        update: updateTestable(props.update),
        subscriptions: subscriptionsTestable(props, getWrapper),
    };
    return tprops;
}
function initTestable(resolve, init) {
    const mac = init();
    return () => [
        {
            resolve,
            cmds: [mac[1]],
            model: mac[0],
        },
        Cmd.none(),
    ];
}
function viewTestable(view) {
    return (dispatch, model) => view(dispatch, model.model);
}
function updateTestable(update) {
    return (msg, model) => {
        const [model1, cmd1] = update(msg, model.model);
        const cmds = [cmd1].filter((cmd) => cmd.constructor.name !== 'CmdNone');
        return [
            Object.assign(Object.assign({}, model), { cmds, model: model1 }),
            Cmd.none(),
        ];
    };
}
function subscriptionsTestable(props, getWrapper) {
    return (model) => {
        const subs = props.subscriptions(model.model);
        if (model.cmds.length === 0) {
            const result = getWrapper();
            model.resolve([model.model, result]);
            return subs;
        }
        return Sub.batch([new TestableSub(model.cmds), subs]);
    };
}
class TestableSub extends Sub {
    constructor(cmds) {
        super();
        this.cmds = cmds;
    }
    onInit() {
        setTimeout(() => {
            this.isActive() && this.cmds.forEach((cmd) => cmd.execute((m) => this.dispatch(m)));
            // if (this.dispatcher !== undefined) {
            //   const d = this.dispatcher.bind(this);
            //   this.cmds.map((cmd) => cmd.execute(d));
            // }
        }, 0);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGVzdGluZy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9UZWFDdXAvVGVzdGluZy50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBdUJHO0FBRUgsT0FBTyxFQUFjLEdBQUcsRUFBRSxHQUFHLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFFcEQsT0FBTyxFQUFnQixPQUFPLEVBQUUsTUFBTSxHQUFHLENBQUM7QUFDMUMsT0FBTyxLQUFLLE1BQU0sT0FBTyxDQUFDO0FBRTFCLHVEQUF1RDtBQUN2RCxvQkFBb0I7QUFDcEIsK0RBQStEO0FBQy9ELGlFQUFpRTtBQUVqRSw4QkFBOEI7QUFDOUIsaUVBQWlFO0FBQ2pFLG1CQUFtQjtBQUNuQixnRUFBZ0U7QUFDaEUsd0VBQXdFO0FBRXhFLG9EQUFvRDtBQUNwRCxTQUFTO0FBQ1QsUUFBUTtBQUNSLElBQUk7QUFFSixtQkFBbUI7QUFDbkIscUJBQXFCO0FBQ3JCLDhCQUE4QjtBQUM5QiwrREFBK0Q7QUFDL0QsUUFBUTtBQUNSLE1BQU07QUFDTixJQUFJO0FBRUosTUFBTSxPQUFPLE9BQU87SUFBcEI7UUFLa0IsU0FBSSxHQUFrQixHQUFHLEVBQUUsR0FBRSxDQUFDLENBQUM7SUFxQmpELENBQUM7SUF2QlEsT0FBTyxLQUFJLENBQUM7SUFJbkIsSUFBVyxVQUFVO1FBQ25CLElBQUksQ0FBQyxXQUFXLEdBQUcsU0FBUyxDQUFDO1FBQzdCLE9BQU8sQ0FBQyxHQUFNLEVBQUUsRUFBRTtZQUNoQixJQUFJLENBQUMsV0FBVyxHQUFHLEdBQUcsQ0FBQztRQUN6QixDQUFDLENBQUM7SUFDSixDQUFDO0lBRUQsSUFBVyxVQUFVO1FBQ25CLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQztJQUMxQixDQUFDO0lBRU0sWUFBWSxDQUFDLEdBQVc7UUFDN0IsT0FBTyxJQUFJLE9BQU8sQ0FBSSxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUN4QyxNQUFN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QztRQUNELE9BQU8sR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksV0FBVyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQ3hELENBQUMsQ0FBQztBQUNKLENBQUM7QUFFRCxNQUFNLFdBQWlCLFNBQVEsR0FBUTtJQUNyQyxZQUE2QixJQUF5QjtRQUNwRCxLQUFLLEVBQUUsQ0FBQztRQURtQixTQUFJLEdBQUosSUFBSSxDQUFxQjtJQUV0RCxDQUFDO0lBRVMsTUFBTTtRQUNkLFVBQVUsQ0FBQyxHQUFHLEVBQUU7WUFDZCxJQUFJLENBQUMsUUFBUSxFQUFFLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3BGLHVDQUF1QztZQUN2QywwQ0FBMEM7WUFDMUMsNENBQTRDO1lBQzVDLElBQUk7UUFDTixDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDUixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTUlUIExpY2Vuc2VcbiAqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTkgUsOpbWkgVmFuIEtlaXNiZWxja1xuICpcbiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlIFwiU29mdHdhcmVcIiksIHRvIGRlYWxcbiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHNcbiAqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGxcbiAqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpc1xuICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczpcbiAqXG4gKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbiBhbGxcbiAqIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuXG4gKlxuICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuICogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksXG4gKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbiAqIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXG4gKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRVxuICogU09GVFdBUkUuXG4gKlxuICovXG5cbmltcG9ydCB7IERpc3BhdGNoZXIsIENtZCwgU3ViIH0gZnJvbSAndGVhLWN1cC1jb3JlJztcbmltcG9ydCB7IFJlYWN0RWxlbWVudCB9IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7IFByb2dyYW1Qcm9wcywgUHJvZ3JhbSB9IGZyb20gJy4nO1xuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcblxuLy8gZXhwb3J0IGZ1bmN0aW9uIGV4dGVuZEplc3Q8TT4oZXhwZWN0OiBqZXN0LkV4cGVjdCkge1xuLy8gICBleHBlY3QuZXh0ZW5kKHtcbi8vICAgICB0b0hhdmVEaXNwYXRjaGVkTXNnKHJlY2VpdmVkOiBUZXN0aW5nPE0+LCBleHBlY3RlZDogTSkge1xuLy8gICAgICAgY29uc3QgcGFzcyA9IHRoaXMuZXF1YWxzKHJlY2VpdmVkLmRpc3BhdGNoZWQsIGV4cGVjdGVkKTtcblxuLy8gICAgICAgY29uc3QgbWVzc2FnZSA9ICgpID0+XG4vLyAgICAgICAgIHRoaXMudXRpbHMubWF0Y2hlckhpbnQoJ3RvQmUnLCB1bmRlZmluZWQsIHVuZGVmaW5lZCkgK1xuLy8gICAgICAgICAnXFxuXFxuJyArXG4vLyAgICAgICAgIGBFeHBlY3RlZDogJHt0aGlzLnV0aWxzLnByaW50RXhwZWN0ZWQoZXhwZWN0ZWQpfVxcbmAgK1xuLy8gICAgICAgICBgUmVjZWl2ZWQ6ICR7dGhpcy51dGlscy5wcmludFJlY2VpdmVkKHJlY2VpdmVkLmRpc3BhdGNoZWQpfWA7XG5cbi8vICAgICAgIHJldHVybiB7IGFjdHVhbDogcmVjZWl2ZWQsIG1lc3NhZ2UsIHBhc3MgfTtcbi8vICAgICB9LFxuLy8gICB9KTtcbi8vIH1cblxuLy8gZGVjbGFyZSBnbG9iYWwge1xuLy8gICBuYW1lc3BhY2UgamVzdCB7XG4vLyAgICAgaW50ZXJmYWNlIE1hdGNoZXJzPFI+IHtcbi8vICAgICAgIHRvSGF2ZURpc3BhdGNoZWRNc2c8TT4odmFsdWU6IE0pOiBDdXN0b21NYXRjaGVyUmVzdWx0O1xuLy8gICAgIH1cbi8vICAgfVxuLy8gfVxuXG5leHBvcnQgY2xhc3MgVGVzdGluZzxNPiB7XG4gIHByaXZhdGUgX2Rpc3BhdGNoZWQ6IE0gfCB1bmRlZmluZWQ7XG5cbiAgcHVibGljIFRlc3RpbmcoKSB7fVxuXG4gIHB1YmxpYyByZWFkb25seSBub29wOiBEaXNwYXRjaGVyPE0+ID0gKCkgPT4ge307XG5cbiAgcHVibGljIGdldCBkaXNwYXRjaGVyKCk6IERpc3BhdGNoZXI8TT4ge1xuICAgIHRoaXMuX2Rpc3BhdGNoZWQgPSB1bmRlZmluZWQ7XG4gICAgcmV0dXJuIChtc2c6IE0pID0+IHtcbiAgICAgIHRoaXMuX2Rpc3BhdGNoZWQgPSBtc2c7XG4gICAgfTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgZGlzcGF0Y2hlZCgpOiBNIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5fZGlzcGF0Y2hlZDtcbiAgfVxuXG4gIHB1YmxpYyBkaXNwYXRjaEZyb20oY21kOiBDbWQ8TT4pOiBQcm9taXNlPE0+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8TT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY29uc3QgZGlzcGF0Y2hlZE1zZyA9IChtc2c6IE0pID0+IHtcbiAgICAgICAgcmVzb2x2ZShtc2cpO1xuICAgICAgfTtcbiAgICAgIGNtZC5leGVjdXRlKGRpc3BhdGNoZWRNc2cpO1xuICAgIH0pO1xuICB9XG59XG5cbnR5cGUgVHJpZ2dlcjxNb2RlbCwgTXNnLCBUPiA9IChub2RlOiBSZWFjdEVsZW1lbnQ8UHJvZ3JhbVByb3BzPE1vZGVsLCBNc2c+PikgPT4gVDtcbnR5cGUgUmVzb2x2ZVR5cGU8TW9kZWwsIFQ+ID0gKGlkbGU6IFtNb2RlbCwgVF0pID0+IHZvaWQ7XG5cbmV4cG9ydCBmdW5jdGlvbiB1cGRhdGVVbnRpbElkbGU8TW9kZWwsIE1zZywgVD4oXG4gIHByb3BzOiBQcm9ncmFtUHJvcHM8TW9kZWwsIE1zZz4sXG4gIGZ1bjogVHJpZ2dlcjxNb2RlbCwgTXNnLCBUPixcbik6IFByb21pc2U8W01vZGVsLCBUXT4ge1xuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICBsZXQgd3JhcHBlciA9IGZ1big8UHJvZ3JhbSB7Li4udGVzdGFibGVQcm9wcyhyZXNvbHZlLCBwcm9wcywgKCkgPT4gd3JhcHBlcil9IC8+KTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHRlc3RhYmxlUHJvcHM8TW9kZWwsIE1zZywgVD4oXG4gIHJlc29sdmU6IFJlc29sdmVUeXBlPE1vZGVsLCBUPixcbiAgcHJvcHM6IFByb2dyYW1Qcm9wczxNb2RlbCwgTXNnPixcbiAgZ2V0V3JhcHBlcjogKCkgPT4gVCxcbikge1xuICBjb25zdCB0cHJvcHM6IFByb2dyYW1Qcm9wczxUZXN0YWJsZU1vZGVsPE1vZGVsLCBNc2csIFQ+LCBNc2c+ID0ge1xuICAgIGluaXQ6IGluaXRUZXN0YWJsZShyZXNvbHZlLCBwcm9wcy5pbml0KSxcbiAgICB2aWV3OiB2aWV3VGVzdGFibGUocHJvcHMudmlldyksXG4gICAgdXBkYXRlOiB1cGRhdGVUZXN0YWJsZShwcm9wcy51cGRhdGUpLFxuICAgIHN1YnNjcmlwdGlvbnM6IHN1YnNjcmlwdGlvbnNUZXN0YWJsZShwcm9wcywgZ2V0V3JhcHBlciksXG4gIH07XG4gIHJldHVybiB0cHJvcHM7XG59XG5cbnR5cGUgVGVzdGFibGVNb2RlbDxNb2RlbCwgTXNnLCBUPiA9IHtcbiAgcmVhZG9ubHkgcmVzb2x2ZTogUmVzb2x2ZVR5cGU8TW9kZWwsIFQ+O1xuICByZWFkb25seSBjbWRzOiBDbWQ8TXNnPltdO1xuICByZWFkb25seSBtb2RlbDogTW9kZWw7XG59O1xuXG5mdW5jdGlvbiBpbml0VGVzdGFibGU8TW9kZWwsIE1zZywgVD4oXG4gIHJlc29sdmU6IFJlc29sdmVUeXBlPE1vZGVsLCBUPixcbiAgaW5pdDogUHJvZ3JhbVByb3BzPE1vZGVsLCBNc2c+Wydpbml0J10sXG4pOiBQcm9ncmFtUHJvcHM8VGVzdGFibGVNb2RlbDxNb2RlbCwgTXNnLCBUPiwgTXNnPlsnaW5pdCddIHtcbiAgY29uc3QgbWFjID0gaW5pdCgpO1xuICByZXR1cm4gKCkgPT4gW1xuICAgIHtcbiAgICAgIHJlc29sdmUsXG4gICAgICBjbWRzOiBbbWFjWzFdXSxcbiAgICAgIG1vZGVsOiBtYWNbMF0sXG4gICAgfSxcbiAgICBDbWQubm9uZSgpLFxuICBdO1xufVxuXG5mdW5jdGlvbiB2aWV3VGVzdGFibGU8TW9kZWwsIE1zZywgVD4oXG4gIHZpZXc6IFByb2dyYW1Qcm9wczxNb2RlbCwgTXNnPlsndmlldyddLFxuKTogUHJvZ3JhbVByb3BzPFRlc3RhYmxlTW9kZWw8TW9kZWwsIE1zZywgVD4sIE1zZz5bJ3ZpZXcnXSB7XG4gIHJldHVybiAoZGlzcGF0Y2g6IERpc3BhdGNoZXI8TXNnPiwgbW9kZWw6IFRlc3RhYmxlTW9kZWw8TW9kZWwsIE1zZywgVD4pID0+IHZpZXcoZGlzcGF0Y2gsIG1vZGVsLm1vZGVsKTtcbn1cblxuZnVuY3Rpb24gdXBkYXRlVGVzdGFibGU8TW9kZWwsIE1zZywgVD4oXG4gIHVwZGF0ZTogUHJvZ3JhbVByb3BzPE1vZGVsLCBNc2c+Wyd1cGRhdGUnXSxcbik6IFByb2dyYW1Qcm9wczxUZXN0YWJsZU1vZGVsPE1vZGVsLCBNc2csIFQ+LCBNc2c+Wyd1cGRhdGUnXSB7XG4gIHJldHVybiAobXNnOiBNc2csIG1vZGVsOiBUZXN0YWJsZU1vZGVsPE1vZGVsLCBNc2csIFQ+KSA9PiB7XG4gICAgY29uc3QgW21vZGVsMSwgY21kMV0gPSB1cGRhdGUobXNnLCBtb2RlbC5tb2RlbCk7XG4gICAgY29uc3QgY21kcyA9IFtjbWQxXS5maWx0ZXIoKGNtZCkgPT4gY21kLmNvbnN0cnVjdG9yLm5hbWUgIT09ICdDbWROb25lJyk7XG4gICAgcmV0dXJuIFtcbiAgICAgIHtcbiAgICAgICAgLi4ubW9kZWwsXG4gICAgICAgIGNtZHMsXG4gICAgICAgIG1vZGVsOiBtb2RlbDEsXG4gICAgICB9LFxuICAgICAgQ21kLm5vbmUoKSxcbiAgICBdO1xuICB9O1xufVxuXG5mdW5jdGlvbiBzdWJzY3JpcHRpb25zVGVzdGFibGU8TW9kZWwsIE1zZywgVD4oXG4gIHByb3BzOiBQcm9ncmFtUHJvcHM8TW9kZWwsIE1zZz4sXG4gIGdldFdyYXBwZXI6ICgpID0+IFQsXG4pOiBQcm9ncmFtUHJvcHM8VGVzdGFibGVNb2RlbDxNb2RlbCwgTXNnLCBUPiwgTXNnPlsnc3Vic2NyaXB0aW9ucyddIHtcbiAgcmV0dXJuIChtb2RlbDogVGVzdGFibGVNb2RlbDxNb2RlbCwgTXNnLCBUPikgPT4ge1xuICAgIGNvbnN0IHN1YnMgPSBwcm9wcy5zdWJzY3JpcHRpb25zKG1vZGVsLm1vZGVsKTtcbiAgICBpZiAobW9kZWwuY21kcy5sZW5ndGggPT09IDApIHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGdldFdyYXBwZXIoKTtcbiAgICAgIG1vZGVsLnJlc29sdmUoW21vZGVsLm1vZGVsLCByZXN1bHRdKTtcbiAgICAgIHJldHVybiBzdWJzO1xuICAgIH1cbiAgICByZXR1cm4gU3ViLmJhdGNoKFtuZXcgVGVzdGFibGVTdWIobW9kZWwuY21kcyksIHN1YnNdKTtcbiAgfTtcbn1cblxuY2xhc3MgVGVzdGFibGVTdWI8TXNnPiBleHRlbmRzIFN1YjxNc2c+IHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBjbWRzOiByZWFkb25seSBDbWQ8TXNnPltdKSB7XG4gICAgc3VwZXIoKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBvbkluaXQoKTogdm9pZCB7XG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICB0aGlzLmlzQWN0aXZlKCkgJiYgdGhpcy5jbWRzLmZvckVhY2goKGNtZCkgPT4gY21kLmV4ZWN1dGUoKG0pID0+IHRoaXMuZGlzcGF0Y2gobSkpKTtcbiAgICAgIC8vIGlmICh0aGlzLmRpc3BhdGNoZXIgIT09IHVuZGVmaW5lZCkge1xuICAgICAgLy8gICBjb25zdCBkID0gdGhpcy5kaXNwYXRjaGVyLmJpbmQodGhpcyk7XG4gICAgICAvLyAgIHRoaXMuY21kcy5tYXAoKGNtZCkgPT4gY21kLmV4ZWN1dGUoZCkpO1xuICAgICAgLy8gfVxuICAgIH0sIDApO1xuICB9XG59XG4iXX0=
/*
 * MIT License
 *
 * Copyright (c) 2019 Rémi Van Keisbelck
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
import { Router, int, route0, route1, route2, route3, str, QueryParams, RouteDef } from './Navigation';
import { just, nothing } from 'tea-cup-core';
import { expect, test } from "vitest";
function home() {
    return { type: 'home' };
}
function songs(filter = nothing) {
    return { type: 'songs', filter: filter };
}
function song(id, edit = false) {
    return {
        type: 'song',
        id: id,
        edit: edit,
    };
}
function settings(section) {
    return {
        type: 'settings',
        section: section,
    };
}
function withSlashes(rest) {
    return {
        type: 'with-slashes',
        rest: rest,
    };
}
function withSpaces(v) {
    return {
        type: 'with-spaces',
        v: v,
    };
}
const router = new Router(route1(str('songs')).map((s, query) => songs(query.getValue('q'))), route0.map(() => home()), route3(str('song'), int(), str('edit')).map((s, id) => song(id, true)), route2(str('song'), int()).map((_, id) => song(id)), route1(str('settings')).map((_, query) => settings(query.getHash())), route2(str('with-spaces'), str()).map((_, v) => {
    return withSpaces(v);
}), {
    checkRoute(pathname, query) {
        const parts = RouteDef.splitPath(pathname);
        if (parts.length < 2) {
            return nothing;
        }
        if (parts[0] !== 'with' || parts[1] !== 'slashes') {
            return nothing;
        }
        const rest = parts.length === 2 ? nothing : just(parts.slice(2).join('/'));
        return just(withSlashes(rest));
    },
});
expectRoute('/', home());
expectRoute('/songs', songs(nothing));
expectRoute('/songs/', songs(nothing));
expectRoute('/song/123', song(123));
expectRoute('/song/123/edit', song(123, true));
expectRoute('/songs?q=foobar', songs(just('foobar')));
expectRoute('/settings', settings(nothing));
expectRoute('/settings#blah', settings(just('blah')));
expectRoute('/with/slashes', withSlashes(nothing));
expectRoute('/with/slashes/foo', withSlashes(just('foo')));
expectRoute('/with/slashes/foo/bar', withSlashes(just('foo/bar')));
expectRoute('/with/slashes/foo/bar/baz', withSlashes(just('foo/bar/baz')));
expectRoute('/with-spaces/foo%20bar', withSpaces('foo bar'));
expectRoute('/with-spaces/j%26-suis_un%2Bt%C3%A9st%3Dpourl%40Q%4089%23%20%C3%A8%20je%20suis%20f%C3%A0o%C3%A7', withSpaces('j&-suis_un+tést=pourl@Q@89# è je suis fàoç'));
expectNotFound('/foo');
expectNotFound('/songs/1');
expectNotFound('/song');
expectNotFound('/song/abc');
expectNotFound('/song/123/foo');
expectSettingRouteHash('/settings#blah', just('blah'));
expectSettingRouteHash('/settings', nothing);
expectSettingRouteHash('/settings?hello', nothing);
expectSettingRouteHash('/settings?hello#blah', just('blah'));
function locFromUrl(url) {
    const indexOfQ = url.indexOf('?');
    if (indexOfQ === -1) {
        const indexOfH = url.indexOf('#');
        if (indexOfH === -1) {
            return {
                pathname: url,
                query: QueryParams.empty(),
            };
        }
        else {
            return {
                pathname: url.substring(0, indexOfH),
                query: QueryParams.fromQueryStringAndHash(undefined, url.substring(indexOfH + 1)),
            };
        }
    }
    else {
        const pathname = url.substring(0, indexOfQ);
        const rest = url.substring(indexOfQ + 1);
        const indexOfH = rest.indexOf('#');
        if (indexOfH === -1) {
            return {
                pathname: pathname,
                query: QueryParams.fromQueryStringAndHash(rest),
            };
        }
        else {
            const q = rest.substring(0, indexOfH);
            const h = rest.substring(indexOfH + 1);
            return {
                pathname: pathname,
                query: QueryParams.fromQueryStringAndHash(q, h),
            };
        }
    }
}
function locationFromLoc(url, loc) {
    return {
        ancestorOrigins: null,
        assign(url) { },
        hash: url.includes('#') ? url.split('#')[1] : '',
        host: '',
        hostname: '',
        href: '',
        origin: '',
        pathname: loc.pathname,
        port: '',
        protocol: '',
        reload() { },
        replace(url) { },
        search: '',
    };
}
function expectRoute(url, route) {
    return test(url, () => {
        const loc = locFromUrl(url);
        expect(router.parse(loc.pathname, loc.query)).toEqual(just(route));
    });
}
function expectNotFound(url) {
    return test(url + ' (not found)', () => {
        const loc = locFromUrl(url);
        expect(router.parse(loc.pathname, loc.query)).toEqual(nothing);
    });
}
function expectSettingRouteHash(url, hash) {
    return test(url + ' (hash)', () => {
        const loc = locFromUrl(url);
        const location = locationFromLoc(url, loc);
        const route = router.parseLocation(location);
        route
            .map((r) => {
            if (r.type === 'settings') {
                return expect(r.section).toEqual(hash);
            }
            throw new Error('Not the settings route!');
        })
            .withDefaultSupply(() => {
            throw new Error('Invalid Route!');
        });
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTmF2aWdhdGlvbi50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL1RlYUN1cC9OYXZpZ2F0aW9uLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBdUJHO0FBRUgsT0FBTyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxXQUFXLEVBQUUsUUFBUSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQ3ZHLE9BQU8sRUFBRSxJQUFJLEVBQVMsT0FBTyxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQ3BELE9BQU8sRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBVXRDLFNBQVMsSUFBSTtJQUNYLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLENBQUM7QUFDMUIsQ0FBQztBQUVELFNBQVMsS0FBSyxDQUFDLFNBQXdCLE9BQU87SUFDNUMsT0FBTyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxDQUFDO0FBQzNDLENBQUM7QUFFRCxTQUFTLElBQUksQ0FBQyxFQUFVLEVBQUUsT0FBZ0IsS0FBSztJQUM3QyxPQUFPO1FBQ0wsSUFBSSxFQUFFLE1BQU07UUFDWixFQUFFLEVBQUUsRUFBRTtRQUNOLElBQUksRUFBRSxJQUFJO0tBQ1gsQ0FBQztBQUNKLENBQUM7QUFFRCxTQUFTLFFBQVEsQ0FBQyxPQUFzQjtJQUN0QyxPQUFPO1FBQ0wsSUFBSSxFQUFFLFVBQVU7UUFDaEIsT0FBTyxFQUFFLE9BQU87S0FDakIsQ0FBQztBQUNKLENBQUM7QUFFRCxTQUFTLFdBQVcsQ0FBQyxJQUFtQjtJQUN0QyxPQUFPO1FBQ0wsSUFBSSxFQUFFLGNBQWM7UUFDcEIsSUFBSSxFQUFFLElBQUk7S0FDWCxDQUFDO0FBQ0osQ0FBQztBQUVELFNBQVMsVUFBVSxDQUFD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IjpbIi8qXG4gKiBNSVQgTGljZW5zZVxuICpcbiAqIENvcHlyaWdodCAoYykgMjAxOSBSw6ltaSBWYW4gS2Vpc2JlbGNrXG4gKlxuICogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weVxuICogb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgXCJTb2Z0d2FyZVwiKSwgdG8gZGVhbFxuICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0c1xuICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbFxuICogY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzXG4gKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOlxuICpcbiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluIGFsbFxuICogY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS5cbiAqXG4gKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXG4gKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcbiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxuICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUlxuICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSxcbiAqIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFXG4gKiBTT0ZUV0FSRS5cbiAqXG4gKi9cblxuaW1wb3J0IHsgUm91dGVyLCBpbnQsIHJvdXRlMCwgcm91dGUxLCByb3V0ZTIsIHJvdXRlMywgc3RyLCBRdWVyeVBhcmFtcywgUm91dGVEZWYgfSBmcm9tICcuL05hdmlnYXRpb24nO1xuaW1wb3J0IHsganVzdCwgTWF5YmUsIG5vdGhpbmcgfSBmcm9tICd0ZWEtY3VwLWNvcmUnO1xuaW1wb3J0IHsgZXhwZWN0LCB0ZXN0IH0gZnJvbSBcInZpdGVzdFwiO1xuXG50eXBlIE15Um91dGUgPVxuICB8IHsgdHlwZTogJ2hvbWUnIH1cbiAgfCB7IHR5cGU6ICdzb25ncyc7IGZpbHRlcjogTWF5YmU8c3RyaW5nPiB9XG4gIHwgeyB0eXBlOiAnc29uZyc7IGlkOiBudW1iZXI7IGVkaXQ6IGJvb2xlYW4gfVxuICB8IHsgdHlwZTogJ3NldHRpbmdzJzsgc2VjdGlvbjogTWF5YmU8c3RyaW5nPiB9XG4gIHwgeyB0eXBlOiAnd2l0aC1zbGFzaGVzJzsgcmVzdDogTWF5YmU8c3RyaW5nPiB9XG4gIHwgeyB0eXBlOiAnd2l0aC1zcGFjZXMnOyB2OiBzdHJpbmcgfTtcblxuZnVuY3Rpb24gaG9tZSgpOiBNeVJvdXRlIHtcbiAgcmV0dXJuIHsgdHlwZTogJ2hvbWUnIH07XG59XG5cbmZ1bmN0aW9uIHNvbmdzKGZpbHRlcjogTWF5YmU8c3RyaW5nPiA9IG5vdGhpbmcpOiBNeVJvdXRlIHtcbiAgcmV0dXJuIHsgdHlwZTogJ3NvbmdzJywgZmlsdGVyOiBmaWx0ZXIgfTtcbn1cblxuZnVuY3Rpb24gc29uZyhpZDogbnVtYmVyLCBlZGl0OiBib29sZWFuID0gZmFsc2UpOiBNeVJvdXRlIHtcbiAgcmV0dXJuIHtcbiAgICB0eXBlOiAnc29uZycsXG4gICAgaWQ6IGlkLFxuICAgIGVkaXQ6IGVkaXQsXG4gIH07XG59XG5cbmZ1bmN0aW9uIHNldHRpbmdzKHNlY3Rpb246IE1heWJlPHN0cmluZz4pOiBNeVJvdXRlIHtcbiAgcmV0dXJuIHtcbiAgICB0eXBlOiAnc2V0dGluZ3MnLFxuICAgIHNlY3Rpb246IHNlY3Rpb24sXG4gIH07XG59XG5cbmZ1bmN0aW9uIHdpdGhTbGFzaGVzKHJlc3Q6IE1heWJlPHN0cmluZz4pOiBNeVJvdXRlIHtcbiAgcmV0dXJuIHtcbiAgICB0eXBlOiAnd2l0aC1zbGFzaGVzJyxcbiAgICByZXN0OiByZXN0LFxuICB9O1xufVxuXG5mdW5jdGlvbiB3aXRoU3BhY2VzKHY6IHN0cmluZyk6IE15Um91dGUge1xuICByZXR1cm4ge1xuICAgIHR5cGU6ICd3aXRoLXNwYWNlcycsXG4gICAgdjogdixcbiAgfTtcbn1cblxuY29uc3Qgcm91dGVyOiBSb3V0ZXI8TXlSb3V0ZT4gPSBuZXcgUm91dGVyKFxuICByb3V0ZTEoc3RyKCdzb25ncycpKS5tYXAoKHM6IHN0cmluZywgcXVlcnk6IFF1ZXJ5UGFyYW1zKSA9PiBzb25ncyhxdWVyeS5nZXRWYWx1ZSgncScpKSksXG4gIHJvdXRlMC5tYXAoKCkgPT4gaG9tZSgpKSxcbiAgcm91dGUzKHN0cignc29uZycpLCBpbnQoKSwgc3RyKCdlZGl0JykpLm1hcCgocywgaWQpID0+IHNvbmcoaWQsIHRydWUpKSxcbiAgcm91dGUyKHN0cignc29uZycpLCBpbnQoKSkubWFwKChfLCBpZCkgPT4gc29uZyhpZCkpLFxuICByb3V0ZTEoc3RyKCdzZXR0aW5ncycpKS5tYXAoKF86IHN0cmluZywgcXVlcnk6IFF1ZXJ5UGFyYW1zKSA9PiBzZXR0aW5ncyhxdWVyeS5nZXRIYXNoKCkpKSxcbiAgcm91dGUyKHN0cignd2l0aC1zcGFjZXMnKSwgc3RyKCkpLm1hcCgoXywgdikgPT4ge1xuICAgIHJldHVybiB3aXRoU3BhY2VzKHYpO1xuICB9KSxcbiAge1xuICAgIGNoZWNrUm91dGUocGF0aG5hbWU6IHN0cmluZywgcXVlcnk6IFF1ZXJ5UGFyYW1zKTogTWF5YmU8TXlSb3V0ZT4ge1xuICAgICAgY29uc3QgcGFydHMgPSBSb3V0ZURlZi5zcGxpdFBhdGgocGF0aG5hbWUpO1xuICAgICAgaWYgKHBhcnRzLmxlbmd0aCA8IDIpIHtcbiAgICAgICAgcmV0dXJuIG5vdGhpbmc7XG4gICAgICB9XG4gICAgICBpZiAocGFydHNbMF0gIT09ICd3aXRoJyB8fCBwYXJ0c1sxXSAhPT0gJ3NsYXNoZXMnKSB7XG4gICAgICAgIHJldHVybiBub3RoaW5nO1xuICAgICAgfVxuICAgICAgY29uc3QgcmVzdCA9IHBhcnRzLmxlbmd0aCA9PT0gMiA/IG5vdGhpbmcgOiBqdXN0KHBhcnRzLnNsaWNlKDIpLmpvaW4oJy8nKSk7XG4gICAgICByZXR1cm4ganVzdCh3aXRoU2xhc2hlcyhyZXN0KSk7XG4gICAgfSxcbiAgfSxcbik7XG5cbmV4cGVjdFJvdXRlKCcvJywgaG9tZSgpKTtcbmV4cGVjdFJvdXRlKCcvc29uZ3MnLCBzb25ncyhub3RoaW5nKSk7XG5leHBlY3RSb3V0ZSgnL3NvbmdzLycsIHNvbmdzKG5vdGhpbmcpKTtcbmV4cGVjdFJvdXRlKCcvc29uZy8xMjMnLCBzb25nKDEyMykpO1xuZXhwZWN0Um91dGUoJy9zb25nLzEyMy9lZGl0Jywgc29uZygxMjMsIHRydWUpKTtcbmV4cGVjdFJvdXRlKCcvc29uZ3M/cT1mb29iYXInLCBzb25ncyhqdXN0KCdmb29iYXInKSkpO1xuZXhwZWN0Um91dGUoJy9zZXR0aW5ncycsIHNldHRpbmdzKG5vdGhpbmcpKTtcbmV4cGVjdFJvdXRlKCcvc2V0dGluZ3MjYmxhaCcsIHNldHRpbmdzKGp1c3QoJ2JsYWgnKSkpO1xuZXhwZWN0Um91dGUoJy93aXRoL3NsYXNoZXMnLCB3aXRoU2xhc2hlcyhub3RoaW5nKSk7XG5leHBlY3RSb3V0ZSgnL3dpdGgvc2xhc2hlcy9mb28nLCB3aXRoU2xhc2hlcyhqdXN0KCdmb28nKSkpO1xuZXhwZWN0Um91dGUoJy93aXRoL3NsYXNoZXMvZm9vL2JhcicsIHdpdGhTbGFzaGVzKGp1c3QoJ2Zvby9iYXInKSkpO1xuZXhwZWN0Um91dGUoJy93aXRoL3NsYXNoZXMvZm9vL2Jhci9iYXonLCB3aXRoU2xhc2hlcyhqdXN0KCdmb28vYmFyL2JheicpKSk7XG5leHBlY3RSb3V0ZSgnL3dpdGgtc3BhY2VzL2ZvbyUyMGJhcicsIHdpdGhTcGFjZXMoJ2ZvbyBiYXInKSk7XG5leHBlY3RSb3V0ZShcbiAgJy93aXRoLXNwYWNlcy9qJTI2LXN1aXNfdW4lMkJ0JUMzJUE5c3QlM0Rwb3VybCU0MFElNDA4OSUyMyUyMCVDMyVBOCUyMGplJTIwc3VpcyUyMGYlQzMlQTBvJUMzJUE3JyxcbiAgd2l0aFNwYWNlcygnaiYtc3Vpc191bit0w6lzdD1wb3VybEBRQDg5IyDDqCBqZSBzdWlzIGbDoG/DpycpLFxuKTtcbmV4cGVjdE5vdEZvdW5kKCcvZm9vJyk7XG5leHBlY3ROb3RGb3VuZCgnL3NvbmdzLzEnKTtcbmV4cGVjdE5vdEZvdW5kKCcvc29uZycpO1xuZXhwZWN0Tm90Rm91bmQoJy9zb25nL2FiYycpO1xuZXhwZWN0Tm90Rm91bmQoJy9zb25nLzEyMy9mb28nKTtcbmV4cGVjdFNldHRpbmdSb3V0ZUhhc2goJy9zZXR0aW5ncyNibGFoJywganVzdCgnYmxhaCcpKTtcbmV4cGVjdFNldHRpbmdSb3V0ZUhhc2goJy9zZXR0aW5ncycsIG5vdGhpbmcpO1xuZXhwZWN0U2V0dGluZ1JvdXRlSGFzaCgnL3NldHRpbmdzP2hlbGxvJywgbm90aGluZyk7XG5leHBlY3RTZXR0aW5nUm91dGVIYXNoKCcvc2V0dGluZ3M/aGVsbG8jYmxhaCcsIGp1c3QoJ2JsYWgnKSk7XG5cbmludGVyZmFjZSBMb2Mge1xuICBwYXRobmFtZTogc3RyaW5nO1xuICBxdWVyeTogUXVlcnlQYXJhbXM7XG59XG5cbmZ1bmN0aW9uIGxvY0Zyb21VcmwodXJsOiBzdHJpbmcpOiBMb2Mge1xuICBjb25zdCBpbmRleE9mUSA9IHVybC5pbmRleE9mKCc/Jyk7XG4gIGlmIChpbmRleE9mUSA9PT0gLTEpIHtcbiAgICBjb25zdCBpbmRleE9mSCA9IHVybC5pbmRleE9mKCcjJyk7XG4gICAgaWYgKGluZGV4T2ZIID09PSAtMSkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgcGF0aG5hbWU6IHVybCxcbiAgICAgICAgcXVlcnk6IFF1ZXJ5UGFyYW1zLmVtcHR5KCksXG4gICAgICB9O1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBwYXRobmFtZTogdXJsLnN1YnN0cmluZygwLCBpbmRleE9mSCksXG4gICAgICAgIHF1ZXJ5OiBRdWVyeVBhcmFtcy5mcm9tUXVlcnlTdHJpbmdBbmRIYXNoKHVuZGVmaW5lZCwgdXJsLnN1YnN0cmluZyhpbmRleE9mSCArIDEpKSxcbiAgICAgIH07XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGNvbnN0IHBhdGhuYW1lID0gdXJsLnN1YnN0cmluZygwLCBpbmRleE9mUSk7XG4gICAgY29uc3QgcmVzdCA9IHVybC5zdWJzdHJpbmcoaW5kZXhPZlEgKyAxKTtcbiAgICBjb25zdCBpbmRleE9mSCA9IHJlc3QuaW5kZXhPZignIycpO1xuICAgIGlmIChpbmRleE9mSCA9PT0gLTEpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHBhdGhuYW1lOiBwYXRobmFtZSxcbiAgICAgICAgcXVlcnk6IFF1ZXJ5UGFyYW1zLmZyb21RdWVyeVN0cmluZ0FuZEhhc2gocmVzdCksXG4gICAgICB9O1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBxID0gcmVzdC5zdWJzdHJpbmcoMCwgaW5kZXhPZkgpO1xuICAgICAgY29uc3QgaCA9IHJlc3Quc3Vic3RyaW5nKGluZGV4T2ZIICsgMSk7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBwYXRobmFtZTogcGF0aG5hbWUsXG4gICAgICAgIHF1ZXJ5OiBRdWVyeVBhcmFtcy5mcm9tUXVlcnlTdHJpbmdBbmRIYXNoKHEsIGgpLFxuICAgICAgfTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gbG9jYXRpb25Gcm9tTG9jKHVybDogc3RyaW5nLCBsb2M6IExvYyk6IExvY2F0aW9uIHtcbiAgcmV0dXJuIHtcbiAgICBhbmNlc3Rvck9yaWdpbnM6IChudWxsIGFzIHVua25vd24pIGFzIERPTVN0cmluZ0xpc3QsXG4gICAgYXNzaWduKHVybDogc3RyaW5nKTogdm9pZCB7fSxcbiAgICBoYXNoOiB1cmwuaW5jbHVkZXMoJyMnKSA/IHVybC5zcGxpdCgnIycpWzFdIDogJycsXG4gICAgaG9zdDogJycsXG4gICAgaG9zdG5hbWU6ICcnLFxuICAgIGhyZWY6ICcnLFxuICAgIG9yaWdpbjogJycsXG4gICAgcGF0aG5hbWU6IGxvYy5wYXRobmFtZSxcbiAgICBwb3J0OiAnJyxcbiAgICBwcm90b2NvbDogJycsXG4gICAgcmVsb2FkKCk6IHZvaWQge30sXG4gICAgcmVwbGFjZSh1cmw6IHN0cmluZyk6IHZvaWQge30sXG4gICAgc2VhcmNoOiAnJyxcbiAgfTtcbn1cblxuZnVuY3Rpb24gZXhwZWN0Um91dGUodXJsOiBzdHJpbmcsIHJvdXRlOiBNeVJvdXRlKSB7XG4gIHJldHVybiB0ZXN0KHVybCwgKCkgPT4ge1xuICAgIGNvbnN0IGxvYyA9IGxvY0Zyb21VcmwodXJsKTtcbiAgICBleHBlY3Qocm91dGVyLnBhcnNlKGxvYy5wYXRobmFtZSwgbG9jLnF1ZXJ5KSkudG9FcXVhbChqdXN0KHJvdXRlKSk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBleHBlY3ROb3RGb3VuZCh1cmw6IHN0cmluZykge1xuICByZXR1cm4gdGVzdCh1cmwgKyAnIChub3QgZm91bmQpJywgKCkgPT4ge1xuICAgIGNvbnN0IGxvYyA9IGxvY0Zyb21VcmwodXJsKTtcbiAgICBleHBlY3Qocm91dGVyLnBhcnNlKGxvYy5wYXRobmFtZSwgbG9jLnF1ZXJ5KSkudG9FcXVhbChub3RoaW5nKTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGV4cGVjdFNldHRpbmdSb3V0ZUhhc2godXJsOiBzdHJpbmcsIGhhc2g6IE1heWJlPHN0cmluZz4pIHtcbiAgcmV0dXJuIHRlc3QodXJsICsgJyAoaGFzaCknLCAoKSA9PiB7XG4gICAgY29uc3QgbG9jID0gbG9jRnJvbVVybCh1cmwpO1xuICAgIGNvbnN0IGxvY2F0aW9uOiBMb2NhdGlvbiA9IGxvY2F0aW9uRnJvbUxvYyh1cmwsIGxvYyk7XG4gICAgY29uc3Qgcm91dGU6IE1heWJlPE15Um91dGU+ID0gcm91dGVyLnBhcnNlTG9jYXRpb24obG9jYXRpb24pO1xuICAgIHJvdXRlXG4gICAgICAubWFwKChyKSA9PiB7XG4gICAgICAgIGlmIChyLnR5cGUgPT09ICdzZXR0aW5ncycpIHtcbiAgICAgICAgICByZXR1cm4gZXhwZWN0KHIuc2VjdGlvbikudG9FcXVhbChoYXNoKTtcbiAgICAgICAgfVxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCB0aGUgc2V0dGluZ3Mgcm91dGUhJyk7XG4gICAgICB9KVxuICAgICAgLndpdGhEZWZhdWx0U3VwcGx5KCgpID0+IHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIFJvdXRlIScpO1xuICAgICAgfSk7XG4gIH0pO1xufVxuIl19
/*
 * MIT License
 *
 * Copyright (c) 2019 RÃ©mi Van Keisbelck
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
import { Program } from './Program';
import { List, Task, Ok, just, maybeOf, nothing } from 'tea-cup-core';
import * as React from 'react';
import { Component, createRef } from 'react';
/**
 * Program that handles navigation (routing).
 */
export class ProgramWithNav extends Component {
    constructor(props) {
        super(props);
        this.ref = createRef();
        this.listener = nothing;
    }
    render() {
        return (React.createElement(Program, { init: () => this.props.init(window.location), view: this.props.view, update: this.props.update, subscriptions: this.props.subscriptions, devTools: this.props.devTools, ref: this.ref }));
    }
    componentDidMount() {
        const l = () => {
            if (this.ref.current) {
                this.ref.current.dispatch(this.props.onUrlChange(window.location));
            }
        };
        this.listener = just(l);
        window.addEventListener('popstate', l);
    }
    componentWillUnmount() {
        if (this.listener.type === 'Just') {
            window.removeEventListener('popstate', this.listener.value);
            this.listener = nothing;
        }
    }
}
/**
 * Return a Task that will eventually change the browser location via historty.pushState,
 * and send back a Msg into the Program
 * @param url the url to navigate to
 */
export function newUrl(url) {
    return new NewUrlTask(url);
}
class NewUrlTask extends Task {
    constructor(url) {
        super();
        this.url = url;
    }
    execute(callback) {
        const state = {};
        window.history.pushState(state, '', this.url);
        const popStateEvent = new PopStateEvent('popstate', { state: state });
        dispatchEvent(popStateEvent);
        callback(new Ok(document.location));
    }
}
// router
// ------
export class PathElem {
}
class ConstantPathElem extends PathElem {
    constructor(s) {
        super();
        this.s = s;
    }
    mapPart(part) {
        if (part === this.s) {
            return just(part);
        }
        else {
            return nothing;
        }
    }
}
class RegexPathElem extends PathElem {
    constructor(regex, converter) {
        super();
        this.regex = regex;
        this.converter = converter;
    }
    mapPart(part) {
        if (this.regex.test(part)) {
            return this.converter(part);
        }
        else {
            return nothing;
        }
    }
}
class IntPathElem extends RegexPathElem {
    constructor() {
        super(new RegExp('^\\d+$'), (s) => {
            try {
                const i = parseInt(s, 10);
                if (isNaN(i)) {
                    return nothing;
                }
                else {
                    return just(i);
                }
            }
            catch (e) {
                return nothing;
            }
        });
    }
}
IntPathElem.INSTANCE = new IntPathElem();
class StrPathElem extends PathElem {
    mapPart(part) {
        return just(part);
    }
}
export function str(s) {
    if (s === undefined) {
        return new StrPathElem();
    }
    else {
        return new ConstantPathElem(s);
    }
}
export function int() {
    return IntPathElem.INSTANCE;
}
export function regex(r, converter) {
    return new RegexPathElem(r, converter);
}
export class Path0 {
    map(f) {
        return new RouteDef([], f);
    }
}
export class QueryParams {
    constructor(store, hash) {
        this.store = store;
        this.hash = hash;
    }
    getValues(name) {
        return maybeOf(this.store[name]);
    }
    getValue(name) {
        const values = this.store[name];
        if (values === undefined) {
            return nothing;
        }
        else {
            return List.fromArray(values).head();
        }
    }
    getHash() {
        return this.hash;
    }
    static empty() {
        return new QueryParams({}, nothing);
    }
    static fromQueryStringAndHash(queryString, hash) {
        const params = queryString === undefined ? [] : queryString.split('&');
        const store = {};
        function addToStore(name, value) {
            let values = store[name];
            if (values === undefined) {
                values = [value];
                store[name] = values;
            }
            else {
                values.push(value);
            }
        }
        params.forEach((param) => {
            const parts = param.split('=');
            if (parts.length === 1) {
                addToStore(parts[0], '');
            }
            else if (parts.length > 1) {
                addToStore(parts[0], parts[1]);
            }
        });
        return new QueryParams(store, hash === '' ? nothing : maybeOf(hash).map((h) => (h.startsWith('#') ? h.substring(1) : h)));
    }
}
export class Path1 {
    constructor(e) {
        this.e = e;
    }
    map(f) {
        return new RouteDef([this.e], f);
    }
}
export class Path2 {
    constructor(e1, e2) {
        this.e1 = e1;
        this.e2 = e2;
    }
    map(f) {
        return new RouteDef([this.e1, this.e2], f);
    }
}
export class Path3 {
    constructor(e1, e2, e3) {
        this.e1 = e1;
        this.e2 = e2;
        this.e3 = e3;
    }
    map(f) {
        return new RouteDef([this.e1, this.e2, this.e3], f);
    }
}
export const route0 = new Path0();
export function route1(e) {
    return new Path1(e);
}
export function route2(e1, e2) {
    return new Path2(e1, e2);
}
export function route3(e1, e2, e3) {
    return new Path3(e1, e2, e3);
}
export class RouteDef {
    constructor(pathElems, f) {
        this.pathElems = pathElems;
        this.f = f;
    }
    static sanitizePath(path) {
        const p1 = path.startsWith('/') ? path.substring(1) : path;
        return p1.endsWith('/') ? p1.substring(0, p1.length - 1) : p1;
    }
    static splitPath(path) {
        const p = RouteDef.sanitizePath(path);
        return p === '' ? [] : p.split('/').map(decodeURIComponent);
    }
    checkRoute(pathname, query) {
        // extract path parts from location and split
        const parts = RouteDef.splitPath(pathname);
        if (parts.length === this.pathElems.length) {
            // map every individual part, bail out if
            // something cannot be converted
            const mappedParts = [];
            for (let i = 0; i < parts.length; i++) {
                const part = parts[i];
                const pe = this.pathElems[i];
                const mapped = pe.mapPart(part);
                switch (mapped.type) {
                    case 'Just':
                        mappedParts.push(mapped.value);
                        break;
                    case 'Nothing':
                        return nothing;
                }
            }
            // append query params to args
            mappedParts.push(query);
            // now we have mapped args, let's call the route's func
            return just(this.f.apply({}, mappedParts));
        }
        else {
            return nothing;
        }
    }
}
export class Router {
    constructor(...routeDefs) {
        this.routes = routeDefs;
    }
    parse(pathname, query) {
        // try all routes one after the other
        for (let i = 0; i < this.routes.length; i++) {
            const d = this.routes[i];
            const r = d.checkRoute(pathname, query);
            if (r.type === 'Just') {
                return r;
            }
        }
        return nothing;
    }
    parseLocation(location) {
        return this.parse(location.pathname, QueryParams.fromQueryStringAndHash(location.search, location.hash));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTmF2aWdhdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9UZWFDdXAvTmF2aWdhdGlvbi50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBdUJHO0FBRUgsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNwQyxPQUFPLEVBQUUsSUFBSSxFQUF3QixJQUFJLEVBQUUsRUFBRSxFQUFVLElBQUksRUFBUyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQzNHLE9BQU8sS0FBSyxLQUFLLE1BQU0sT0FBTyxDQUFDO0FBQy9CLE9BQU8sRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUF3QixNQUFNLE9BQU8sQ0FBQztBQWVuRTs7R0FFRztBQUNILE1BQU0sT0FBTyxjQUEyQixTQUFRLFNBQXNDO0lBSXBGLFlBQVksS0FBcUM7UUFDL0MsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBSEUsUUFBRyxHQUFtQyxTQUFTLEVBQUUsQ0FBQztRQUlqRSxJQUFJLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQztJQUMxQixDQUFDO0lBRUQsTUFBTTtRQUNKLE9BQU8sQ0FDTCxvQkFBQyxPQUFPLElBQ04sSUFBSSxFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsRUFDNUMsSUFBSSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUNyQixNQUFNLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQ3pCLGFBQWEsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsRUFDdkMsUUFBUSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUM3QixHQUFHLEVBQUUsSUFBSSxDQUFDLEdBQUcsR0FDYixDQUNILENBQUM7SUFDSixDQUFDO0lBRUQsaUJBQWlCO1FBQ2YsTUFBTSxD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QUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDNUMsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN6QixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsVUFBVSxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUN4QyxJQUFJLENBQUMsQ0FBQyxJQUFJLEtBQUssTUFBTSxFQUFFLENBQUM7Z0JBQ3RCLE9BQU8sQ0FBQyxDQUFDO1lBQ1gsQ0FBQztRQUNILENBQUM7UUFDRCxPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDO0lBRUQsYUFBYSxDQUFDLFFBQWtCO1FBQzlCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsUUFBUSxFQUFFLFdBQVcsQ0FBQyxzQkFBc0IsQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQzNHLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBNSVQgTGljZW5zZVxuICpcbiAqIENvcHlyaWdodCAoYykgMjAxOSBSw6ltaSBWYW4gS2Vpc2JlbGNrXG4gKlxuICogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weVxuICogb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgXCJTb2Z0d2FyZVwiKSwgdG8gZGVhbFxuICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0c1xuICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbFxuICogY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzXG4gKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOlxuICpcbiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluIGFsbFxuICogY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS5cbiAqXG4gKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXG4gKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcbiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxuICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUlxuICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSxcbiAqIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFXG4gKiBTT0ZUV0FSRS5cbiAqXG4gKi9cblxuaW1wb3J0IHsgUHJvZ3JhbSB9IGZyb20gJy4vUHJvZ3JhbSc7XG5pbXBvcnQgeyBMaXN0LCBDbWQsIERpc3BhdGNoZXIsIFN1YiwgVGFzaywgT2ssIFJlc3VsdCwganVzdCwgTWF5YmUsIG1heWJlT2YsIG5vdGhpbmcgfSBmcm9tICd0ZWEtY3VwLWNvcmUnO1xuaW1wb3J0ICogYXMgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IHsgQ29tcG9uZW50LCBjcmVhdGVSZWYsIFJlYWN0Tm9kZSwgUmVmT2JqZWN0IH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IHsgRGV2VG9vbHMgfSBmcm9tICcuL0RldlRvb2xzJztcblxuLyoqXG4gKiBQcm9wcyBmb3IgdGhlIFByb2dyYW1XaXRoTmF2LlxuICovXG5leHBvcnQgaW50ZXJmYWNlIE5hdlByb3BzPE1vZGVsLCBNc2c+IHtcbiAgcmVhZG9ubHkgb25VcmxDaGFuZ2U6IChsOiBMb2NhdGlvbikgPT4gTXNnO1xuICByZWFkb25seSBpbml0OiAobDogTG9jYXRpb24pID0+IFtNb2RlbCwgQ21kPE1zZz5dO1xuICByZWFkb25seSB2aWV3OiAoZGlzcGF0Y2g6IERpc3BhdGNoZXI8TXNnPiwgbTogTW9kZWwpID0+IFJlYWN0Tm9kZTtcbiAgcmVhZG9ubHkgdXBkYXRlOiAobXNnOiBNc2csIG1vZGVsOiBNb2RlbCkgPT4gW01vZGVsLCBDbWQ8TXNnPl07XG4gIHJlYWRvbmx5IHN1YnNjcmlwdGlvbnM6IChtb2RlbDogTW9kZWwpID0+IFN1YjxNc2c+O1xuICByZWFkb25seSBkZXZUb29scz86IERldlRvb2xzPE1vZGVsLCBNc2c+O1xufVxuXG4vKipcbiAqIFByb2dyYW0gdGhhdCBoYW5kbGVzIG5hdmlnYXRpb24gKHJvdXRpbmcpLlxuICovXG5leHBvcnQgY2xhc3MgUHJvZ3JhbVdpdGhOYXY8TW9kZWwsIE1zZz4gZXh0ZW5kcyBDb21wb25lbnQ8TmF2UHJvcHM8TW9kZWwsIE1zZz4sIG5ldmVyPiB7XG4gIHByaXZhdGUgbGlzdGVuZXI6IE1heWJlPEV2ZW50TGlzdGVuZXI+O1xuICBwcml2YXRlIHJlYWRvbmx5IHJlZjogUmVmT2JqZWN0PFByb2dyYW08TW9kZWwsIE1zZz4+ID0gY3JlYXRlUmVmKCk7XG5cbiAgY29uc3RydWN0b3IocHJvcHM6IFJlYWRvbmx5PE5hdlByb3BzPE1vZGVsLCBNc2c+Pikge1xuICAgIHN1cGVyKHByb3BzKTtcbiAgICB0aGlzLmxpc3RlbmVyID0gbm90aGluZztcbiAgfVxuXG4gIHJlbmRlcigpOiBSZWFjdC5SZWFjdE5vZGUge1xuICAgIHJldHVybiAoXG4gICAgICA8UHJvZ3JhbVxuICAgICAgICBpbml0PXsoKSA9PiB0aGlzLnByb3BzLmluaXQod2luZG93LmxvY2F0aW9uKX1cbiAgICAgICAgdmlldz17dGhpcy5wcm9wcy52aWV3fVxuICAgICAgICB1cGRhdGU9e3RoaXMucHJvcHMudXBkYXRlfVxuICAgICAgICBzdWJzY3JpcHRpb25zPXt0aGlzLnByb3BzLnN1YnNjcmlwdGlvbnN9XG4gICAgICAgIGRldlRvb2xzPXt0aGlzLnByb3BzLmRldlRvb2xzfVxuICAgICAgICByZWY9e3RoaXMucmVmfVxuICAgICAgLz5cbiAgICApO1xuICB9XG5cbiAgY29tcG9uZW50RGlkTW91bnQoKTogdm9pZCB7XG4gICAgY29uc3QgbCA9ICgpID0+IHtcbiAgICAgIGlmICh0aGlzLnJlZi5jdXJyZW50KSB7XG4gICAgICAgIHRoaXMucmVmLmN1cnJlbnQuZGlzcGF0Y2godGhpcy5wcm9wcy5vblVybENoYW5nZSh3aW5kb3cubG9jYXRpb24pKTtcbiAgICAgIH1cbiAgICB9O1xuICAgIHRoaXMubGlzdGVuZXIgPSBqdXN0KGwpO1xuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdwb3BzdGF0ZScsIGwpO1xuICB9XG5cbiAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgaWYgKHRoaXMubGlzdGVuZXIudHlwZSA9PT0gJ0p1c3QnKSB7XG4gICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigncG9wc3RhdGUnLCB0aGlzLmxpc3RlbmVyLnZhbHVlKTtcbiAgICAgIHRoaXMubGlzdGVuZXIgPSBub3RoaW5nO1xuICAgIH1cbiAgfVxufVxuXG4vKipcbiAqIFJldHVybiBhIFRhc2sgdGhhdCB3aWxsIGV2ZW50dWFsbHkgY2hhbmdlIHRoZSBicm93c2VyIGxvY2F0aW9uIHZpYSBoaXN0b3J0eS5wdXNoU3RhdGUsXG4gKiBhbmQgc2VuZCBiYWNrIGEgTXNnIGludG8gdGhlIFByb2dyYW1cbiAqIEBwYXJhbSB1cmwgdGhlIHVybCB0byBuYXZpZ2F0ZSB0b1xuICovXG5leHBvcnQgZnVuY3Rpb24gbmV3VXJsKHVybDogc3RyaW5nKTogVGFzazxuZXZlciwgTG9jYXRpb24+IHtcbiAgcmV0dXJuIG5ldyBOZXdVcmxUYXNrKHVybCk7XG59XG5cbmNsYXNzIE5ld1VybFRhc2sgZXh0ZW5kcyBUYXNrPG5ldmVyLCBMb2NhdGlvbj4ge1xuICByZWFkb25seSB1cmw6IHN0cmluZztcblxuICBjb25zdHJ1Y3Rvcih1cmw6IHN0cmluZykge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy51cmwgPSB1cmw7XG4gIH1cblxuICBleGVjdXRlKGNhbGxiYWNrOiAocjogUmVzdWx0PG5ldmVyLCBMb2NhdGlvbj4pID0+IHZvaWQpOiB2b2lkIHtcbiAgICBjb25zdCBzdGF0ZSA9IHt9O1xuICAgIHdpbmRvdy5oaXN0b3J5LnB1c2hTdGF0ZShzdGF0ZSwgJycsIHRoaXMudXJsKTtcbiAgICBjb25zdCBwb3BTdGF0ZUV2ZW50ID0gbmV3IFBvcFN0YXRlRXZlbnQoJ3BvcHN0YXRlJywgeyBzdGF0ZTogc3RhdGUgfSk7XG4gICAgZGlzcGF0Y2hFdmVudChwb3BTdGF0ZUV2ZW50KTtcbiAgICBjYWxsYmFjayhuZXcgT2soZG9jdW1lbnQubG9jYXRpb24pKTtcbiAgfVxufVxuXG4vLyByb3V0ZXJcbi8vIC0tLS0tLVxuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgUGF0aEVsZW08VD4ge1xuICBhYnN0cmFjdCBtYXBQYXJ0KHBhcnQ6IHN0cmluZyk6IE1heWJlPFQ+O1xufVxuXG5jbGFzcyBDb25zdGFudFBhdGhFbGVtIGV4dGVuZHMgUGF0aEVsZW08c3RyaW5nPiB7XG4gIHJlYWRvbmx5IHM6IHN0cmluZztcblxuICBjb25zdHJ1Y3RvcihzOiBzdHJpbmcpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMucyA9IHM7XG4gIH1cblxuICBtYXBQYXJ0KHBhcnQ6IHN0cmluZyk6IE1heWJlPHN0cmluZz4ge1xuICAgIGlmIChwYXJ0ID09PSB0aGlzLnMpIHtcbiAgICAgIHJldHVybiBqdXN0KHBhcnQpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gbm90aGluZztcbiAgICB9XG4gIH1cbn1cblxuY2xhc3MgUmVnZXhQYXRoRWxlbTxUPiBleHRlbmRzIFBhdGhFbGVtPFQ+IHtcbiAgcHJpdmF0ZSByZWFkb25seSByZWdleDogUmVnRXhwO1xuICBwcml2YXRlIHJlYWRvbmx5IGNvbnZlcnRlcjogKHM6IHN0cmluZykgPT4gTWF5YmU8VD47XG5cbiAgY29uc3RydWN0b3IocmVnZXg6IFJlZ0V4cCwgY29udmVydGVyOiAoczogc3RyaW5nKSA9PiBNYXliZTxUPikge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5yZWdleCA9IHJlZ2V4O1xuICAgIHRoaXMuY29udmVydGVyID0gY29udmVydGVyO1xuICB9XG5cbiAgbWFwUGFydChwYXJ0OiBzdHJpbmcpOiBNYXliZTxUPiB7XG4gICAgaWYgKHRoaXMucmVnZXgudGVzdChwYXJ0KSkge1xuICAgICAgcmV0dXJuIHRoaXMuY29udmVydGVyKHBhcnQpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gbm90aGluZztcbiAgICB9XG4gIH1cbn1cblxuY2xhc3MgSW50UGF0aEVsZW0gZXh0ZW5kcyBSZWdleFBhdGhFbGVtPG51bWJlcj4ge1xuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBzdXBlcihuZXcgUmVnRXhwKCdeXFxcXGQrJCcpLCAocykgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgaSA9IHBhcnNlSW50KHMsIDEwKTtcbiAgICAgICAgaWYgKGlzTmFOKGkpKSB7XG4gICAgICAgICAgcmV0dXJuIG5vdGhpbmc7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIGp1c3QoaSk7XG4gICAgICAgIH1cbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgcmV0dXJuIG5vdGhpbmc7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBzdGF0aWMgSU5TVEFOQ0U6IEludFBhdGhFbGVtID0gbmV3IEludFBhdGhFbGVtKCk7XG59XG5cbmNsYXNzIFN0clBhdGhFbGVtIGV4dGVuZHMgUGF0aEVsZW08c3RyaW5nPiB7XG4gIG1hcFBhcnQocGFydDogc3RyaW5nKTogTWF5YmU8c3RyaW5nPiB7XG4gICAgcmV0dXJuIGp1c3QocGFydCk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHN0cihzPzogc3RyaW5nKTogUGF0aEVsZW08c3RyaW5nPiB7XG4gIGlmIChzID09PSB1bmRlZmluZWQpIHtcbiAgICByZXR1cm4gbmV3IFN0clBhdGhFbGVtKCk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIG5ldyBDb25zdGFudFBhdGhFbGVtKHMpO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpbnQoKTogUGF0aEVsZW08bnVtYmVyPiB7XG4gIHJldHVybiBJbnRQYXRoRWxlbS5JTlNUQU5DRTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlZ2V4PFQ+KHI6IFJlZ0V4cCwgY29udmVydGVyOiAoczogc3RyaW5nKSA9PiBNYXliZTxUPik6IFBhdGhFbGVtPFQ+IHtcbiAgcmV0dXJuIG5ldyBSZWdleFBhdGhFbGVtKHIsIGNvbnZlcnRlcik7XG59XG5cbmV4cG9ydCBjbGFzcyBQYXRoMCB7XG4gIG1hcDxSPihmOiAocXVlcnk6IFF1ZXJ5UGFyYW1zKSA9PiBSKTogUm91dGVEZWY8Uj4ge1xuICAgIHJldHVybiBuZXcgUm91dGVEZWY8Uj4oW10sIGYpO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBRdWVyeVBhcmFtcyB7XG4gIHByaXZhdGUgcmVhZG9ubHkgc3RvcmU6IHsgW2lkOiBzdHJpbmddOiBzdHJpbmdbXSB9O1xuICBwcml2YXRlIHJlYWRvbmx5IGhhc2g6IE1heWJlPHN0cmluZz47XG5cbiAgcHJpdmF0ZSBjb25zdHJ1Y3RvcihzdG9yZTogeyBbaWQ6IHN0cmluZ106IHN0cmluZ1tdIH0sIGhhc2g6IE1heWJlPHN0cmluZz4pIHtcbiAgICB0aGlzLnN0b3JlID0gc3RvcmU7XG4gICAgdGhpcy5oYXNoID0gaGFzaDtcbiAgfVxuXG4gIGdldFZhbHVlcyhuYW1lOiBzdHJpbmcpOiBNYXliZTxSZWFkb25seUFycmF5PHN0cmluZz4+IHtcbiAgICByZXR1cm4gbWF5YmVPZih0aGlzLnN0b3JlW25hbWVdKTtcbiAgfVxuXG4gIGdldFZhbHVlKG5hbWU6IHN0cmluZyk6IE1heWJlPHN0cmluZz4ge1xuICAgIGNvbnN0IHZhbHVlcyA9IHRoaXMuc3RvcmVbbmFtZV07XG4gICAgaWYgKHZhbHVlcyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gbm90aGluZztcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIExpc3QuZnJvbUFycmF5KHZhbHVlcykuaGVhZCgpO1xuICAgIH1cbiAgfVxuXG4gIGdldEhhc2goKTogTWF5YmU8c3RyaW5nPiB7XG4gICAgcmV0dXJuIHRoaXMuaGFzaDtcbiAgfVxuXG4gIHN0YXRpYyBlbXB0eSgpOiBRdWVyeVBhcmFtcyB7XG4gICAgcmV0dXJuIG5ldyBRdWVyeVBhcmFtcyh7fSwgbm90aGluZyk7XG4gIH1cblxuICBzdGF0aWMgZnJvbVF1ZXJ5U3RyaW5nQW5kSGFzaChxdWVyeVN0cmluZz86IHN0cmluZywgaGFzaD86IHN0cmluZyk6IFF1ZXJ5UGFyYW1zIHtcbiAgICBjb25zdCBwYXJhbXMgPSBxdWVyeVN0cmluZyA9PT0gdW5kZWZpbmVkID8gW10gOiBxdWVyeVN0cmluZy5zcGxpdCgnJicpO1xuICAgIGNvbnN0IHN0b3JlOiB7IFtpZDogc3RyaW5nXTogc3RyaW5nW10gfSA9IHt9O1xuXG4gICAgZnVuY3Rpb24gYWRkVG9TdG9yZShuYW1lOiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcpIHtcbiAgICAgIGxldCB2YWx1ZXMgPSBzdG9yZVtuYW1lXTtcbiAgICAgIGlmICh2YWx1ZXMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICB2YWx1ZXMgPSBbdmFsdWVdO1xuICAgICAgICBzdG9yZVtuYW1lXSA9IHZhbHVlcztcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHZhbHVlcy5wdXNoKHZhbHVlKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBwYXJhbXMuZm9yRWFjaCgocGFyYW0pID0+IHtcbiAgICAgIGNvbnN0IHBhcnRzID0gcGFyYW0uc3BsaXQoJz0nKTtcbiAgICAgIGlmIChwYXJ0cy5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgYWRkVG9TdG9yZShwYXJ0c1swXSwgJycpO1xuICAgICAgfSBlbHNlIGlmIChwYXJ0cy5sZW5ndGggPiAxKSB7XG4gICAgICAgIGFkZFRvU3RvcmUocGFydHNbMF0sIHBhcnRzWzFdKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiBuZXcgUXVlcnlQYXJhbXMoXG4gICAgICBzdG9yZSxcbiAgICAgIGhhc2ggPT09ICcnID8gbm90aGluZyA6IG1heWJlT2YoaGFzaCkubWFwKChoKSA9PiAoaC5zdGFydHNXaXRoKCcjJykgPyBoLnN1YnN0cmluZygxKSA6IGgpKSxcbiAgICApO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBQYXRoMTxUPiB7XG4gIHJlYWRvbmx5IGU6IFBhdGhFbGVtPFQ+O1xuXG4gIGNvbnN0cnVjdG9yKGU6IFBhdGhFbGVtPFQ+KSB7XG4gICAgdGhpcy5lID0gZTtcbiAgfVxuXG4gIG1hcDxSPihmOiAodDogVCwgcXVlcnk6IFF1ZXJ5UGFyYW1zKSA9PiBSKTogUm91dGVEZWY8Uj4ge1xuICAgIHJldHVybiBuZXcgUm91dGVEZWY8Uj4oW3RoaXMuZV0sIGYpO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBQYXRoMjxUMSwgVDI+IHtcbiAgcmVhZG9ubHkgZTE6IFBhdGhFbGVtPFQxPjtcbiAgcmVhZG9ubHkgZTI6IFBhdGhFbGVtPFQyPjtcblxuICBjb25zdHJ1Y3RvcihlMTogUGF0aEVsZW08VDE+LCBlMjogUGF0aEVsZW08VDI+KSB7XG4gICAgdGhpcy5lMSA9IGUxO1xuICAgIHRoaXMuZTIgPSBlMjtcbiAgfVxuXG4gIG1hcDxSPihmOiAodDE6IFQxLCB0MjogVDIsIHF1ZXJ5OiBRdWVyeVBhcmFtcykgPT4gUik6IFJvdXRlRGVmPFI+IHtcbiAgICByZXR1cm4gbmV3IFJvdXRlRGVmPFI+KFt0aGlzLmUxLCB0aGlzLmUyXSwgZik7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFBhdGgzPFQxLCBUMiwgVDM+IHtcbiAgcmVhZG9ubHkgZTE6IFBhdGhFbGVtPFQxPjtcbiAgcmVhZG9ubHkgZTI6IFBhdGhFbGVtPFQyPjtcbiAgcmVhZG9ubHkgZTM6IFBhdGhFbGVtPFQzPjtcblxuICBjb25zdHJ1Y3RvcihlMTogUGF0aEVsZW08VDE+LCBlMjogUGF0aEVsZW08VDI+LCBlMzogUGF0aEVsZW08VDM+KSB7XG4gICAgdGhpcy5lMSA9IGUxO1xuICAgIHRoaXMuZTIgPSBlMjtcbiAgICB0aGlzLmUzID0gZTM7XG4gIH1cblxuICBtYXA8Uj4oZjogKHQxOiBUMSwgdDI6IFQyLCB0MzogVDMsIHF1ZXJ5OiBRdWVyeVBhcmFtcykgPT4gUik6IFJvdXRlRGVmPFI+IHtcbiAgICByZXR1cm4gbmV3IFJvdXRlRGVmPFI+KFt0aGlzLmUxLCB0aGlzLmUyLCB0aGlzLmUzXSwgZik7XG4gIH1cbn1cblxuZXhwb3J0IGNvbnN0IHJvdXRlMDogUGF0aDAgPSBuZXcgUGF0aDAoKTtcblxuZXhwb3J0IGZ1bmN0aW9uIHJvdXRlMTxFPihlOiBQYXRoRWxlbTxFPik6IFBhdGgxPEU+IHtcbiAgcmV0dXJuIG5ldyBQYXRoMTxFPihlKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJvdXRlMjxFMSwgRTIsIFI+KGUxOiBQYXRoRWxlbTxFMT4sIGUyOiBQYXRoRWxlbTxFMj4pOiBQYXRoMjxFMSwgRTI+IHtcbiAgcmV0dXJuIG5ldyBQYXRoMjxFMSwgRTI+KGUxLCBlMik7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByb3V0ZTM8RTEsIEUyLCBFMywgUj4oZTE6IFBhdGhFbGVtPEUxPiwgZTI6IFBhdGhFbGVtPEUyPiwgZTM6IFBhdGhFbGVtPEUzPik6IFBhdGgzPEUxLCBFMiwgRTM+IHtcbiAgcmV0dXJuIG5ldyBQYXRoMzxFMSwgRTIsIEUzPihlMSwgZTIsIGUzKTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBSb3V0ZUJhc2U8Uj4ge1xuICBjaGVja1JvdXRlKHBhdGhuYW1lOiBzdHJpbmcsIHF1ZXJ5OiBRdWVyeVBhcmFtcyk6IE1heWJlPFI+O1xufVxuXG5leHBvcnQgY2xhc3MgUm91dGVEZWY8Uj4gaW1wbGVtZW50cyBSb3V0ZUJhc2U8Uj4ge1xuICByZWFkb25seSBwYXRoRWxlbXM6IFJlYWRvbmx5QXJyYXk8UGF0aEVsZW08YW55Pj47XG4gIHJlYWRvbmx5IGY6IEZ1bmN0aW9uO1xuXG4gIGNvbnN0cnVjdG9yKHBhdGhFbGVtczogUmVhZG9ubHlBcnJheTxQYXRoRWxlbTxhbnk+PiwgZjogRnVuY3Rpb24pIHtcbiAgICB0aGlzLnBhdGhFbGVtcyA9IHBhdGhFbGVtcztcbiAgICB0aGlzLmYgPSBmO1xuICB9XG5cbiAgc3RhdGljIHNhbml0aXplUGF0aChwYXRoOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGNvbnN0IHAxID0gcGF0aC5zdGFydHNXaXRoKCcvJykgPyBwYXRoLnN1YnN0cmluZygxKSA6IHBhdGg7XG4gICAgcmV0dXJuIHAxLmVuZHNXaXRoKCcvJykgPyBwMS5zdWJzdHJpbmcoMCwgcDEubGVuZ3RoIC0gMSkgOiBwMTtcbiAgfVxuXG4gIHN0YXRpYyBzcGxpdFBhdGgocGF0aDogc3RyaW5nKTogUmVhZG9ubHlBcnJheTxzdHJpbmc+IHtcbiAgICBjb25zdCBwID0gUm91dGVEZWYuc2FuaXRpemVQYXRoKHBhdGgpO1xuICAgIHJldHVybiBwID09PSAnJyA/IFtdIDogcC5zcGxpdCgnLycpLm1hcChkZWNvZGVVUklDb21wb25lbnQpO1xuICB9XG5cbiAgY2hlY2tSb3V0ZShwYXRobmFtZTogc3RyaW5nLCBxdWVyeTogUXVlcnlQYXJhbXMpOiBNYXliZTxSPiB7XG4gICAgLy8gZXh0cmFjdCBwYXRoIHBhcnRzIGZyb20gbG9jYXRpb24gYW5kIHNwbGl0XG4gICAgY29uc3QgcGFydHMgPSBSb3V0ZURlZi5zcGxpdFBhdGgocGF0aG5hbWUpO1xuICAgIGlmIChwYXJ0cy5sZW5ndGggPT09IHRoaXMucGF0aEVsZW1zLmxlbmd0aCkge1xuICAgICAgLy8gbWFwIGV2ZXJ5IGluZGl2aWR1YWwgcGFydCwgYmFpbCBvdXQgaWZcbiAgICAgIC8vIHNvbWV0aGluZyBjYW5ub3QgYmUgY29udmVydGVkXG4gICAgICBjb25zdCBtYXBwZWRQYXJ0cyA9IFtdO1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25zdCBwYXJ0ID0gcGFydHNbaV07XG4gICAgICAgIGNvbnN0IHBlID0gdGhpcy5wYXRoRWxlbXNbaV07XG4gICAgICAgIGNvbnN0IG1hcHBlZCA9IHBlLm1hcFBhcnQocGFydCk7XG4gICAgICAgIHN3aXRjaCAobWFwcGVkLnR5cGUpIHtcbiAgICAgICAgICBjYXNlICdKdXN0JzpcbiAgICAgICAgICAgIG1hcHBlZFBhcnRzLnB1c2gobWFwcGVkLnZhbHVlKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgJ05vdGhpbmcnOlxuICAgICAgICAgICAgcmV0dXJuIG5vdGhpbmc7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgLy8gYXBwZW5kIHF1ZXJ5IHBhcmFtcyB0byBhcmdzXG4gICAgICBtYXBwZWRQYXJ0cy5wdXNoKHF1ZXJ5KTtcblxuICAgICAgLy8gbm93IHdlIGhhdmUgbWFwcGVkIGFyZ3MsIGxldCdzIGNhbGwgdGhlIHJvdXRlJ3MgZnVuY1xuICAgICAgcmV0dXJuIGp1c3QodGhpcy5mLmFwcGx5KHt9LCBtYXBwZWRQYXJ0cykpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gbm90aGluZztcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFJvdXRlcjxSPiB7XG4gIHJlYWRvbmx5IHJvdXRlczogUmVhZG9ubHlBcnJheTxSb3V0ZUJhc2U8Uj4+O1xuXG4gIGNvbnN0cnVjdG9yKC4uLnJvdXRlRGVmczogUm91dGVCYXNlPFI+W10pIHtcbiAgICB0aGlzLnJvdXRlcyA9IHJvdXRlRGVmcztcbiAgfVxuXG4gIHBhcnNlKHBhdGhuYW1lOiBzdHJpbmcsIHF1ZXJ5OiBRdWVyeVBhcmFtcyk6IE1heWJlPFI+IHtcbiAgICAvLyB0cnkgYWxsIHJvdXRlcyBvbmUgYWZ0ZXIgdGhlIG90aGVyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnJvdXRlcy5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgZCA9IHRoaXMucm91dGVzW2ldO1xuICAgICAgY29uc3QgciA9IGQuY2hlY2tSb3V0ZShwYXRobmFtZSwgcXVlcnkpO1xuICAgICAgaWYgKHIudHlwZSA9PT0gJ0p1c3QnKSB7XG4gICAgICAgIHJldHVybiByO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbm90aGluZztcbiAgfVxuXG4gIHBhcnNlTG9jYXRpb24obG9jYXRpb246IExvY2F0aW9uKTogTWF5YmU8Uj4ge1xuICAgIHJldHVybiB0aGlzLnBhcnNlKGxvY2F0aW9uLnBhdGhuYW1lLCBRdWVyeVBhcmFtcy5mcm9tUXVlcnlTdHJpbmdBbmRIYXNoKGxvY2F0aW9uLnNlYXJjaCwgbG9jYXRpb24uaGFzaCkpO1xuICB9XG59XG4iXX0=
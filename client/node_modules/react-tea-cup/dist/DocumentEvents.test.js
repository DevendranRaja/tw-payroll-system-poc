/*
 * MIT License
 *
 * Copyright (c) 2019 RÃ©mi Van Keisbelck
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
import { JSDOM } from 'jsdom';
import { DocumentEvents } from './DocumentEvents';
import { describe, expect, it, beforeEach, vi } from "vitest";
const dom = new JSDOM();
global.document = dom.window.document;
describe('DocumentEvents Test', () => {
    let documentEvents = new DocumentEvents();
    const addSpy = vi.fn();
    const removeSpy = vi.fn();
    document.addEventListener = addSpy;
    document.removeEventListener = removeSpy;
    beforeEach(() => {
        documentEvents = new DocumentEvents();
        addSpy.mockReset();
        removeSpy.mockReset();
    });
    it('first sub adds listener', () => {
        const sub = documentEvents.on('click', (e) => 'clicked');
        sub.init(() => ({}));
        expect(addSpy.mock.calls.length).toBe(1);
    });
    it('second sub adds another listener', () => {
        const sub = documentEvents.on('click', (e) => 'clicked');
        sub.init(() => ({}));
        expect(addSpy.mock.calls.length).toBe(1);
        const sub2 = documentEvents.on('click', (e) => 'clicked2', true);
        sub2.init(() => ({}));
        expect(addSpy.mock.calls.length).toBe(2);
    });
    it('all subs remove listeners', () => {
        const sub = documentEvents.on('click', (e) => 'clicked');
        sub.init(() => ({}));
        const sub2 = documentEvents.on('click', (e) => 'clicked2', { capture: true });
        sub2.init(() => ({}));
        sub.release();
        expect(removeSpy.mock.calls.length).toBe(1);
        sub2.release();
        expect(removeSpy.mock.calls.length).toBe(2);
    });
    it('sub receives event from listener', () => new Promise(done => {
        const msgs = [];
        const collectMsgs = (msg) => {
            msgs.push(msg);
        };
        const sub = documentEvents.on('click', (e) => 'clicked1');
        sub.init(collectMsgs);
        expect(addSpy.mock.calls.length).toBe(1);
        const listener = addSpy.mock.calls[0][1];
        listener({ event: 'event' });
        setTimeout(() => {
            expect(msgs).toEqual(['clicked1']);
            done();
        }, 10);
    }));
    it('each sub receive events its listener', () => new Promise(done => {
        const msgs = [];
        const collectMsgs = (msg) => {
            msgs.push(msg);
        };
        const msgs2 = [];
        const collectMsgs2 = (msg) => {
            msgs2.push(msg);
        };
        const sub = documentEvents.on('click', (e) => 'clicked');
        const sub2 = documentEvents.on('click', (e) => 'clicked2');
        sub.init(collectMsgs);
        sub2.init(collectMsgs2);
        expect(addSpy.mock.calls.length).toBe(2);
        const listener = addSpy.mock.calls[0][1];
        const listener2 = addSpy.mock.calls[1][1];
        listener({ event: 'event' });
        setTimeout(() => {
            expect(msgs).toEqual(['clicked']);
            listener2({ event: 'event' });
            setTimeout(() => {
                expect(msgs2).toEqual(['clicked2']);
                done();
            }, 10);
        }, 10);
    }));
    it('sub stops receiving events from listener', () => new Promise(done => {
        const sub = documentEvents.on('click', (e) => 'clicked1');
        const msgs = [];
        sub.init((msg) => {
            msgs.push(msg);
        });
        expect(addSpy.mock.calls.length).toBe(1);
        const listener = addSpy.mock.calls[0][1];
        listener({ event: 'event' });
        listener({ event: 'event' });
        setTimeout(() => {
            expect(msgs).toEqual(['clicked1', 'clicked1']);
            sub.release();
            listener({ event: 'event' });
            setTimeout(() => {
                expect(msgs).toEqual(['clicked1', 'clicked1']);
                done();
            });
        }, 10);
    }));
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRG9jdW1lbnRFdmVudHMudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9UZWFDdXAvRG9jdW1lbnRFdmVudHMudGVzdC50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBdUJHO0FBRUgsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLE9BQU8sQ0FBQztBQUM5QixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDbEQsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsRUFBRSxFQUFFLFVBQVUsRUFBRSxFQUFFLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFFOUQsTUFBTSxHQUFHLEdBQUcsSUFBSSxLQUFLLEVBQUUsQ0FBQztBQUN4QixNQUFNLENBQUMsUUFBUSxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDO0FBRXRDLFFBQVEsQ0FBQyxxQkFBcUIsRUFBRSxHQUFHLEVBQUU7SUFDbkMsSUFBSSxjQUFjLEdBQUcsSUFBSSxjQUFjLEVBQUUsQ0FBQztJQUUxQyxNQUFNLE1BQU0sR0FBRyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7SUFDdkIsTUFBTSxTQUFTLEdBQUcsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO0lBRTFCLFFBQVEsQ0FBQyxnQkFBZ0IsR0FBRyxNQUFNLENBQUM7SUFDbkMsUUFBUSxDQUFDLG1CQUFtQixHQUFHLFNBQVMsQ0FBQztJQUV6QyxVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsY0FBYyxHQUFHLElBQUksY0FBYyxFQUFFLENBQUM7UUFDdEMsTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ25CLFNBQVMsQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUN4QixDQUFDLENBQUMsQ0FBQztJQUVILEVBQUUsQ0FBQyx5QkFBeUIsRUFBRSxHQUFHLEVBQUU7UUFDakMsTUFBTSxHQUFHLEdBQUcsY0FBYyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3pELEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBRXJCLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDM0MsQ0FBQyxDQUFDLENBQUM7SUFFSCxFQUFFLENBQUMsa0NBQWtDLEVBQUUsR0FBRyxFQUFFO1FBQzFDLE1BQU0sR0FBRyxHQUFHLGNBQWMsQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUN6RCxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUVyQixNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRXpDLE1BQU0sSUFBSSxHQUFHLGNBQWMsQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDakUsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFFdEIsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUMzQyxDQUFDLENBQUMsQ0FBQztJQUVILEVBQUUsQ0FBQywyQkFBMkIsRUFBRSxHQUFHLEVBQUU7UUFDbkMsTUFBTSxHQUFHLEdBQUcsY0FBYyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3pELEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBRXJCLE1BQU0sSUFBSSxHQUFHLGNBQWMsQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxVQUFVLEVBQUUsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUM5RSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUV0QixHQUFHLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDZCxNQUFNLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRTVDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUNmLE1BQU0sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDOUMsQ0FBQyxDQUFDLENBQUM7SUFFSCxFQUFFLENBQUMsa0NBQWtDLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxPQUFPLENBQU8sSUFBSSxDQUFDLEVBQUU7UUFDcEUsTUFBTSxJQUFJLEdBQWEsRUFBRSxDQUFDO1FBQzFCLE1BQU0sV0FBVyxHQUFHLENBQUMsR0FBVyxFQUFRLEVBQUU7WUFDeEMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNqQixDQUFDLENBQUM7UUFFRixNQUFNLEdBQUcsR0FBRyxjQUFjLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDMUQsR0FBRyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUV0QixNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3pDLE1BQU0sUUFBUSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRXpDLFFBQVEsQ0FBQyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsQ0FBQyxDQUFDO1FBQzdCLFVBQVUsQ0FBQyxHQUFHLEVBQUU7WUFDZCxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztZQUNuQyxJQUFJLEVBQUUsQ0FBQztRQUNULENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNULENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFSixFQUFFLENBQUMsc0NBQXNDLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxPQUFPLENBQU8sSUFBSSxDQUFDLEVBQUU7UUFDeEUsTUFBTSxJQUFJLEdBQWEsRUFBRSxDQUFDO1FBQzFCLE1BQU0sV0FBVyxHQUFHLENBQUMsR0FBVyxFQUFRLEVBQUU7WUFDeEMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNqQixDQUFDLENBQUM7UUFDRixNQUFNLEtBQUssR0FBYSxFQUFFLENBQUM7UUFDM0IsTUFBTSxZQUFZLEdBQUcsQ0FBQyxHQUFXLEVBQVEsRUFBRTtZQUN6QyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2xCLENBQUMsQ0FBQztRQUVGLE1BQU0sR0FBRyxHQUFHLGNBQWMsQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUN6RCxNQUFNLElBQUksR0FBRyxjQUFjLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsVUFBVSxDQUFDLENBQUM7UUFFM0QsR0FBRyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUN0QixJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBRXhCLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDekMsTUFBTSxRQUFRLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDekMsTUFBTSxTQUFTLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFMUMsUUFBUSxDQUFDLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUM7UUFDN0IsVUFBVSxDQUFDLEdBQUcsRUFBRTtZQUNkLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQ2xDLFNBQVMsQ0FBQyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsQ0FBQyxDQUFDO1lBQzlCLFVBQVUsQ0FBQyxHQUFHLEVBQUU7Z0JBQ2QsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7Z0JBQ3BDLElBQUksRUFBRSxDQUFDO1lBQ1QsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFBO1FBQ1IsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFBO0lBQ1IsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUVKLEVBQUUsQ0FBQywwQ0FBMEMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxJQUFJLE9BQU8sQ0FBTyxJQUFJLENBQUMsRUFBRTtRQUM1RSxNQUFNLEdBQUcsR0FBRyxjQUFjLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsVUFBVSxDQUFDLENBQUM7UUFFMUQsTUFBTSxJQUFJLEdBQWEsRUFBRSxDQUFDO1FBQzFCLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTtZQUNmLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDakIsQ0FBQyxDQUFDLENBQUM7UUFFSCxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3pDLE1BQU0sUUFBUSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRXpDLFFBQVEsQ0FBQyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsQ0FBQyxDQUFDO1FBQzdCLFFBQVEsQ0FBQyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsQ0FBQyxDQUFDO1FBQzdCLFVBQVUsQ0FBQyxHQUFHLEVBQUU7WUFDZCxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsVUFBVSxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUM7WUFFL0MsR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ2QsUUFBUSxDQUFDLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUM7WUFDN0IsVUFBVSxDQUFDLEdBQUcsRUFBRTtnQkFDZCxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsVUFBVSxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUM7Z0JBQy9DLElBQUksRUFBRSxDQUFDO1lBQ1QsQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUE7SUFDUixDQUFDLENBQUMsQ0FBQyxDQUFDO0FBRU4sQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTUlUIExpY2Vuc2VcbiAqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTkgUsOpbWkgVmFuIEtlaXNiZWxja1xuICpcbiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlIFwiU29mdHdhcmVcIiksIHRvIGRlYWxcbiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHNcbiAqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGxcbiAqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpc1xuICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczpcbiAqXG4gKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbiBhbGxcbiAqIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuXG4gKlxuICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuICogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksXG4gKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbiAqIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXG4gKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRVxuICogU09GVFdBUkUuXG4gKlxuICovXG5cbmltcG9ydCB7IEpTRE9NIH0gZnJvbSAnanNkb20nO1xuaW1wb3J0IHsgRG9jdW1lbnRFdmVudHMgfSBmcm9tICcuL0RvY3VtZW50RXZlbnRzJztcbmltcG9ydCB7IGRlc2NyaWJlLCBleHBlY3QsIGl0LCBiZWZvcmVFYWNoLCB2aSB9IGZyb20gXCJ2aXRlc3RcIjtcblxuY29uc3QgZG9tID0gbmV3IEpTRE9NKCk7XG5nbG9iYWwuZG9jdW1lbnQgPSBkb20ud2luZG93LmRvY3VtZW50O1xuXG5kZXNjcmliZSgnRG9jdW1lbnRFdmVudHMgVGVzdCcsICgpID0+IHtcbiAgbGV0IGRvY3VtZW50RXZlbnRzID0gbmV3IERvY3VtZW50RXZlbnRzKCk7XG5cbiAgY29uc3QgYWRkU3B5ID0gdmkuZm4oKTtcbiAgY29uc3QgcmVtb3ZlU3B5ID0gdmkuZm4oKTtcblxuICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyID0gYWRkU3B5O1xuICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyID0gcmVtb3ZlU3B5O1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIGRvY3VtZW50RXZlbnRzID0gbmV3IERvY3VtZW50RXZlbnRzKCk7XG4gICAgYWRkU3B5Lm1vY2tSZXNldCgpO1xuICAgIHJlbW92ZVNweS5tb2NrUmVzZXQoKTtcbiAgfSk7XG5cbiAgaXQoJ2ZpcnN0IHN1YiBhZGRzIGxpc3RlbmVyJywgKCkgPT4ge1xuICAgIGNvbnN0IHN1YiA9IGRvY3VtZW50RXZlbnRzLm9uKCdjbGljaycsIChlKSA9PiAnY2xpY2tlZCcpO1xuICAgIHN1Yi5pbml0KCgpID0+ICh7fSkpO1xuXG4gICAgZXhwZWN0KGFkZFNweS5tb2NrLmNhbGxzLmxlbmd0aCkudG9CZSgxKTtcbiAgfSk7XG5cbiAgaXQoJ3NlY29uZCBzdWIgYWRkcyBhbm90aGVyIGxpc3RlbmVyJywgKCkgPT4ge1xuICAgIGNvbnN0IHN1YiA9IGRvY3VtZW50RXZlbnRzLm9uKCdjbGljaycsIChlKSA9PiAnY2xpY2tlZCcpO1xuICAgIHN1Yi5pbml0KCgpID0+ICh7fSkpO1xuXG4gICAgZXhwZWN0KGFkZFNweS5tb2NrLmNhbGxzLmxlbmd0aCkudG9CZSgxKTtcblxuICAgIGNvbnN0IHN1YjIgPSBkb2N1bWVudEV2ZW50cy5vbignY2xpY2snLCAoZSkgPT4gJ2NsaWNrZWQyJywgdHJ1ZSk7XG4gICAgc3ViMi5pbml0KCgpID0+ICh7fSkpO1xuXG4gICAgZXhwZWN0KGFkZFNweS5tb2NrLmNhbGxzLmxlbmd0aCkudG9CZSgyKTtcbiAgfSk7XG5cbiAgaXQoJ2FsbCBzdWJzIHJlbW92ZSBsaXN0ZW5lcnMnLCAoKSA9PiB7XG4gICAgY29uc3Qgc3ViID0gZG9jdW1lbnRFdmVudHMub24oJ2NsaWNrJywgKGUpID0+ICdjbGlja2VkJyk7XG4gICAgc3ViLmluaXQoKCkgPT4gKHt9KSk7XG5cbiAgICBjb25zdCBzdWIyID0gZG9jdW1lbnRFdmVudHMub24oJ2NsaWNrJywgKGUpID0+ICdjbGlja2VkMicsIHsgY2FwdHVyZTogdHJ1ZSB9KTtcbiAgICBzdWIyLmluaXQoKCkgPT4gKHt9KSk7XG5cbiAgICBzdWIucmVsZWFzZSgpO1xuICAgIGV4cGVjdChyZW1vdmVTcHkubW9jay5jYWxscy5sZW5ndGgpLnRvQmUoMSk7XG5cbiAgICBzdWIyLnJlbGVhc2UoKTtcbiAgICBleHBlY3QocmVtb3ZlU3B5Lm1vY2suY2FsbHMubGVuZ3RoKS50b0JlKDIpO1xuICB9KTtcblxuICBpdCgnc3ViIHJlY2VpdmVzIGV2ZW50IGZyb20gbGlzdGVuZXInLCAoKSA9PiBuZXcgUHJvbWlzZTx2b2lkPihkb25lID0+IHtcbiAgICBjb25zdCBtc2dzOiBzdHJpbmdbXSA9IFtdO1xuICAgIGNvbnN0IGNvbGxlY3RNc2dzID0gKG1zZzogc3RyaW5nKTogdm9pZCA9PiB7XG4gICAgICBtc2dzLnB1c2gobXNnKTtcbiAgICB9O1xuXG4gICAgY29uc3Qgc3ViID0gZG9jdW1lbnRFdmVudHMub24oJ2NsaWNrJywgKGUpID0+ICdjbGlja2VkMScpO1xuICAgIHN1Yi5pbml0KGNvbGxlY3RNc2dzKTtcblxuICAgIGV4cGVjdChhZGRTcHkubW9jay5jYWxscy5sZW5ndGgpLnRvQmUoMSk7XG4gICAgY29uc3QgbGlzdGVuZXIgPSBhZGRTcHkubW9jay5jYWxsc1swXVsxXTtcblxuICAgIGxpc3RlbmVyKHsgZXZlbnQ6ICdldmVudCcgfSk7XG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICBleHBlY3QobXNncykudG9FcXVhbChbJ2NsaWNrZWQxJ10pO1xuICAgICAgZG9uZSgpO1xuICAgIH0sIDEwKTtcbiAgfSkpO1xuXG4gIGl0KCdlYWNoIHN1YiByZWNlaXZlIGV2ZW50cyBpdHMgbGlzdGVuZXInLCAoKSA9PiBuZXcgUHJvbWlzZTx2b2lkPihkb25lID0+IHtcbiAgICBjb25zdCBtc2dzOiBzdHJpbmdbXSA9IFtdO1xuICAgIGNvbnN0IGNvbGxlY3RNc2dzID0gKG1zZzogc3RyaW5nKTogdm9pZCA9PiB7XG4gICAgICBtc2dzLnB1c2gobXNnKTtcbiAgICB9O1xuICAgIGNvbnN0IG1zZ3MyOiBzdHJpbmdbXSA9IFtdO1xuICAgIGNvbnN0IGNvbGxlY3RNc2dzMiA9IChtc2c6IHN0cmluZyk6IHZvaWQgPT4ge1xuICAgICAgbXNnczIucHVzaChtc2cpO1xuICAgIH07XG5cbiAgICBjb25zdCBzdWIgPSBkb2N1bWVudEV2ZW50cy5vbignY2xpY2snLCAoZSkgPT4gJ2NsaWNrZWQnKTtcbiAgICBjb25zdCBzdWIyID0gZG9jdW1lbnRFdmVudHMub24oJ2NsaWNrJywgKGUpID0+ICdjbGlja2VkMicpO1xuXG4gICAgc3ViLmluaXQoY29sbGVjdE1zZ3MpO1xuICAgIHN1YjIuaW5pdChjb2xsZWN0TXNnczIpO1xuXG4gICAgZXhwZWN0KGFkZFNweS5tb2NrLmNhbGxzLmxlbmd0aCkudG9CZSgyKTtcbiAgICBjb25zdCBsaXN0ZW5lciA9IGFkZFNweS5tb2NrLmNhbGxzWzBdWzFdO1xuICAgIGNvbnN0IGxpc3RlbmVyMiA9IGFkZFNweS5tb2NrLmNhbGxzWzFdWzFdO1xuXG4gICAgbGlzdGVuZXIoeyBldmVudDogJ2V2ZW50JyB9KTtcbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIGV4cGVjdChtc2dzKS50b0VxdWFsKFsnY2xpY2tlZCddKTtcbiAgICAgIGxpc3RlbmVyMih7IGV2ZW50OiAnZXZlbnQnIH0pO1xuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIGV4cGVjdChtc2dzMikudG9FcXVhbChbJ2NsaWNrZWQyJ10pO1xuICAgICAgICBkb25lKCk7XG4gICAgICB9LCAxMClcbiAgICB9LCAxMClcbiAgfSkpO1xuXG4gIGl0KCdzdWIgc3RvcHMgcmVjZWl2aW5nIGV2ZW50cyBmcm9tIGxpc3RlbmVyJywgKCkgPT4gbmV3IFByb21pc2U8dm9pZD4oZG9uZSA9PiB7XG4gICAgY29uc3Qgc3ViID0gZG9jdW1lbnRFdmVudHMub24oJ2NsaWNrJywgKGUpID0+ICdjbGlja2VkMScpO1xuXG4gICAgY29uc3QgbXNnczogc3RyaW5nW10gPSBbXTtcbiAgICBzdWIuaW5pdCgobXNnKSA9PiB7XG4gICAgICBtc2dzLnB1c2gobXNnKTtcbiAgICB9KTtcblxuICAgIGV4cGVjdChhZGRTcHkubW9jay5jYWxscy5sZW5ndGgpLnRvQmUoMSk7XG4gICAgY29uc3QgbGlzdGVuZXIgPSBhZGRTcHkubW9jay5jYWxsc1swXVsxXTtcblxuICAgIGxpc3RlbmVyKHsgZXZlbnQ6ICdldmVudCcgfSk7XG4gICAgbGlzdGVuZXIoeyBldmVudDogJ2V2ZW50JyB9KTtcbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIGV4cGVjdChtc2dzKS50b0VxdWFsKFsnY2xpY2tlZDEnLCAnY2xpY2tlZDEnXSk7XG5cbiAgICAgIHN1Yi5yZWxlYXNlKCk7XG4gICAgICBsaXN0ZW5lcih7IGV2ZW50OiAnZXZlbnQnIH0pO1xuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIGV4cGVjdChtc2dzKS50b0VxdWFsKFsnY2xpY2tlZDEnLCAnY2xpY2tlZDEnXSk7XG4gICAgICAgIGRvbmUoKTtcbiAgICAgIH0pO1xuICAgIH0sIDEwKVxuICB9KSk7XG5cbn0pO1xuIl19
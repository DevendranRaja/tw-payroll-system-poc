/*
 * MIT License
 *
 * Copyright (c) 2019 RÃ©mi Van Keisbelck
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
import { noCmd, ObjectSerializer } from 'tea-cup-core';
const snapshotKey = 'teaCupSnapshot';
export class DevTools {
    constructor(objectSerializer) {
        this.events = [];
        this.pausedOnEvent = -1;
        this.listeners = [];
        this.maxEvents = -1;
        this.objectSerializer = objectSerializer;
    }
    static init(window, objectSerializer) {
        const dt = new DevTools(objectSerializer || ObjectSerializer.withTeaCupClasses());
        // @ts-ignore
        window['teaCupDevTools'] = dt;
        return dt;
    }
    isPaused() {
        return this.pausedOnEvent !== -1;
    }
    connected(program) {
        this.program = program;
    }
    onEvent(e) {
        this.events.push(e);
        this.removeEventsIfNeeded();
        this.listeners.forEach((l) => l(e));
    }
    travelTo(evtNum) {
        if (this.program) {
            const evt = this.events[evtNum];
            if (evt) {
                const model = this.getEventModel(evt);
                this.pausedOnEvent = evtNum;
                this.program.setModel(model, false);
            }
        }
    }
    getEventModel(e) {
        switch (e.tag) {
            case 'init':
                return e.model;
            case 'updated':
                return e.modelAfter;
        }
    }
    resume() {
        if (this.program) {
            if (this.events.length > 0) {
                const lastEvent = this.events[this.events.length - 1];
                if (lastEvent) {
                    const model = this.getEventModel(lastEvent);
                    this.pausedOnEvent = -1;
                    this.program.setModel(model, true);
                }
            }
        }
    }
    forward() {
        if (this.pausedOnEvent >= 0 && this.pausedOnEvent < this.events.length - 1) {
            this.travelTo(this.pausedOnEvent + 1);
        }
    }
    backward() {
        if (this.pausedOnEvent >= 1) {
            this.travelTo(this.pausedOnEvent - 1);
        }
    }
    addListener(l) {
        this.listeners.push(l);
    }
    removeListener(l) {
        this.listeners = this.listeners.filter((x) => x !== l);
    }
    lastEvent() {
        return this.events[this.events.length - 1];
    }
    lastModel() {
        const e = this.lastEvent();
        switch (e.tag) {
            case 'init': {
                return e.model;
            }
            case 'updated': {
                return e.modelAfter;
            }
        }
    }
    snapshot() {
        localStorage.setItem(snapshotKey, this.objectSerializer.serialize(this.lastModel()));
        console.log('********************************************************************\n' +
            '*** The current application state has been saved to local storage.\n' +
            '*** The application will now load with this initial state.\n' +
            "*** Call 'teaCupDevTools.clearSnapshot()' to restore normal loading.\n" +
            '********************************************************************');
    }
    initFromSnapshot() {
        const json = localStorage.getItem(snapshotKey);
        if (json) {
            try {
                // @ts-ignore
                const model = this.objectSerializer.deserialize(json);
                console.log('**********************************************************************************************\n' +
                    "*** The application has initialized from a state saved by calling 'teaCupDevTools.snapshot()'.\n" +
                    "*** Call 'teaCupDevTools.clearSnapshot()' if you want to restore normal loading.\n" +
                    '**********************************************************************************************');
                return noCmd(model);
            }
            catch (e) {
                console.log('*** Error restoring state from local storage: ', e);
            }
        }
    }
    clearSnapshot() {
        localStorage.removeItem(snapshotKey);
        console.log('***********************************************************************\n' +
            '*** Application state cleared, the application will now start normally.\n' +
            '***********************************************************************');
    }
    clear() {
        if (this.isPaused()) {
            this.resume();
        }
        this.events = [];
        console.log('All events cleared');
    }
    setMaxEvents(maxEvents) {
        this.maxEvents = maxEvents;
        this.removeEventsIfNeeded();
        return this;
    }
    removeEventsIfNeeded() {
        if (this.maxEvents > 0) {
            const delta = this.events.length - this.maxEvents;
            if (delta > 0) {
                const newEvents = this.events.slice(delta, this.events.length);
                this.events = newEvents;
            }
        }
        return this;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRGV2VG9vbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvVGVhQ3VwL0RldlRvb2xzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQXVCRztBQUVILE9BQU8sRUFBTyxLQUFLLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxjQUFjLENBQUM7QUEyQjVELE1BQU0sV0FBVyxHQUFHLGdCQUFnQixDQUFDO0FBSXJDLE1BQU0sT0FBTyxRQUFRO0lBUW5CLFlBQVksZ0JBQWtDO1FBTnRDLFdBQU0sR0FBZ0MsRUFBRSxDQUFDO1FBQ3pDLGtCQUFhLEdBQVcsQ0FBQyxDQUFDLENBQUM7UUFDM0IsY0FBUyxHQUFtQyxFQUFFLENBQUM7UUFFL0MsY0FBUyxHQUFXLENBQUMsQ0FBQyxDQUFDO1FBRzdCLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxnQkFBZ0IsQ0FBQztJQUMzQyxDQUFDO0lBRUQsTUFBTSxDQUFDLElBQUksQ0FBYSxNQUFjLEVBQUUsZ0JBQW1DO1FBQ3pFLE1BQU0sRUFBRSxHQUFHLElBQUksUUFBUSxDQUFhLGdCQUFnQixJQUFJLGdCQUFnQixDQUFDLGlCQUFpQixFQUFFLENBQUMsQ0FBQztRQUM5RixhQUFhO1FBQ2IsTUFBTSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQzlCLE9BQU8sRUFBRSxDQUFDO0lBQ1osQ0FBQztJQUVELFFBQVE7UUFDTixPQUFPLElBQUksQ0FBQyxhQUFhLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFDbkMsQ0FBQztJQUVELFNBQVMsQ0FBQyxPQUE0QjtRQUNwQyxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztJQUN6QixDQUFDO0lBRUQsT0FBTyxDQUFDLENBQTRCO1FBQ2xDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3BCLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1FBQzVCLElBQUksQ0FB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SUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQztZQUNwQixJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDaEIsQ0FBQztRQUNELElBQUksQ0FBQyxNQUFNLEdBQUcsRUFBRSxDQUFDO1FBQ2pCLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0JBQW9CLENBQUMsQ0FBQztJQUNwQyxDQUFDO0lBRUQsWUFBWSxDQUFDLFNBQWlCO1FBQzVCLElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO1FBQzNCLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1FBQzVCLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVPLG9CQUFvQjtRQUMxQixJQUFJLElBQUksQ0FBQyxTQUFTLEdBQUcsQ0FBQyxFQUFFLENBQUM7WUFDdkIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQztZQUNsRCxJQUFJLEtBQUssR0FBRyxDQUFDLEVBQUUsQ0FBQztnQkFDZCxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFDL0QsSUFBSSxDQUFDLE1BQU0sR0FBRyxTQUFTLENBQUM7WUFDMUIsQ0FBQztRQUNILENBQUM7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBNSVQgTGljZW5zZVxuICpcbiAqIENvcHlyaWdodCAoYykgMjAxOSBSw6ltaSBWYW4gS2Vpc2JlbGNrXG4gKlxuICogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weVxuICogb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgXCJTb2Z0d2FyZVwiKSwgdG8gZGVhbFxuICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0c1xuICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbFxuICogY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzXG4gKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOlxuICpcbiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluIGFsbFxuICogY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS5cbiAqXG4gKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXG4gKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcbiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxuICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUlxuICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSxcbiAqIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFXG4gKiBTT0ZUV0FSRS5cbiAqXG4gKi9cblxuaW1wb3J0IHsgQ21kLCBub0NtZCwgT2JqZWN0U2VyaWFsaXplciB9IGZyb20gJ3RlYS1jdXAtY29yZSc7XG5pbXBvcnQgeyBQcm9ncmFtIH0gZnJvbSAnLi9Qcm9ncmFtJztcblxuZXhwb3J0IGludGVyZmFjZSBIYXNUaW1lIHtcbiAgcmVhZG9ubHkgdGltZTogbnVtYmVyO1xufVxuXG5pbnRlcmZhY2UgSGFzVGFnIHtcbiAgcmVhZG9ubHkgdGFnOiBzdHJpbmc7XG59XG5cbmV4cG9ydCB0eXBlIERldlRvb2xzRXZlbnQ8TW9kZWwsIE1zZz4gPSBJbml0PE1vZGVsLCBNc2c+IHwgVXBkYXRlZDxNb2RlbCwgTXNnPjtcblxuZXhwb3J0IGludGVyZmFjZSBJbml0PE1vZGVsLCBNc2c+IGV4dGVuZHMgSGFzVGltZSwgSGFzVGFnIHtcbiAgcmVhZG9ubHkgdGFnOiAnaW5pdCc7XG4gIHJlYWRvbmx5IG1vZGVsOiBNb2RlbDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBVcGRhdGVkPE1vZGVsLCBNc2c+IGV4dGVuZHMgSGFzVGltZSwgSGFzVGFnIHtcbiAgcmVhZG9ubHkgdGFnOiAndXBkYXRlZCc7XG4gIHJlYWRvbmx5IG1zZ051bTogbnVtYmVyO1xuICByZWFkb25seSBtc2c6IE1zZztcbiAgcmVhZG9ubHkgbW9kZWxCZWZvcmU6IE1vZGVsO1xuICByZWFkb25seSBtb2RlbEFmdGVyOiBNb2RlbDtcbiAgcmVhZG9ubHkgY21kOiBDbWQ8TXNnPjtcbn1cblxuY29uc3Qgc25hcHNob3RLZXkgPSAndGVhQ3VwU25hcHNob3QnO1xuXG5leHBvcnQgdHlwZSBEZXZUb29sc0xpc3RlbmVyPE1vZGVsLCBNc2c+ID0gKGU6IERldlRvb2xzRXZlbnQ8TW9kZWwsIE1zZz4pID0+IHZvaWQ7XG5cbmV4cG9ydCBjbGFzcyBEZXZUb29sczxNb2RlbCwgTXNnPiB7XG4gIHByaXZhdGUgcHJvZ3JhbT86IFByb2dyYW08TW9kZWwsIE1zZz47XG4gIHByaXZhdGUgZXZlbnRzOiBEZXZUb29sc0V2ZW50PE1vZGVsLCBNc2c+W10gPSBbXTtcbiAgcHJpdmF0ZSBwYXVzZWRPbkV2ZW50OiBudW1iZXIgPSAtMTtcbiAgcHJpdmF0ZSBsaXN0ZW5lcnM6IERldlRvb2xzTGlzdGVuZXI8TW9kZWwsIE1zZz5bXSA9IFtdO1xuICBwcml2YXRlIG9iamVjdFNlcmlhbGl6ZXI6IE9iamVjdFNlcmlhbGl6ZXI7XG4gIHByaXZhdGUgbWF4RXZlbnRzOiBudW1iZXIgPSAtMTtcblxuICBjb25zdHJ1Y3RvcihvYmplY3RTZXJpYWxpemVyOiBPYmplY3RTZXJpYWxpemVyKSB7XG4gICAgdGhpcy5vYmplY3RTZXJpYWxpemVyID0gb2JqZWN0U2VyaWFsaXplcjtcbiAgfVxuXG4gIHN0YXRpYyBpbml0PE1vZGVsLCBNc2c+KHdpbmRvdzogV2luZG93LCBvYmplY3RTZXJpYWxpemVyPzogT2JqZWN0U2VyaWFsaXplcik6IERldlRvb2xzPE1vZGVsLCBNc2c+IHtcbiAgICBjb25zdCBkdCA9IG5ldyBEZXZUb29sczxNb2RlbCwgTXNnPihvYmplY3RTZXJpYWxpemVyIHx8IE9iamVjdFNlcmlhbGl6ZXIud2l0aFRlYUN1cENsYXNzZXMoKSk7XG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIHdpbmRvd1sndGVhQ3VwRGV2VG9vbHMnXSA9IGR0O1xuICAgIHJldHVybiBkdDtcbiAgfVxuXG4gIGlzUGF1c2VkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLnBhdXNlZE9uRXZlbnQgIT09IC0xO1xuICB9XG5cbiAgY29ubmVjdGVkKHByb2dyYW06IFByb2dyYW08TW9kZWwsIE1zZz4pIHtcbiAgICB0aGlzLnByb2dyYW0gPSBwcm9ncmFtO1xuICB9XG5cbiAgb25FdmVudChlOiBEZXZUb29sc0V2ZW50PE1vZGVsLCBNc2c+KTogdm9pZCB7XG4gICAgdGhpcy5ldmVudHMucHVzaChlKTtcbiAgICB0aGlzLnJlbW92ZUV2ZW50c0lmTmVlZGVkKCk7XG4gICAgdGhpcy5saXN0ZW5lcnMuZm9yRWFjaCgobCkgPT4gbChlKSk7XG4gIH1cblxuICB0cmF2ZWxUbyhldnROdW06IG51bWJlcikge1xuICAgIGlmICh0aGlzLnByb2dyYW0pIHtcbiAgICAgIGNvbnN0IGV2dDogRGV2VG9vbHNFdmVudDxNb2RlbCwgTXNnPiA9IHRoaXMuZXZlbnRzW2V2dE51bV07XG4gICAgICBpZiAoZXZ0KSB7XG4gICAgICAgIGNvbnN0IG1vZGVsID0gdGhpcy5nZXRFdmVudE1vZGVsKGV2dCk7XG4gICAgICAgIHRoaXMucGF1c2VkT25FdmVudCA9IGV2dE51bTtcbiAgICAgICAgdGhpcy5wcm9ncmFtLnNldE1vZGVsKG1vZGVsLCBmYWxzZSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRFdmVudE1vZGVsKGU6IERldlRvb2xzRXZlbnQ8TW9kZWwsIE1zZz4pOiBNb2RlbCB7XG4gICAgc3dpdGNoIChlLnRhZykge1xuICAgICAgY2FzZSAnaW5pdCc6XG4gICAgICAgIHJldHVybiBlLm1vZGVsO1xuICAgICAgY2FzZSAndXBkYXRlZCc6XG4gICAgICAgIHJldHVybiBlLm1vZGVsQWZ0ZXI7XG4gICAgfVxuICB9XG5cbiAgcmVzdW1lKCkge1xuICAgIGlmICh0aGlzLnByb2dyYW0pIHtcbiAgICAgIGlmICh0aGlzLmV2ZW50cy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGNvbnN0IGxhc3RFdmVudCA9IHRoaXMuZXZlbnRzW3RoaXMuZXZlbnRzLmxlbmd0aCAtIDFdO1xuICAgICAgICBpZiAobGFzdEV2ZW50KSB7XG4gICAgICAgICAgY29uc3QgbW9kZWwgPSB0aGlzLmdldEV2ZW50TW9kZWwobGFzdEV2ZW50KTtcbiAgICAgICAgICB0aGlzLnBhdXNlZE9uRXZlbnQgPSAtMTtcbiAgICAgICAgICB0aGlzLnByb2dyYW0uc2V0TW9kZWwobW9kZWwsIHRydWUpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZm9yd2FyZCgpIHtcbiAgICBpZiAodGhpcy5wYXVzZWRPbkV2ZW50ID49IDAgJiYgdGhpcy5wYXVzZWRPbkV2ZW50IDwgdGhpcy5ldmVudHMubGVuZ3RoIC0gMSkge1xuICAgICAgdGhpcy50cmF2ZWxUbyh0aGlzLnBhdXNlZE9uRXZlbnQgKyAxKTtcbiAgICB9XG4gIH1cblxuICBiYWNrd2FyZCgpIHtcbiAgICBpZiAodGhpcy5wYXVzZWRPbkV2ZW50ID49IDEpIHtcbiAgICAgIHRoaXMudHJhdmVsVG8odGhpcy5wYXVzZWRPbkV2ZW50IC0gMSk7XG4gICAgfVxuICB9XG5cbiAgYWRkTGlzdGVuZXIobDogRGV2VG9vbHNMaXN0ZW5lcjxNb2RlbCwgTXNnPik6IHZvaWQge1xuICAgIHRoaXMubGlzdGVuZXJzLnB1c2gobCk7XG4gIH1cblxuICByZW1vdmVMaXN0ZW5lcihsOiBEZXZUb29sc0xpc3RlbmVyPE1vZGVsLCBNc2c+KTogdm9pZCB7XG4gICAgdGhpcy5saXN0ZW5lcnMgPSB0aGlzLmxpc3RlbmVycy5maWx0ZXIoKHgpID0+IHggIT09IGwpO1xuICB9XG5cbiAgbGFzdEV2ZW50KCk6IERldlRvb2xzRXZlbnQ8TW9kZWwsIE1zZz4ge1xuICAgIHJldHVybiB0aGlzLmV2ZW50c1t0aGlzLmV2ZW50cy5sZW5ndGggLSAxXTtcbiAgfVxuXG4gIGxhc3RNb2RlbCgpOiBNb2RlbCB7XG4gICAgY29uc3QgZSA9IHRoaXMubGFzdEV2ZW50KCk7XG4gICAgc3dpdGNoIChlLnRhZykge1xuICAgICAgY2FzZSAnaW5pdCc6IHtcbiAgICAgICAgcmV0dXJuIGUubW9kZWw7XG4gICAgICB9XG4gICAgICBjYXNlICd1cGRhdGVkJzoge1xuICAgICAgICByZXR1cm4gZS5tb2RlbEFmdGVyO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHNuYXBzaG90KCkge1xuICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKHNuYXBzaG90S2V5LCB0aGlzLm9iamVjdFNlcmlhbGl6ZXIuc2VyaWFsaXplKHRoaXMubGFzdE1vZGVsKCkpKTtcbiAgICBjb25zb2xlLmxvZyhcbiAgICAgICcqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKlxcbicgK1xuICAgICAgICAnKioqIFRoZSBjdXJyZW50IGFwcGxpY2F0aW9uIHN0YXRlIGhhcyBiZWVuIHNhdmVkIHRvIGxvY2FsIHN0b3JhZ2UuXFxuJyArXG4gICAgICAgICcqKiogVGhlIGFwcGxpY2F0aW9uIHdpbGwgbm93IGxvYWQgd2l0aCB0aGlzIGluaXRpYWwgc3RhdGUuXFxuJyArXG4gICAgICAgIFwiKioqIENhbGwgJ3RlYUN1cERldlRvb2xzLmNsZWFyU25hcHNob3QoKScgdG8gcmVzdG9yZSBub3JtYWwgbG9hZGluZy5cXG5cIiArXG4gICAgICAgICcqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKicsXG4gICAgKTtcbiAgfVxuXG4gIGluaXRGcm9tU25hcHNob3QoKTogW01vZGVsLCBDbWQ8TXNnPl0gfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IGpzb24gPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShzbmFwc2hvdEtleSk7XG4gICAgaWYgKGpzb24pIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgY29uc3QgbW9kZWwgPSB0aGlzLm9iamVjdFNlcmlhbGl6ZXIuZGVzZXJpYWxpemUoanNvbikgYXMgTW9kZWw7XG4gICAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICAgICcqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqXFxuJyArXG4gICAgICAgICAgICBcIioqKiBUaGUgYXBwbGljYXRpb24gaGFzIGluaXRpYWxpemVkIGZyb20gYSBzdGF0ZSBzYXZlZCBieSBjYWxsaW5nICd0ZWFDdXBEZXZUb29scy5zbmFwc2hvdCgpJy5cXG5cIiArXG4gICAgICAgICAgICBcIioqKiBDYWxsICd0ZWFDdXBEZXZUb29scy5jbGVhclNuYXBzaG90KCknIGlmIHlvdSB3YW50IHRvIHJlc3RvcmUgbm9ybWFsIGxvYWRpbmcuXFxuXCIgK1xuICAgICAgICAgICAgJyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKionLFxuICAgICAgICApO1xuICAgICAgICByZXR1cm4gbm9DbWQobW9kZWwpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBjb25zb2xlLmxvZygnKioqIEVycm9yIHJlc3RvcmluZyBzdGF0ZSBmcm9tIGxvY2FsIHN0b3JhZ2U6ICcsIGUpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGNsZWFyU25hcHNob3QoKSB7XG4gICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oc25hcHNob3RLZXkpO1xuICAgIGNvbnNvbGUubG9nKFxuICAgICAgJyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqXFxuJyArXG4gICAgICAgICcqKiogQXBwbGljYXRpb24gc3RhdGUgY2xlYXJlZCwgdGhlIGFwcGxpY2F0aW9uIHdpbGwgbm93IHN0YXJ0IG5vcm1hbGx5LlxcbicgK1xuICAgICAgICAnKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKionLFxuICAgICk7XG4gIH1cblxuICBjbGVhcigpIHtcbiAgICBpZiAodGhpcy5pc1BhdXNlZCgpKSB7XG4gICAgICB0aGlzLnJlc3VtZSgpO1xuICAgIH1cbiAgICB0aGlzLmV2ZW50cyA9IFtdO1xuICAgIGNvbnNvbGUubG9nKCdBbGwgZXZlbnRzIGNsZWFyZWQnKTtcbiAgfVxuXG4gIHNldE1heEV2ZW50cyhtYXhFdmVudHM6IG51bWJlcik6IERldlRvb2xzPE1vZGVsLCBNc2c+IHtcbiAgICB0aGlzLm1heEV2ZW50cyA9IG1heEV2ZW50cztcbiAgICB0aGlzLnJlbW92ZUV2ZW50c0lmTmVlZGVkKCk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBwcml2YXRlIHJlbW92ZUV2ZW50c0lmTmVlZGVkKCk6IERldlRvb2xzPE1vZGVsLCBNc2c+IHtcbiAgICBpZiAodGhpcy5tYXhFdmVudHMgPiAwKSB7XG4gICAgICBjb25zdCBkZWx0YSA9IHRoaXMuZXZlbnRzLmxlbmd0aCAtIHRoaXMubWF4RXZlbnRzO1xuICAgICAgaWYgKGRlbHRhID4gMCkge1xuICAgICAgICBjb25zdCBuZXdFdmVudHMgPSB0aGlzLmV2ZW50cy5zbGljZShkZWx0YSwgdGhpcy5ldmVudHMubGVuZ3RoKTtcbiAgICAgICAgdGhpcy5ldmVudHMgPSBuZXdFdmVudHM7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0aGlzO1xuICB9XG59XG4iXX0=
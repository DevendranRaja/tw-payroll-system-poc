/*
 * MIT License
 *
 * Copyright (c) 2019 RÃ©mi Van Keisbelck
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
import { Component } from 'react';
import { Sub, nextUuid, CmdNone } from 'tea-cup-core';
/**
 * A React component that holds a TEA "program", provides the Dispatcher, and implements the MVU loop.
 */
export class Program extends Component {
    constructor(props) {
        super(props);
        this.uuid = nextUuid();
        this.count = 0;
        this.bd = this.dispatch.bind(this);
    }
    fireEvent(e) {
        if (this.props.devTools) {
            this.props.devTools.onEvent(e);
        }
    }
    dispatch(msg) {
        if (this.currentSub === undefined) {
            return;
        }
        if (this.props.devTools && this.props.devTools.isPaused()) {
            // do not process messages if we are paused
            return;
        }
        this.count++;
        const count = this.count;
        const currentModel = this.currentModel;
        if (currentModel !== undefined) {
            const updated = this.props.update(msg, currentModel);
            if (this.props.devTools) {
                this.fireEvent({
                    tag: 'updated',
                    msgNum: count,
                    time: new Date().getTime(),
                    msg: msg,
                    modelBefore: currentModel,
                    modelAfter: updated[0],
                    cmd: updated[1],
                });
            }
            const newSub = this.props.subscriptions(updated[0]);
            const prevSub = this.currentSub;
            const d = this.dispatch.bind(this);
            newSub.init(d);
            prevSub === null || prevSub === void 0 ? void 0 : prevSub.release();
            // perform commands in a separate timout, to
            // make sure that this dispatch is done
            const cmd = updated[1];
            if (!(cmd instanceof CmdNone)) {
                setTimeout(() => {
                    // console.log("dispatch: processing commands");
                    // debug("performing command", updated[1]);
                    updated[1].execute(d);
                    // debug("<<<  done");
                }, 0);
            }
            const needsUpdate = this.currentModel !== updated[0];
            this.currentModel = updated[0];
            this.currentSub = newSub;
            // trigger rendering
            if (needsUpdate) {
                this.forceUpdate();
            }
        }
    }
    componentWillUnmount() {
        var _a;
        (_a = this.currentSub) === null || _a === void 0 ? void 0 : _a.release();
        this.currentSub = undefined;
    }
    componentDidMount() {
        const { devTools } = this.props;
        if (devTools) {
            devTools.connected(this);
        }
        const mac = (devTools && devTools.initFromSnapshot()) || this.props.init();
        if (devTools) {
            this.fireEvent({
                tag: 'init',
                time: new Date().getTime(),
                model: mac[0],
            });
        }
        const sub = this.props.subscriptions(mac[0]);
        this.currentModel = mac[0];
        this.currentSub = sub;
        // connect to sub
        sub.init(this.bd);
        this.initialCmd = mac[1];
        // trigger initial command
        setTimeout(() => {
            this.initialCmd && this.initialCmd.execute(this.bd);
        }, 0);
        // trigger rendering after mount
        this.forceUpdate();
    }
    render() {
        if (this.currentModel !== undefined && this.bd) {
            return this.props.view(this.bd, this.currentModel);
        }
        return null;
    }
    setModel(model, withSubs) {
        if (this.bd) {
            let newSub;
            if (withSubs) {
                newSub = this.props.subscriptions(model);
            }
            else {
                newSub = Sub.none();
            }
            newSub.init(this.bd);
            this.currentSub && this.currentSub.release();
            this.currentModel = model;
            this.currentSub = newSub;
            this.forceUpdate();
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUHJvZ3JhbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9UZWFDdXAvUHJvZ3JhbS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0F1Qkc7QUFFSCxPQUFPLEVBQUUsU0FBUyxFQUFhLE1BQU0sT0FBTyxDQUFDO0FBQzdDLE9BQU8sRUFBbUIsR0FBRyxFQUFFLFFBQVEsRUFBRSxPQUFPLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFldkU7O0dBRUc7QUFDSCxNQUFNLE9BQU8sT0FBb0IsU0FBUSxTQUEwQztJQVFqRixZQUFZLEtBQXlDO1FBQ25ELEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztRQVJOLFNBQUksR0FBRyxRQUFRLEVBQUUsQ0FBQztRQUVuQixVQUFLLEdBQVcsQ0FBQyxDQUFDO1FBT3hCLElBQUksQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDckMsQ0FBQztJQUVPLFNBQVMsQ0FBQyxDQUE0QjtRQUM1QyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDeEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2pDLENBQUM7SUFDSCxDQUFDO0lBRUQsUUFBUSxDQUFDLEdBQVE7UUFDZixJQUFJLElBQUksQ0FBQyxVQUFVLEtBQUssU0FBUyxFQUFFLENBQUM7WUFDbEMsT0FBTztRQUNULENBQUM7UUFDRCxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUM7WUFDMUQsMkNBQTJDO1lBQzNDLE9BQU87UUFDVCxDQUFDO1FBRUQsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ2IsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUss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QkFDTixNQUFNLEdBQUcsR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ3RCLENBQUM7WUFDRCxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUNyQixJQUFJLENBQUMsVUFBVSxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDN0MsSUFBSSxDQUFDLFlBQVksR0FBRyxLQUFLLENBQUM7WUFDMUIsSUFBSSxDQUFDLFVBQVUsR0FBRyxNQUFNLENBQUM7WUFDekIsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ3JCLENBQUM7SUFDSCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTUlUIExpY2Vuc2VcbiAqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTkgUsOpbWkgVmFuIEtlaXNiZWxja1xuICpcbiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlIFwiU29mdHdhcmVcIiksIHRvIGRlYWxcbiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHNcbiAqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGxcbiAqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpc1xuICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczpcbiAqXG4gKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbiBhbGxcbiAqIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuXG4gKlxuICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuICogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksXG4gKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbiAqIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXG4gKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRVxuICogU09GVFdBUkUuXG4gKlxuICovXG5cbmltcG9ydCB7IENvbXBvbmVudCwgUmVhY3ROb2RlIH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IHsgRGlzcGF0Y2hlciwgQ21kLCBTdWIsIG5leHRVdWlkLCBDbWROb25lIH0gZnJvbSAndGVhLWN1cC1jb3JlJztcbmltcG9ydCB7IERldlRvb2xzRXZlbnQsIERldlRvb2xzIH0gZnJvbSAnLi9EZXZUb29scyc7XG5cbi8qKlxuICogVGhlIHByb2dyYW0gcHJvcHMgOiBhc2tzIGZvciBpbml0LCB2aWV3LCB1cGRhdGUgYW5kIHN1YnMgaW4gb3JkZXJcbiAqIHRvIHN0YXJ0IHRoZSBURUEgTVZVIGxvb3AuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgUHJvZ3JhbVByb3BzPE1vZGVsLCBNc2c+IHtcbiAgaW5pdDogKCkgPT4gW01vZGVsLCBDbWQ8TXNnPl07XG4gIHZpZXc6IChkaXNwYXRjaDogRGlzcGF0Y2hlcjxNc2c+LCBtb2RlbDogTW9kZWwpID0+IFJlYWN0Tm9kZTtcbiAgdXBkYXRlOiAobXNnOiBNc2csIG1vZGVsOiBNb2RlbCkgPT4gW01vZGVsLCBDbWQ8TXNnPl07XG4gIHN1YnNjcmlwdGlvbnM6IChtb2RlbDogTW9kZWwpID0+IFN1YjxNc2c+O1xuICBkZXZUb29scz86IERldlRvb2xzPE1vZGVsLCBNc2c+O1xufVxuXG4vKipcbiAqIEEgUmVhY3QgY29tcG9uZW50IHRoYXQgaG9sZHMgYSBURUEgXCJwcm9ncmFtXCIsIHByb3ZpZGVzIHRoZSBEaXNwYXRjaGVyLCBhbmQgaW1wbGVtZW50cyB0aGUgTVZVIGxvb3AuXG4gKi9cbmV4cG9ydCBjbGFzcyBQcm9ncmFtPE1vZGVsLCBNc2c+IGV4dGVuZHMgQ29tcG9uZW50PFByb2dyYW1Qcm9wczxNb2RlbCwgTXNnPiwgbmV2ZXI+IHtcbiAgcmVhZG9ubHkgdXVpZCA9IG5leHRVdWlkKCk7XG4gIHByaXZhdGUgcmVhZG9ubHkgYmQ6IERpc3BhdGNoZXI8TXNnPjtcbiAgcHJpdmF0ZSBjb3VudDogbnVtYmVyID0gMDtcbiAgcHJpdmF0ZSBpbml0aWFsQ21kPzogQ21kPGFueT47XG4gIHByaXZhdGUgY3VycmVudE1vZGVsPzogTW9kZWw7XG4gIHByaXZhdGUgY3VycmVudFN1Yj86IFN1YjxNc2c+O1xuXG4gIGNvbnN0cnVjdG9yKHByb3BzOiBSZWFkb25seTxQcm9ncmFtUHJvcHM8TW9kZWwsIE1zZz4+KSB7XG4gICAgc3VwZXIocHJvcHMpO1xuICAgIHRoaXMuYmQgPSB0aGlzLmRpc3BhdGNoLmJpbmQodGhpcyk7XG4gIH1cblxuICBwcml2YXRlIGZpcmVFdmVudChlOiBEZXZUb29sc0V2ZW50PE1vZGVsLCBNc2c+KSB7XG4gICAgaWYgKHRoaXMucHJvcHMuZGV2VG9vbHMpIHtcbiAgICAgIHRoaXMucHJvcHMuZGV2VG9vbHMub25FdmVudChlKTtcbiAgICB9XG4gIH1cblxuICBkaXNwYXRjaChtc2c6IE1zZykge1xuICAgIGlmICh0aGlzLmN1cnJlbnRTdWIgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAodGhpcy5wcm9wcy5kZXZUb29scyAmJiB0aGlzLnByb3BzLmRldlRvb2xzLmlzUGF1c2VkKCkpIHtcbiAgICAgIC8vIGRvIG5vdCBwcm9jZXNzIG1lc3NhZ2VzIGlmIHdlIGFyZSBwYXVzZWRcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLmNvdW50Kys7XG4gICAgY29uc3QgY291bnQgPSB0aGlzLmNvdW50O1xuICAgIGNvbnN0IGN1cnJlbnRNb2RlbCA9IHRoaXMuY3VycmVudE1vZGVsO1xuICAgIGlmIChjdXJyZW50TW9kZWwgIT09IHVuZGVmaW5lZCkge1xuICAgICAgY29uc3QgdXBkYXRlZCA9IHRoaXMucHJvcHMudXBkYXRlKG1zZywgY3VycmVudE1vZGVsKTtcbiAgICAgIGlmICh0aGlzLnByb3BzLmRldlRvb2xzKSB7XG4gICAgICAgIHRoaXMuZmlyZUV2ZW50KHtcbiAgICAgICAgICB0YWc6ICd1cGRhdGVkJyxcbiAgICAgICAgICBtc2dOdW06IGNvdW50LFxuICAgICAgICAgIHRpbWU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLFxuICAgICAgICAgIG1zZzogbXNnLFxuICAgICAgICAgIG1vZGVsQmVmb3JlOiBjdXJyZW50TW9kZWwsXG4gICAgICAgICAgbW9kZWxBZnRlcjogdXBkYXRlZFswXSxcbiAgICAgICAgICBjbWQ6IHVwZGF0ZWRbMV0sXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgY29uc3QgbmV3U3ViID0gdGhpcy5wcm9wcy5zdWJzY3JpcHRpb25zKHVwZGF0ZWRbMF0pO1xuICAgICAgY29uc3QgcHJldlN1YiA9IHRoaXMuY3VycmVudFN1YjtcblxuICAgICAgY29uc3QgZCA9IHRoaXMuZGlzcGF0Y2guYmluZCh0aGlzKTtcblxuICAgICAgbmV3U3ViLmluaXQoZCk7XG4gICAgICBwcmV2U3ViPy5yZWxlYXNlKCk7XG5cbiAgICAgIC8vIHBlcmZvcm0gY29tbWFuZHMgaW4gYSBzZXBhcmF0ZSB0aW1vdXQsIHRvXG4gICAgICAvLyBtYWtlIHN1cmUgdGhhdCB0aGlzIGRpc3BhdGNoIGlzIGRvbmVcbiAgICAgIGNvbnN0IGNtZCA9IHVwZGF0ZWRbMV07XG4gICAgICBpZiAoIShjbWQgaW5zdGFuY2VvZiBDbWROb25lKSkge1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAvLyBjb25zb2xlLmxvZyhcImRpc3BhdGNoOiBwcm9jZXNzaW5nIGNvbW1hbmRzXCIpO1xuICAgICAgICAgIC8vIGRlYnVnKFwicGVyZm9ybWluZyBjb21tYW5kXCIsIHVwZGF0ZWRbMV0pO1xuICAgICAgICAgIHVwZGF0ZWRbMV0uZXhlY3V0ZShkKTtcbiAgICAgICAgICAvLyBkZWJ1ZyhcIjw8PCAgZG9uZVwiKTtcbiAgICAgICAgfSwgMCk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IG5lZWRzVXBkYXRlID0gdGhpcy5jdXJyZW50TW9kZWwgIT09IHVwZGF0ZWRbMF07XG5cbiAgICAgIHRoaXMuY3VycmVudE1vZGVsID0gdXBkYXRlZFswXTtcbiAgICAgIHRoaXMuY3VycmVudFN1YiA9IG5ld1N1YjtcblxuICAgICAgLy8gdHJpZ2dlciByZW5kZXJpbmdcbiAgICAgIGlmIChuZWVkc1VwZGF0ZSkge1xuICAgICAgICB0aGlzLmZvcmNlVXBkYXRlKCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgdGhpcy5jdXJyZW50U3ViPy5yZWxlYXNlKCk7XG4gICAgdGhpcy5jdXJyZW50U3ViID0gdW5kZWZpbmVkO1xuICB9XG5cbiAgY29tcG9uZW50RGlkTW91bnQoKSB7XG4gICAgY29uc3QgeyBkZXZUb29scyB9ID0gdGhpcy5wcm9wcztcbiAgICBpZiAoZGV2VG9vbHMpIHtcbiAgICAgIGRldlRvb2xzLmNvbm5lY3RlZCh0aGlzKTtcbiAgICB9XG4gICAgY29uc3QgbWFjID0gKGRldlRvb2xzICYmIGRldlRvb2xzLmluaXRGcm9tU25hcHNob3QoKSkgfHwgdGhpcy5wcm9wcy5pbml0KCk7XG4gICAgaWYgKGRldlRvb2xzKSB7XG4gICAgICB0aGlzLmZpcmVFdmVudCh7XG4gICAgICAgIHRhZzogJ2luaXQnLFxuICAgICAgICB0aW1lOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSxcbiAgICAgICAgbW9kZWw6IG1hY1swXSxcbiAgICAgIH0pO1xuICAgIH1cbiAgICBjb25zdCBzdWIgPSB0aGlzLnByb3BzLnN1YnNjcmlwdGlvbnMobWFjWzBdKTtcbiAgICB0aGlzLmN1cnJlbnRNb2RlbCA9IG1hY1swXTtcbiAgICB0aGlzLmN1cnJlbnRTdWIgPSBzdWI7XG4gICAgLy8gY29ubmVjdCB0byBzdWJcbiAgICBzdWIuaW5pdCh0aGlzLmJkKTtcbiAgICB0aGlzLmluaXRpYWxDbWQgPSBtYWNbMV07XG5cbiAgICAvLyB0cmlnZ2VyIGluaXRpYWwgY29tbWFuZFxuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgdGhpcy5pbml0aWFsQ21kICYmIHRoaXMuaW5pdGlhbENtZC5leGVjdXRlKHRoaXMuYmQpO1xuICAgIH0sIDApO1xuXG4gICAgLy8gdHJpZ2dlciByZW5kZXJpbmcgYWZ0ZXIgbW91bnRcbiAgICB0aGlzLmZvcmNlVXBkYXRlKCk7XG4gIH1cblxuICByZW5kZXIoKTogUmVhY3ROb2RlIHtcbiAgICBpZiAodGhpcy5jdXJyZW50TW9kZWwgIT09IHVuZGVmaW5lZCAmJiB0aGlzLmJkKSB7XG4gICAgICByZXR1cm4gdGhpcy5wcm9wcy52aWV3KHRoaXMuYmQsIHRoaXMuY3VycmVudE1vZGVsKTtcbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBzZXRNb2RlbChtb2RlbDogTW9kZWwsIHdpdGhTdWJzOiBib29sZWFuKSB7XG4gICAgaWYgKHRoaXMuYmQpIHtcbiAgICAgIGxldCBuZXdTdWI6IFN1YjxNc2c+O1xuICAgICAgaWYgKHdpdGhTdWJzKSB7XG4gICAgICAgIG5ld1N1YiA9IHRoaXMucHJvcHMuc3Vic2NyaXB0aW9ucyhtb2RlbCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBuZXdTdWIgPSBTdWIubm9uZSgpO1xuICAgICAgfVxuICAgICAgbmV3U3ViLmluaXQodGhpcy5iZCk7XG4gICAgICB0aGlzLmN1cnJlbnRTdWIgJiYgdGhpcy5jdXJyZW50U3ViLnJlbGVhc2UoKTtcbiAgICAgIHRoaXMuY3VycmVudE1vZGVsID0gbW9kZWw7XG4gICAgICB0aGlzLmN1cnJlbnRTdWIgPSBuZXdTdWI7XG4gICAgICB0aGlzLmZvcmNlVXBkYXRlKCk7XG4gICAgfVxuICB9XG59XG4iXX0=
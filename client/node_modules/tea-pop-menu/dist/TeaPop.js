"use strict";
/*
 * MIT License
 *
 * Copyright (c) 2020 RÃ©mi Van Keisbelck
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.subscriptions = exports.update = exports.open = void 0;
const Msg_1 = require("./Msg");
const tea_cup_core_1 = require("tea-cup-core");
const Model_1 = require("./Model");
const Menu_1 = require("./Menu");
const tea_pop_core_1 = require("tea-pop-core");
const react_tea_cup_1 = require("react-tea-cup");
const Logger_1 = require("./Logger");
function open(menu, refBox, selectFirst = false) {
    Logger_1.log('teapop', 'open', 'refBox', refBox);
    return [
        Model_1.initialModel(selectFirst ? menu.selectFirstItem() : menu.deselectAll(), refBox),
        tea_cup_core_1.Cmd.batch([
            tea_cup_core_1.Task.perform(getWindowDimensions, (d) => Msg_1.gotWindowDimensions(d)),
            tea_cup_core_1.Task.perform(tea_cup_core_1.uuid(), (u) => Msg_1.gotUuid(u)),
        ]),
    ];
}
exports.open = open;
function postOpen(model) {
    if (model.uuid.type === 'Nothing') {
        return tea_cup_core_1.noCmd(model);
    }
    if (model.windowSize.type === 'Nothing') {
        return tea_cup_core_1.noCmd(model);
    }
    const cmd = tea_cup_core_1.Task.attempt(Menu_1.menuTask(model.uuid.value).map((e) => {
        const rect = e.getBoundingClientRect();
        const b = tea_pop_core_1.Box.fromDomRect(rect);
        Logger_1.log('teapop', 'postOpen', 'menu box', b);
        return b;
    }), (x) => Msg_1.gotMenuBox(x));
    return [model, cmd];
}
function withOut(mac, outMsg = tea_cup_core_1.nothing) {
    return [mac[0], mac[1], outMsg];
}
function update(msg, model) {
    switch (msg.tag) {
        case 'got-window-dimensions': {
            if (model.state.tag === 'open') {
                return withOut(tea_cup_core_1.noCmd(model), tea_cup_core_1.just({ tag: 'request-close' }));
            }
            return withOut(postOpen(Object.assign(Object.assign({}, model), { windowSize: tea_cup_core_1.just(msg.d) })));
        }
        case 'window-blur': {
            return withOut(tea_cup_core_1.noCmd(model), tea_cup_core_1.just({ tag: 'request-close' }));
        }
        case 'got-uuid': {
            return withOut(postOpen(Object.assign(Object.assign({}, model), { uuid: tea_cup_core_1.just(msg.uuid) })));
        }
        case 'got-menu-box': {
            if (model.state.tag === 'placing') {
                const state = model.state;
                return withOut(tea_cup_core_1.noCmd(model.windowSize
                    .map((windowSize) => {
                    const newModel = msg.r.match((menuBox) => {
                        Logger_1.log('teapop', 'got-menu-box', 'menuBox', menuBox);
                        const placedBox = tea_pop_core_1.place(windowSize, state.refBox, menuBox.d);
                        Logger_1.log('teapop', 'got-menu-box', 'placedBox', placedBox);
                        return Object.assign(Object.assign({}, model), { state: {
                                tag: 'open',
                                box: placedBox,
                            } });
                    }, (err) => (Object.assign(Object.assign({}, model), { error: tea_cup_core_1.just(err) })));
                    return newModel;
                })
                    .withDefault(model)));
            }
            Logger_1.log('teapop', 'got-menu-box', 'not placing');
            return withOut(tea_cup_core_1.noCmd(model));
        }
        case 'key-down': {
            switch (msg.key) {
                case 'Escape': {
                    return withOut(collapseLastSubMenu(Model_1.keyboardNavigated(model)), model.child.isNothing() ? tea_cup_core_1.just({ tag: 'request-close' }) : tea_cup_core_1.nothing);
                }
                case 'ArrowDown':
                case 'ArrowUp': {
                    return mapLastMenu(Model_1.keyboardNavigated(model), (lastModel) => {
                        return withOut(tea_cup_core_1.noCmd(Object.assign(Object.assign({}, lastModel), { menu: lastModel.menu.moveSelection(msg.key === 'ArrowDown') })));
                    });
                }
                case 'ArrowLeft':
                    return withOut(collapseLastSubMenu(Model_1.keyboardNavigated(model)));
                case 'ArrowRight':
                    return expandLastSubMenu(Model_1.keyboardNavigated(model));
                case 'Enter':
                case ' ': {
                    return toggleOrSelectItem(model);
                }
                default:
                    return withOut(tea_cup_core_1.noCmd(model));
            }
        }
        case 'mouse-move': {
            if (model.menu.isSelected(msg.item)) {
                return withOut(tea_cup_core_1.noCmd(model));
            }
            const newModel = Object.assign(Object.assign({}, model), { subMenuCounter: model.subMenuCounter + 1 });
            if (model.navigatedWithKeyboard) {
                return withOut(tea_cup_core_1.noCmd(Model_1.keyboardNavigated(newModel, false)));
            }
            if (model.uuid.type === 'Nothing') {
                return withOut(tea_cup_core_1.noCmd(newModel));
            }
            const menu = model.menu.selectItem(msg.item);
            const uuid = model.uuid.value;
            return withOut(openSubMenu(Object.assign(Object.assign({}, newModel), { menu, child: tea_cup_core_1.nothing }), uuid, msg.item, msg.itemIndex, false));
        }
        case 'mouse-leave': {
            return withOut(tea_cup_core_1.noCmd(model.child.isJust()
                ? model
                : Object.assign(Object.assign({}, model), { menu: model.menu.deselectAll() })));
        }
        case 'got-item-box': {
            if (msg.subMenuCounter !== model.subMenuCounter) {
                return withOut(tea_cup_core_1.noCmd(model));
            }
            return withOut(msg.r.match((itemBox) => {
                const newModel = Object.assign(Object.assign({}, model), { menu: model.menu.selectItem(msg.item) });
                return msg.item.subMenu
                    .map((subMenu) => {
                    // we have a sub menu so we need
                    // to open a new Menu !
                    const mac = open(subMenu, itemBox, msg.selectFirst);
                    const newModel2 = Object.assign(Object.assign({}, newModel), { child: tea_cup_core_1.just(mac[0]) });
                    return tea_cup_core_1.Tuple.t2n(newModel2, mac[1].map(Msg_1.childMsg));
                })
                    .withDefaultSupply(() => {
                    // close any existing child !
                    return newModel.child
                        .map(() => tea_cup_core_1.noCmd(Object.assign(Object.assign({}, model), { child: tea_cup_core_1.nothing })))
                        .withDefaultSupply(() => tea_cup_core_1.noCmd(model));
                });
            }, (err) => tea_cup_core_1.noCmd(Object.assign(Object.assign({}, model), { error: tea_cup_core_1.just(err) }))));
        }
        case 'child-msg': {
            return model.child
                .map((child) => {
                const mco = update(msg.m, child);
                const newModel = Object.assign(Object.assign({}, model), { child: tea_cup_core_1.just(mco[0]) });
                return withOut(tea_cup_core_1.Tuple.t2n(newModel, mco[1].map(Msg_1.childMsg)), mco[2]);
            })
                .withDefaultSupply(() => withOut(tea_cup_core_1.noCmd(model)));
        }
        case 'item-clicked': {
            return withOut(tea_cup_core_1.noCmd(model), outItemSelected(msg.item));
        }
        case 'doc-mouse-down': {
            return withOut(tea_cup_core_1.noCmd(model), tea_cup_core_1.just({ tag: 'request-close' }));
        }
        case 'noop': {
            return withOut(tea_cup_core_1.noCmd(model));
        }
    }
}
exports.update = update;
function outItemSelected(item) {
    return tea_cup_core_1.just({ tag: 'item-selected', data: item.userData });
}
function openSubMenu(model, menuId, item, itemIndex, selectFirst) {
    if (item.subMenu.isNothing()) {
        return tea_cup_core_1.noCmd(model);
    }
    const subMenuCounter = model.subMenuCounter + 1;
    return tea_cup_core_1.Tuple.t2n(Object.assign(Object.assign({}, model), { subMenuCounter }), tea_cup_core_1.Task.attempt(Menu_1.menuItemTask(menuId, itemIndex).map((e) => {
        return tea_pop_core_1.Box.fromDomRect(e.getBoundingClientRect());
    }), (r) => Msg_1.gotItemBox(item, r, subMenuCounter, selectFirst)));
}
const windowEvents = new react_tea_cup_1.WindowEvents();
const documentEvents = new react_tea_cup_1.DocumentEvents();
function subscriptions(model) {
    return tea_cup_core_1.Sub.batch([
        windowEvents.on('resize', () => Msg_1.gotWindowDimensions(tea_pop_core_1.dim(window.innerWidth, window.innerHeight))),
        windowEvents.on('blur', () => Msg_1.gotwindowBlur()),
        documentEvents.on('mousedown', (evt) => {
            if (evt.button === 2) {
                return Msg_1.noop();
            }
            let t = evt.target;
            while (t) {
                // move up and try to find if we are inside a tea-pop Menu !
                if (t.classList.contains('tm')) {
                    return Msg_1.noop();
                }
                t = t.parentElement;
            }
            return Msg_1.docMouseDown();
        }, true),
        model.state.tag === 'open'
            ? documentEvents.on('keydown', (e) => Msg_1.gotKeyDown(e.key))
            : tea_cup_core_1.Sub.none(),
    ]);
}
exports.subscriptions = subscriptions;
const getWindowDimensions = tea_cup_core_1.Task.succeedLazy(() => tea_pop_core_1.dim(window.innerWidth, window.innerHeight));
function mapLastMenu(model, f) {
    switch (model.child.type) {
        case 'Nothing': {
            // I'm the last model !
            return f(model);
        }
        case 'Just': {
            const mac = mapLastMenu(model.child.value, f);
            return [Object.assign(Object.assign({}, model), { child: tea_cup_core_1.just(mac[0]) }), mac[1].map(Msg_1.childMsg), mac[2]];
        }
    }
}
function collapseLastSubMenu(model) {
    switch (model.child.type) {
        case 'Nothing':
            return tea_cup_core_1.noCmd(model);
        case 'Just': {
            // I have a child : close it if he has no child !
            const child = model.child.value;
            if (child.child.isJust()) {
                return tea_cup_core_1.Tuple.fromNative(collapseLastSubMenu(child))
                    .mapFirst((c) => (Object.assign(Object.assign({}, model), { child: tea_cup_core_1.just(c) })))
                    .mapSecond((cmd) => cmd.map(Msg_1.childMsg))
                    .toNative();
            }
            else {
                return tea_cup_core_1.noCmd(Object.assign(Object.assign({}, model), { child: tea_cup_core_1.nothing }));
            }
        }
    }
}
function expandLastSubMenu(model) {
    return mapLastMenu(model, (lastModel) => {
        return lastModel.menu.selectedItem
            .map((selectedItem) => {
            return selectedItem.subMenu
                .map(() => {
                if (lastModel.uuid.type === 'Nothing') {
                    return withOut(tea_cup_core_1.noCmd(lastModel));
                }
                const uuid = lastModel.uuid.value;
                const mac = lastModel.menu
                    .indexOfItem(selectedItem)
                    .map((itemIndex) => {
                    return openSubMenu(lastModel, uuid, selectedItem, itemIndex, true);
                })
                    .withDefaultSupply(() => tea_cup_core_1.noCmd(lastModel));
                return withOut(mac);
            })
                .withDefaultSupply(() => {
                return withOut(tea_cup_core_1.noCmd(lastModel));
            });
        })
            .withDefaultSupply(() => {
            return withOut(tea_cup_core_1.noCmd(lastModel));
        });
    });
}
function toggleOrSelectItem(model) {
    return mapLastMenu(model, (lastModel) => {
        return lastModel.menu.selectedItem
            .map((selectedItem) => {
            if (lastModel.uuid.type === 'Nothing') {
                return withOut(tea_cup_core_1.noCmd(lastModel));
            }
            const uuid = lastModel.uuid.value;
            // do we have a sub-menu ?
            return selectedItem.subMenu
                .map(() => {
                // we have a sub-menu, expand it
                const mac = lastModel.menu
                    .indexOfItem(selectedItem)
                    .map((itemIndex) => openSubMenu(lastModel, uuid, selectedItem, itemIndex, true))
                    .withDefaultSupply(() => tea_cup_core_1.noCmd(lastModel));
                return withOut(mac);
            })
                .withDefaultSupply(() => {
                // no sub-menu, select the item
                return withOut(tea_cup_core_1.noCmd(lastModel), outItemSelected(selectedItem));
            });
        })
            .withDefaultSupply(() => withOut(tea_cup_core_1.noCmd(lastModel)));
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGVhUG9wLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL1RlYVBvcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBdUJHOzs7QUFFSCwrQkFXZTtBQUNmLCtDQVVzQjtBQUN0QixtQ0FBaUU7QUFDakUsaUNBQWdFO0FBQ2hFLCtDQUFvRDtBQUVwRCxpREFBNkQ7QUFDN0QscUNBQStCO0FBRS9CLFNBQWdCLElBQUksQ0FDbEIsSUFBYSxFQUNiLE1BQVcsRUFDWCxXQUFXLEdBQUcsS0FBSztJQUVuQixZQUFHLENBQUMsUUFBUSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDeEMsT0FBTztRQUNMLG9CQUFZLENBQ1YsV0FBVyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsRUFDekQsTUFBTSxDQUNQO1FBQ0Qsa0JBQUcsQ0FBQyxLQUFLLENBQUM7WUFDUixtQkFBSSxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMseUJBQW1CLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDaEUsbUJBQUksQ0FBQyxPQUFPLENBQUMsbUJBQUksRUFBRSxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxhQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDeEMsQ0FBQztLQUNILENBQUM7QUFDSixDQUFDO0FBaEJELG9CQWdCQztBQUVELFNBQVMsUUFBUSxDQUFJLEtBQWU7SUFDbEMsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksS0FBSyxTQUFTLEVBQUU7UUFDakMsT0FBTyxvQkFBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO0tBQ3JCO0lBQ0QsSUFBSSxLQUFLLENBQUMsVUFBVSxDQUFDLElBQUksS0FBSyxTQUFTLEVBQUU7UUFDdkMsT0FBTyxvQkFB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V0FBVyxDQUFDLFlBQVksQ0FBQztxQkFDekIsR0FBRyxDQUFDLENBQUMsU0FBUyxFQUFFLEVBQUUsQ0FDakIsV0FBVyxDQUFDLFNBQVMsRUFBRSxJQUFJLEVBQUUsWUFBWSxFQUFFLFNBQVMsRUFBRSxJQUFJLENBQUMsQ0FDNUQ7cUJBQ0EsaUJBQWlCLENBQUMsR0FBRyxFQUFFLENBQUMsb0JBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO2dCQUM3QyxPQUFPLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUN0QixDQUFDLENBQUM7aUJBQ0QsaUJBQWlCLENBQUMsR0FBRyxFQUFFO2dCQUN0QiwrQkFBK0I7Z0JBQy9CLE9BQU8sT0FBTyxDQUFDLG9CQUFLLENBQUMsU0FBUyxDQUFDLEVBQUUsZUFBZSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7WUFDbEUsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDLENBQUM7YUFDRCxpQkFBaUIsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsb0JBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDeEQsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIE1JVCBMaWNlbnNlXG4gKlxuICogQ29weXJpZ2h0IChjKSAyMDIwIFLDqW1pIFZhbiBLZWlzYmVsY2tcbiAqXG4gKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5XG4gKiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSBcIlNvZnR3YXJlXCIpLCB0byBkZWFsXG4gKiBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzXG4gKiB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsXG4gKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXNcbiAqIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6XG4gKlxuICogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4gYWxsXG4gKiBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLlxuICpcbiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1JcbiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxuICogRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFXG4gKiBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXG4gKiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxuICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEVcbiAqIFNPRlRXQVJFLlxuICpcbiAqL1xuXG5pbXBvcnQge1xuICBjaGlsZE1zZyxcbiAgZG9jTW91c2VEb3duLFxuICBnb3RJdGVtQm94LFxuICBnb3RLZXlEb3duLFxuICBnb3RNZW51Qm94LFxuICBnb3RVdWlkLFxuICBnb3R3aW5kb3dCbHVyLFxuICBnb3RXaW5kb3dEaW1lbnNpb25zLFxuICBNc2csXG4gIG5vb3AsXG59IGZyb20gJy4vTXNnJztcbmltcG9ydCB7XG4gIENtZCxcbiAganVzdCxcbiAgTWF5YmUsXG4gIG5vQ21kLFxuICBub3RoaW5nLFxuICBTdWIsXG4gIFRhc2ssXG4gIFR1cGxlLFxuICB1dWlkLFxufSBmcm9tICd0ZWEtY3VwLWNvcmUnO1xuaW1wb3J0IHsgaW5pdGlhbE1vZGVsLCBrZXlib2FyZE5hdmlnYXRlZCwgTW9kZWwgfSBmcm9tICcuL01vZGVsJztcbmltcG9ydCB7IE1lbnUsIE1lbnVJdGVtLCBtZW51SXRlbVRhc2ssIG1lbnVUYXNrIH0gZnJvbSAnLi9NZW51JztcbmltcG9ydCB7IGRpbSwgRGltLCBCb3gsIHBsYWNlIH0gZnJvbSAndGVhLXBvcC1jb3JlJztcbmltcG9ydCB7IE91dE1zZyB9IGZyb20gJy4vT3V0TXNnJztcbmltcG9ydCB7IERvY3VtZW50RXZlbnRzLCBXaW5kb3dFdmVudHMgfSBmcm9tICdyZWFjdC10ZWEtY3VwJztcbmltcG9ydCB7IGxvZyB9IGZyb20gJy4vTG9nZ2VyJztcblxuZXhwb3J0IGZ1bmN0aW9uIG9wZW48VD4oXG4gIG1lbnU6IE1lbnU8VD4sXG4gIHJlZkJveDogQm94LFxuICBzZWxlY3RGaXJzdCA9IGZhbHNlLFxuKTogW01vZGVsPFQ+LCBDbWQ8TXNnPFQ+Pl0ge1xuICBsb2coJ3RlYXBvcCcsICdvcGVuJywgJ3JlZkJveCcsIHJlZkJveCk7XG4gIHJldHVybiBbXG4gICAgaW5pdGlhbE1vZGVsKFxuICAgICAgc2VsZWN0Rmlyc3QgPyBtZW51LnNlbGVjdEZpcnN0SXRlbSgpIDogbWVudS5kZXNlbGVjdEFsbCgpLFxuICAgICAgcmVmQm94LFxuICAgICksXG4gICAgQ21kLmJhdGNoKFtcbiAgICAgIFRhc2sucGVyZm9ybShnZXRXaW5kb3dEaW1lbnNpb25zLCAoZCkgPT4gZ290V2luZG93RGltZW5zaW9ucyhkKSksXG4gICAgICBUYXNrLnBlcmZvcm0odXVpZCgpLCAodSkgPT4gZ290VXVpZCh1KSksXG4gICAgXSksXG4gIF07XG59XG5cbmZ1bmN0aW9uIHBvc3RPcGVuPFQ+KG1vZGVsOiBNb2RlbDxUPik6IFtNb2RlbDxUPiwgQ21kPE1zZzxUPj5dIHtcbiAgaWYgKG1vZGVsLnV1aWQudHlwZSA9PT0gJ05vdGhpbmcnKSB7XG4gICAgcmV0dXJuIG5vQ21kKG1vZGVsKTtcbiAgfVxuICBpZiAobW9kZWwud2luZG93U2l6ZS50eXBlID09PSAnTm90aGluZycpIHtcbiAgICByZXR1cm4gbm9DbWQobW9kZWwpO1xuICB9XG4gIGNvbnN0IGNtZDogQ21kPE1zZzxUPj4gPSBUYXNrLmF0dGVtcHQoXG4gICAgbWVudVRhc2sobW9kZWwudXVpZC52YWx1ZSkubWFwKChlKSA9PiB7XG4gICAgICBjb25zdCByZWN0ID0gZS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICAgIGNvbnN0IGIgPSBCb3guZnJvbURvbVJlY3QocmVjdCk7XG4gICAgICBsb2coJ3RlYXBvcCcsICdwb3N0T3BlbicsICdtZW51IGJveCcsIGIpO1xuICAgICAgcmV0dXJuIGI7XG4gICAgfSksXG4gICAgKHgpID0+IGdvdE1lbnVCb3goeCksXG4gICk7XG4gIHJldHVybiBbbW9kZWwsIGNtZF07XG59XG5cbmZ1bmN0aW9uIHdpdGhPdXQ8VD4oXG4gIG1hYzogW01vZGVsPFQ+LCBDbWQ8TXNnPFQ+Pl0sXG4gIG91dE1zZzogTWF5YmU8T3V0TXNnPFQ+PiA9IG5vdGhpbmcsXG4pOiBbTW9kZWw8VD4sIENtZDxNc2c8VD4+LCBNYXliZTxPdXRNc2c8VD4+XSB7XG4gIHJldHVybiBbbWFjWzBdLCBtYWNbMV0sIG91dE1zZ107XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB1cGRhdGU8VD4oXG4gIG1zZzogTXNnPFQ+LFxuICBtb2RlbDogTW9kZWw8VD4sXG4pOiBbTW9kZWw8VD4sIENtZDxNc2c8VD4+LCBNYXliZTxPdXRNc2c8VD4+XSB7XG4gIHN3aXRjaCAobXNnLnRhZykge1xuICAgIGNhc2UgJ2dvdC13aW5kb3ctZGltZW5zaW9ucyc6IHtcbiAgICAgIGlmIChtb2RlbC5zdGF0ZS50YWcgPT09ICdvcGVuJykge1xuICAgICAgICByZXR1cm4gd2l0aE91dChub0NtZChtb2RlbCksIGp1c3QoeyB0YWc6ICdyZXF1ZXN0LWNsb3NlJyB9KSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gd2l0aE91dChcbiAgICAgICAgcG9zdE9wZW4oe1xuICAgICAgICAgIC4uLm1vZGVsLFxuICAgICAgICAgIHdpbmRvd1NpemU6IGp1c3QobXNnLmQpLFxuICAgICAgICB9KSxcbiAgICAgICk7XG4gICAgfVxuICAgIGNhc2UgJ3dpbmRvdy1ibHVyJzoge1xuICAgICAgcmV0dXJuIHdpdGhPdXQobm9DbWQobW9kZWwpLCBqdXN0KHsgdGFnOiAncmVxdWVzdC1jbG9zZScgfSkpO1xuICAgIH1cbiAgICBjYXNlICdnb3QtdXVpZCc6IHtcbiAgICAgIHJldHVybiB3aXRoT3V0KFxuICAgICAgICBwb3N0T3Blbih7XG4gICAgICAgICAgLi4ubW9kZWwsXG4gICAgICAgICAgdXVpZDoganVzdChtc2cudXVpZCksXG4gICAgICAgIH0pLFxuICAgICAgKTtcbiAgICB9XG4gICAgY2FzZSAnZ290LW1lbnUtYm94Jzoge1xuICAgICAgaWYgKG1vZGVsLnN0YXRlLnRhZyA9PT0gJ3BsYWNpbmcnKSB7XG4gICAgICAgIGNvbnN0IHN0YXRlID0gbW9kZWwuc3RhdGU7XG4gICAgICAgIHJldHVybiB3aXRoT3V0KFxuICAgICAgICAgIG5vQ21kKFxuICAgICAgICAgICAgbW9kZWwud2luZG93U2l6ZVxuICAgICAgICAgICAgICAubWFwKCh3aW5kb3dTaXplKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgbmV3TW9kZWw6IE1vZGVsPFQ+ID0gbXNnLnIubWF0Y2goXG4gICAgICAgICAgICAgICAgICAobWVudUJveCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBsb2coJ3RlYXBvcCcsICdnb3QtbWVudS1ib3gnLCAnbWVudUJveCcsIG1lbnVCb3gpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBwbGFjZWRCb3ggPSBwbGFjZShcbiAgICAgICAgICAgICAgICAgICAgICB3aW5kb3dTaXplLFxuICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnJlZkJveCxcbiAgICAgICAgICAgICAgICAgICAgICBtZW51Qm94LmQsXG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgIGxvZygndGVhcG9wJywgJ2dvdC1tZW51LWJveCcsICdwbGFjZWRCb3gnLCBwbGFjZWRCb3gpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICAgIC4uLm1vZGVsLFxuICAgICAgICAgICAgICAgICAgICAgIHN0YXRlOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0YWc6ICdvcGVuJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGJveDogcGxhY2VkQm94LFxuICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIH0gYXMgTW9kZWw8VD47XG4gICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgKGVycikgPT4gKHtcbiAgICAgICAgICAgICAgICAgICAgLi4ubW9kZWwsXG4gICAgICAgICAgICAgICAgICAgIGVycm9yOiBqdXN0KGVyciksXG4gICAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIHJldHVybiBuZXdNb2RlbDtcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgLndpdGhEZWZhdWx0KG1vZGVsKSxcbiAgICAgICAgICApLFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgbG9nKCd0ZWFwb3AnLCAnZ290LW1lbnUtYm94JywgJ25vdCBwbGFjaW5nJyk7XG4gICAgICByZXR1cm4gd2l0aE91dChub0NtZChtb2RlbCkpO1xuICAgIH1cblxuICAgIGNhc2UgJ2tleS1kb3duJzoge1xuICAgICAgc3dpdGNoIChtc2cua2V5KSB7XG4gICAgICAgIGNhc2UgJ0VzY2FwZSc6IHtcbiAgICAgICAgICByZXR1cm4gd2l0aE91dChcbiAgICAgICAgICAgIGNvbGxhcHNlTGFzdFN1Yk1lbnUoa2V5Ym9hcmROYXZpZ2F0ZWQobW9kZWwpKSxcbiAgICAgICAgICAgIG1vZGVsLmNoaWxkLmlzTm90aGluZygpID8ganVzdCh7IHRhZzogJ3JlcXVlc3QtY2xvc2UnIH0pIDogbm90aGluZyxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIGNhc2UgJ0Fycm93RG93bic6XG4gICAgICAgIGNhc2UgJ0Fycm93VXAnOiB7XG4gICAgICAgICAgcmV0dXJuIG1hcExhc3RNZW51KGtleWJvYXJkTmF2aWdhdGVkKG1vZGVsKSwgKGxhc3RNb2RlbCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHdpdGhPdXQoXG4gICAgICAgICAgICAgIG5vQ21kKHtcbiAgICAgICAgICAgICAgICAuLi5sYXN0TW9kZWwsXG4gICAgICAgICAgICAgICAgbWVudTogbGFzdE1vZGVsLm1lbnUubW92ZVNlbGVjdGlvbihtc2cua2V5ID09PSAnQXJyb3dEb3duJyksXG4gICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBjYXNlICdBcnJvd0xlZnQnOlxuICAgICAgICAgIHJldHVybiB3aXRoT3V0KGNvbGxhcHNlTGFzdFN1Yk1lbnUoa2V5Ym9hcmROYXZpZ2F0ZWQobW9kZWwpKSk7XG4gICAgICAgIGNhc2UgJ0Fycm93UmlnaHQnOlxuICAgICAgICAgIHJldHVybiBleHBhbmRMYXN0U3ViTWVudShrZXlib2FyZE5hdmlnYXRlZChtb2RlbCkpO1xuICAgICAgICBjYXNlICdFbnRlcic6XG4gICAgICAgIGNhc2UgJyAnOiB7XG4gICAgICAgICAgcmV0dXJuIHRvZ2dsZU9yU2VsZWN0SXRlbShtb2RlbCk7XG4gICAgICAgIH1cbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICByZXR1cm4gd2l0aE91dChub0NtZChtb2RlbCkpO1xuICAgICAgfVxuICAgIH1cbiAgICBjYXNlICdtb3VzZS1tb3ZlJzoge1xuICAgICAgaWYgKG1vZGVsLm1lbnUuaXNTZWxlY3RlZChtc2cuaXRlbSkpIHtcbiAgICAgICAgcmV0dXJuIHdpdGhPdXQobm9DbWQobW9kZWwpKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IG5ld01vZGVsID0geyAuLi5tb2RlbCwgc3ViTWVudUNvdW50ZXI6IG1vZGVsLnN1Yk1lbnVDb3VudGVyICsgMSB9O1xuICAgICAgaWYgKG1vZGVsLm5hdmlnYXRlZFdpdGhLZXlib2FyZCkge1xuICAgICAgICByZXR1cm4gd2l0aE91dChub0NtZChrZXlib2FyZE5hdmlnYXRlZChuZXdNb2RlbCwgZmFsc2UpKSk7XG4gICAgICB9XG4gICAgICBpZiAobW9kZWwudXVpZC50eXBlID09PSAnTm90aGluZycpIHtcbiAgICAgICAgcmV0dXJuIHdpdGhPdXQobm9DbWQobmV3TW9kZWwpKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IG1lbnUgPSBtb2RlbC5tZW51LnNlbGVjdEl0ZW0obXNnLml0ZW0pO1xuICAgICAgY29uc3QgdXVpZCA9IG1vZGVsLnV1aWQudmFsdWU7XG4gICAgICByZXR1cm4gd2l0aE91dChcbiAgICAgICAgb3BlblN1Yk1lbnUoXG4gICAgICAgICAgeyAuLi5uZXdNb2RlbCwgbWVudSwgY2hpbGQ6IG5vdGhpbmcgfSxcbiAgICAgICAgICB1dWlkLFxuICAgICAgICAgIG1zZy5pdGVtLFxuICAgICAgICAgIG1zZy5pdGVtSW5kZXgsXG4gICAgICAgICAgZmFsc2UsXG4gICAgICAgICksXG4gICAgICApO1xuICAgIH1cbiAgICBjYXNlICdtb3VzZS1sZWF2ZSc6IHtcbiAgICAgIHJldHVybiB3aXRoT3V0KFxuICAgICAgICBub0NtZChcbiAgICAgICAgICBtb2RlbC5jaGlsZC5pc0p1c3QoKVxuICAgICAgICAgICAgPyBtb2RlbFxuICAgICAgICAgICAgOiB7IC4uLm1vZGVsLCBtZW51OiBtb2RlbC5tZW51LmRlc2VsZWN0QWxsKCkgfSxcbiAgICAgICAgKSxcbiAgICAgICk7XG4gICAgfVxuICAgIGNhc2UgJ2dvdC1pdGVtLWJveCc6IHtcbiAgICAgIGlmIChtc2cuc3ViTWVudUNvdW50ZXIgIT09IG1vZGVsLnN1Yk1lbnVDb3VudGVyKSB7XG4gICAgICAgIHJldHVybiB3aXRoT3V0KG5vQ21kKG1vZGVsKSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gd2l0aE91dChcbiAgICAgICAgbXNnLnIubWF0Y2goXG4gICAgICAgICAgKGl0ZW1Cb3gpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG5ld01vZGVsOiBNb2RlbDxUPiA9IHtcbiAgICAgICAgICAgICAgLi4ubW9kZWwsXG4gICAgICAgICAgICAgIG1lbnU6IG1vZGVsLm1lbnUuc2VsZWN0SXRlbShtc2cuaXRlbSksXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcmV0dXJuIG1zZy5pdGVtLnN1Yk1lbnVcbiAgICAgICAgICAgICAgLm1hcCgoc3ViTWVudSkgPT4ge1xuICAgICAgICAgICAgICAgIC8vIHdlIGhhdmUgYSBzdWIgbWVudSBzbyB3ZSBuZWVkXG4gICAgICAgICAgICAgICAgLy8gdG8gb3BlbiBhIG5ldyBNZW51ICFcbiAgICAgICAgICAgICAgICBjb25zdCBtYWMgPSBvcGVuKHN1Yk1lbnUsIGl0ZW1Cb3gsIG1zZy5zZWxlY3RGaXJzdCk7XG4gICAgICAgICAgICAgICAgY29uc3QgbmV3TW9kZWwyOiBNb2RlbDxUPiA9IHtcbiAgICAgICAgICAgICAgICAgIC4uLm5ld01vZGVsLFxuICAgICAgICAgICAgICAgICAgY2hpbGQ6IGp1c3QobWFjWzBdKSxcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIHJldHVybiBUdXBsZS50Mm4obmV3TW9kZWwyLCBtYWNbMV0ubWFwKGNoaWxkTXNnKSk7XG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgIC53aXRoRGVmYXVsdFN1cHBseSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgLy8gY2xvc2UgYW55IGV4aXN0aW5nIGNoaWxkICFcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3TW9kZWwuY2hpbGRcbiAgICAgICAgICAgICAgICAgIC5tYXAoKCkgPT5cbiAgICAgICAgICAgICAgICAgICAgbm9DbWQ8TW9kZWw8VD4sIE1zZzxUPj4oeyAuLi5tb2RlbCwgY2hpbGQ6IG5vdGhpbmcgfSksXG4gICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAud2l0aERlZmF1bHRTdXBwbHkoKCkgPT4gbm9DbWQobW9kZWwpKTtcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSxcbiAgICAgICAgICAoZXJyKSA9PiBub0NtZCh7IC4uLm1vZGVsLCBlcnJvcjoganVzdChlcnIpIH0pLFxuICAgICAgICApLFxuICAgICAgKTtcbiAgICB9XG4gICAgY2FzZSAnY2hpbGQtbXNnJzoge1xuICAgICAgcmV0dXJuIG1vZGVsLmNoaWxkXG4gICAgICAgIC5tYXAoKGNoaWxkKSA9PiB7XG4gICAgICAgICAgY29uc3QgbWNvID0gdXBkYXRlKG1zZy5tLCBjaGlsZCk7XG4gICAgICAgICAgY29uc3QgbmV3TW9kZWw6IE1vZGVsPFQ+ID0ge1xuICAgICAgICAgICAgLi4ubW9kZWwsXG4gICAgICAgICAgICBjaGlsZDoganVzdChtY29bMF0pLFxuICAgICAgICAgIH07XG4gICAgICAgICAgcmV0dXJuIHdpdGhPdXQoVHVwbGUudDJuKG5ld01vZGVsLCBtY29bMV0ubWFwKGNoaWxkTXNnKSksIG1jb1syXSk7XG4gICAgICAgIH0pXG4gICAgICAgIC53aXRoRGVmYXVsdFN1cHBseSgoKSA9PiB3aXRoT3V0KG5vQ21kKG1vZGVsKSkpO1xuICAgIH1cbiAgICBjYXNlICdpdGVtLWNsaWNrZWQnOiB7XG4gICAgICByZXR1cm4gd2l0aE91dChub0NtZChtb2RlbCksIG91dEl0ZW1TZWxlY3RlZChtc2cuaXRlbSkpO1xuICAgIH1cbiAgICBjYXNlICdkb2MtbW91c2UtZG93bic6IHtcbiAgICAgIHJldHVybiB3aXRoT3V0KG5vQ21kKG1vZGVsKSwganVzdCh7IHRhZzogJ3JlcXVlc3QtY2xvc2UnIH0pKTtcbiAgICB9XG4gICAgY2FzZSAnbm9vcCc6IHtcbiAgICAgIHJldHVybiB3aXRoT3V0KG5vQ21kKG1vZGVsKSk7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIG91dEl0ZW1TZWxlY3RlZDxUPihpdGVtOiBNZW51SXRlbTxUPik6IE1heWJlPE91dE1zZzxUPj4ge1xuICByZXR1cm4ganVzdCh7IHRhZzogJ2l0ZW0tc2VsZWN0ZWQnLCBkYXRhOiBpdGVtLnVzZXJEYXRhIH0pO1xufVxuXG5mdW5jdGlvbiBvcGVuU3ViTWVudTxUPihcbiAgbW9kZWw6IE1vZGVsPFQ+LFxuICBtZW51SWQ6IHN0cmluZyxcbiAgaXRlbTogTWVudUl0ZW08VD4sXG4gIGl0ZW1JbmRleDogbnVtYmVyLFxuICBzZWxlY3RGaXJzdDogYm9vbGVhbixcbik6IFtNb2RlbDxUPiwgQ21kPE1zZzxUPj5dIHtcbiAgaWYgKGl0ZW0uc3ViTWVudS5pc05vdGhpbmcoKSkge1xuICAgIHJldHVybiBub0NtZChtb2RlbCk7XG4gIH1cbiAgY29uc3Qgc3ViTWVudUNvdW50ZXIgPSBtb2RlbC5zdWJNZW51Q291bnRlciArIDE7XG4gIHJldHVybiBUdXBsZS50Mm4oXG4gICAgeyAuLi5tb2RlbCwgc3ViTWVudUNvdW50ZXIgfSxcbiAgICBUYXNrLmF0dGVtcHQoXG4gICAgICBtZW51SXRlbVRhc2sobWVudUlkLCBpdGVtSW5kZXgpLm1hcCgoZSkgPT4ge1xuICAgICAgICByZXR1cm4gQm94LmZyb21Eb21SZWN0KGUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkpO1xuICAgICAgfSksXG4gICAgICAocikgPT4gZ290SXRlbUJveChpdGVtLCByLCBzdWJNZW51Q291bnRlciwgc2VsZWN0Rmlyc3QpLFxuICAgICksXG4gICk7XG59XG5cbmNvbnN0IHdpbmRvd0V2ZW50cyA9IG5ldyBXaW5kb3dFdmVudHMoKTtcbmNvbnN0IGRvY3VtZW50RXZlbnRzID0gbmV3IERvY3VtZW50RXZlbnRzKCk7XG5cbmV4cG9ydCBmdW5jdGlvbiBzdWJzY3JpcHRpb25zPFQ+KG1vZGVsOiBNb2RlbDxUPik6IFN1YjxNc2c8VD4+IHtcbiAgcmV0dXJuIFN1Yi5iYXRjaChbXG4gICAgd2luZG93RXZlbnRzLm9uKCdyZXNpemUnLCAoKSA9PlxuICAgICAgZ290V2luZG93RGltZW5zaW9ucyhkaW0od2luZG93LmlubmVyV2lkdGgsIHdpbmRvdy5pbm5lckhlaWdodCkpLFxuICAgICksXG4gICAgd2luZG93RXZlbnRzLm9uKCdibHVyJywgKCkgPT4gZ290d2luZG93Qmx1cigpKSxcbiAgICBkb2N1bWVudEV2ZW50cy5vbihcbiAgICAgICdtb3VzZWRvd24nLFxuICAgICAgKGV2dCkgPT4ge1xuICAgICAgICBpZiAoZXZ0LmJ1dHRvbiA9PT0gMikge1xuICAgICAgICAgIHJldHVybiBub29wKCk7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IHQ6IEhUTUxFbGVtZW50IHwgbnVsbCA9IGV2dC50YXJnZXQgYXMgSFRNTEVsZW1lbnQ7XG4gICAgICAgIHdoaWxlICh0KSB7XG4gICAgICAgICAgLy8gbW92ZSB1cCBhbmQgdHJ5IHRvIGZpbmQgaWYgd2UgYXJlIGluc2lkZSBhIHRlYS1wb3AgTWVudSAhXG4gICAgICAgICAgaWYgKHQuY2xhc3NMaXN0LmNvbnRhaW5zKCd0bScpKSB7XG4gICAgICAgICAgICByZXR1cm4gbm9vcCgpO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0ID0gdC5wYXJlbnRFbGVtZW50O1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBkb2NNb3VzZURvd24oKTtcbiAgICAgIH0sXG4gICAgICB0cnVlLFxuICAgICksXG4gICAgbW9kZWwuc3RhdGUudGFnID09PSAnb3BlbidcbiAgICAgID8gZG9jdW1lbnRFdmVudHMub24oJ2tleWRvd24nLCAoZSkgPT4gZ290S2V5RG93bihlLmtleSkpXG4gICAgICA6IFN1Yi5ub25lKCksXG4gIF0pO1xufVxuXG5jb25zdCBnZXRXaW5kb3dEaW1lbnNpb25zOiBUYXNrPG5ldmVyLCBEaW0+ID0gVGFzay5zdWNjZWVkTGF6eSgoKSA9PlxuICBkaW0od2luZG93LmlubmVyV2lkdGgsIHdpbmRvdy5pbm5lckhlaWdodCksXG4pO1xuXG5mdW5jdGlvbiBtYXBMYXN0TWVudTxUPihcbiAgbW9kZWw6IE1vZGVsPFQ+LFxuICBmOiAobTogTW9kZWw8VD4pID0+IFtNb2RlbDxUPiwgQ21kPE1zZzxUPj4sIE1heWJlPE91dE1zZzxUPj5dLFxuKTogW01vZGVsPFQ+LCBDbWQ8TXNnPFQ+PiwgTWF5YmU8T3V0TXNnPFQ+Pl0ge1xuICBzd2l0Y2ggKG1vZGVsLmNoaWxkLnR5cGUpIHtcbiAgICBjYXNlICdOb3RoaW5nJzoge1xuICAgICAgLy8gSSdtIHRoZSBsYXN0IG1vZGVsICFcbiAgICAgIHJldHVybiBmKG1vZGVsKTtcbiAgICB9XG4gICAgY2FzZSAnSnVzdCc6IHtcbiAgICAgIGNvbnN0IG1hYyA9IG1hcExhc3RNZW51KG1vZGVsLmNoaWxkLnZhbHVlLCBmKTtcbiAgICAgIHJldHVybiBbeyAuLi5tb2RlbCwgY2hpbGQ6IGp1c3QobWFjWzBdKSB9LCBtYWNbMV0ubWFwKGNoaWxkTXNnKSwgbWFjWzJdXTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gY29sbGFwc2VMYXN0U3ViTWVudTxUPihtb2RlbDogTW9kZWw8VD4pOiBbTW9kZWw8VD4sIENtZDxNc2c8VD4+XSB7XG4gIHN3aXRjaCAobW9kZWwuY2hpbGQudHlwZSkge1xuICAgIGNhc2UgJ05vdGhpbmcnOlxuICAgICAgcmV0dXJuIG5vQ21kKG1vZGVsKTtcbiAgICBjYXNlICdKdXN0Jzoge1xuICAgICAgLy8gSSBoYXZlIGEgY2hpbGQgOiBjbG9zZSBpdCBpZiBoZSBoYXMgbm8gY2hpbGQgIVxuICAgICAgY29uc3QgY2hpbGQgPSBtb2RlbC5jaGlsZC52YWx1ZTtcbiAgICAgIGlmIChjaGlsZC5jaGlsZC5pc0p1c3QoKSkge1xuICAgICAgICByZXR1cm4gVHVwbGUuZnJvbU5hdGl2ZShjb2xsYXBzZUxhc3RTdWJNZW51KGNoaWxkKSlcbiAgICAgICAgICAubWFwRmlyc3QoKGMpID0+ICh7IC4uLm1vZGVsLCBjaGlsZDoganVzdChjKSB9KSlcbiAgICAgICAgICAubWFwU2Vjb25kKChjbWQpID0+IGNtZC5tYXAoY2hpbGRNc2cpKVxuICAgICAgICAgIC50b05hdGl2ZSgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIG5vQ21kKHtcbiAgICAgICAgICAuLi5tb2RlbCxcbiAgICAgICAgICBjaGlsZDogbm90aGluZyxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIGV4cGFuZExhc3RTdWJNZW51PFQ+KFxuICBtb2RlbDogTW9kZWw8VD4sXG4pOiBbTW9kZWw8VD4sIENtZDxNc2c8VD4+LCBNYXliZTxPdXRNc2c8VD4+XSB7XG4gIHJldHVybiBtYXBMYXN0TWVudShtb2RlbCwgKGxhc3RNb2RlbCkgPT4ge1xuICAgIHJldHVybiBsYXN0TW9kZWwubWVudS5zZWxlY3RlZEl0ZW1cbiAgICAgIC5tYXAoKHNlbGVjdGVkSXRlbSkgPT4ge1xuICAgICAgICByZXR1cm4gc2VsZWN0ZWRJdGVtLnN1Yk1lbnVcbiAgICAgICAgICAubWFwKCgpID0+IHtcbiAgICAgICAgICAgIGlmIChsYXN0TW9kZWwudXVpZC50eXBlID09PSAnTm90aGluZycpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHdpdGhPdXQobm9DbWQ8TW9kZWw8VD4sIE1zZzxUPj4obGFzdE1vZGVsKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCB1dWlkID0gbGFzdE1vZGVsLnV1aWQudmFsdWU7XG4gICAgICAgICAgICBjb25zdCBtYWM6IFtNb2RlbDxUPiwgQ21kPE1zZzxUPj5dID0gbGFzdE1vZGVsLm1lbnVcbiAgICAgICAgICAgICAgLmluZGV4T2ZJdGVtKHNlbGVjdGVkSXRlbSlcbiAgICAgICAgICAgICAgLm1hcCgoaXRlbUluZGV4KSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG9wZW5TdWJNZW51KFxuICAgICAgICAgICAgICAgICAgbGFzdE1vZGVsLFxuICAgICAgICAgICAgICAgICAgdXVpZCxcbiAgICAgICAgICAgICAgICAgIHNlbGVjdGVkSXRlbSxcbiAgICAgICAgICAgICAgICAgIGl0ZW1JbmRleCxcbiAgICAgICAgICAgICAgICAgIHRydWUsXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgLndpdGhEZWZhdWx0U3VwcGx5KCgpID0+IG5vQ21kKGxhc3RNb2RlbCkpO1xuICAgICAgICAgICAgcmV0dXJuIHdpdGhPdXQobWFjKTtcbiAgICAgICAgICB9KVxuICAgICAgICAgIC53aXRoRGVmYXVsdFN1cHBseSgoKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gd2l0aE91dChub0NtZChsYXN0TW9kZWwpKTtcbiAgICAgICAgICB9KTtcbiAgICAgIH0pXG4gICAgICAud2l0aERlZmF1bHRTdXBwbHkoKCkgPT4ge1xuICAgICAgICByZXR1cm4gd2l0aE91dChub0NtZChsYXN0TW9kZWwpKTtcbiAgICAgIH0pO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gdG9nZ2xlT3JTZWxlY3RJdGVtPFQ+KFxuICBtb2RlbDogTW9kZWw8VD4sXG4pOiBbTW9kZWw8VD4sIENtZDxNc2c8VD4+LCBNYXliZTxPdXRNc2c8VD4+XSB7XG4gIHJldHVybiBtYXBMYXN0TWVudShtb2RlbCwgKGxhc3RNb2RlbCkgPT4ge1xuICAgIHJldHVybiBsYXN0TW9kZWwubWVudS5zZWxlY3RlZEl0ZW1cbiAgICAgIC5tYXAoKHNlbGVjdGVkSXRlbSkgPT4ge1xuICAgICAgICBpZiAobGFzdE1vZGVsLnV1aWQudHlwZSA9PT0gJ05vdGhpbmcnKSB7XG4gICAgICAgICAgcmV0dXJuIHdpdGhPdXQobm9DbWQ8TW9kZWw8VD4sIE1zZzxUPj4obGFzdE1vZGVsKSk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdXVpZCA9IGxhc3RNb2RlbC51dWlkLnZhbHVlO1xuICAgICAgICAvLyBkbyB3ZSBoYXZlIGEgc3ViLW1lbnUgP1xuICAgICAgICByZXR1cm4gc2VsZWN0ZWRJdGVtLnN1Yk1lbnVcbiAgICAgICAgICAubWFwKCgpID0+IHtcbiAgICAgICAgICAgIC8vIHdlIGhhdmUgYSBzdWItbWVudSwgZXhwYW5kIGl0XG4gICAgICAgICAgICBjb25zdCBtYWM6IFtNb2RlbDxUPiwgQ21kPE1zZzxUPj5dID0gbGFzdE1vZGVsLm1lbnVcbiAgICAgICAgICAgICAgLmluZGV4T2ZJdGVtKHNlbGVjdGVkSXRlbSlcbiAgICAgICAgICAgICAgLm1hcCgoaXRlbUluZGV4KSA9PlxuICAgICAgICAgICAgICAgIG9wZW5TdWJNZW51KGxhc3RNb2RlbCwgdXVpZCwgc2VsZWN0ZWRJdGVtLCBpdGVtSW5kZXgsIHRydWUpLFxuICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgIC53aXRoRGVmYXVsdFN1cHBseSgoKSA9PiBub0NtZChsYXN0TW9kZWwpKTtcbiAgICAgICAgICAgIHJldHVybiB3aXRoT3V0KG1hYyk7XG4gICAgICAgICAgfSlcbiAgICAgICAgICAud2l0aERlZmF1bHRTdXBwbHkoKCkgPT4ge1xuICAgICAgICAgICAgLy8gbm8gc3ViLW1lbnUsIHNlbGVjdCB0aGUgaXRlbVxuICAgICAgICAgICAgcmV0dXJuIHdpdGhPdXQobm9DbWQobGFzdE1vZGVsKSwgb3V0SXRlbVNlbGVjdGVkKHNlbGVjdGVkSXRlbSkpO1xuICAgICAgICAgIH0pO1xuICAgICAgfSlcbiAgICAgIC53aXRoRGVmYXVsdFN1cHBseSgoKSA9PiB3aXRoT3V0KG5vQ21kKGxhc3RNb2RlbCkpKTtcbiAgfSk7XG59XG4iXX0=
"use strict";
/*
 * MIT License
 *
 * Copyright (c) 2020 RÃ©mi Van Keisbelck
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.menuItemTask = exports.menuTask = exports.menuItemId = exports.menuId = exports.separator = exports.item = exports.menu = exports.Menu = void 0;
const tea_cup_core_1 = require("tea-cup-core");
class Menu {
    constructor(elements) {
        this.elements = elements;
    }
    selectFirstItem() {
        return new Menu(this.elements.selectIndex(0));
    }
    selectItem(item) {
        return new Menu(this.elements.select((e) => e === item));
    }
    deselectAll() {
        return new Menu(tea_cup_core_1.ListWithSelection.fromArray(this.elements.toArray()));
    }
    get elems() {
        return this.elements.toArray();
    }
    get selectedItem() {
        const selected = this.elements.getSelected();
        if (selected.type === 'Just' && selected.value.tag === 'item') {
            return tea_cup_core_1.just(selected.value);
        }
        return tea_cup_core_1.nothing;
    }
    isSelected(item) {
        return this.elements.isSelected(item);
    }
    findNextItemIndex(start) {
        const elems = this.elems;
        const s = start === elems.length - 1 ? 0 : start + 1;
        for (let i = s; i < elems.length; i++) {
            if (elems[i].tag === 'item') {
                return tea_cup_core_1.just(i);
            }
        }
        return tea_cup_core_1.nothing;
    }
    findPreviousItemIndex(start) {
        const elems = this.elems;
        const s = start === 0 ? elems.length - 1 : start - 1;
        for (let i = s; i >= 0; i--) {
            if (elems[i].tag === 'item') {
                return tea_cup_core_1.just(i);
            }
        }
        return tea_cup_core_1.nothing;
    }
    moveSelection(down) {
        return this.elements
            .getSelectedIndex()
            .map((selectedIndex) => {
            const mbNextIndex = down
                ? this.findNextItemIndex(selectedIndex)
                : this.findPreviousItemIndex(selectedIndex);
            return mbNextIndex
                .map((nextIndex) => new Menu(this.elements.selectIndex(nextIndex)))
                .withDefault(this);
        })
            .withDefaultSupply(() => {
            return new Menu(this.elements.selectIndex(down ? 0 : this.elements.length() - 1));
        });
    }
    indexOfItem(item) {
        const i = this.elements.toArray().indexOf(item);
        if (i === -1) {
            return tea_cup_core_1.nothing;
        }
        return tea_cup_core_1.just(i);
    }
}
exports.Menu = Menu;
function menu(items) {
    return new Menu(tea_cup_core_1.ListWithSelection.fromArray(items));
}
exports.menu = menu;
function item(userData, subMenu) {
    return {
        tag: 'item',
        userData,
        subMenu: tea_cup_core_1.maybeOf(subMenu),
    };
}
exports.item = item;
exports.separator = {
    tag: 'separator',
};
function menuId(uuid) {
    return `tm-${btoa(uuid)}`;
}
exports.menuId = menuId;
function menuItemId(menuId, itemIndex) {
    return `tm-item-${menuId}-${itemIndex}`;
}
exports.menuItemId = menuItemId;
function menuTask(uuid) {
    return byId(menuId(uuid));
}
exports.menuTask = menuTask;
function menuItemTask(menuId, itemIndex) {
    return byId(menuItemId(menuId, itemIndex));
}
exports.menuItemTask = menuItemTask;
function byId(id) {
    return tea_cup_core_1.Task.fromLambda(() => {
        const e = document.getElementById(id);
        if (e === null) {
            throw new Error('element not found with id:' + id);
        }
        return e;
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWVudS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9NZW51LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0F1Qkc7OztBQUVILCtDQU9zQjtBQUV0QixNQUFhLElBQUk7SUFDZixZQUE2QixRQUEyQztRQUEzQyxhQUFRLEdBQVIsUUFBUSxDQUFtQztJQUFHLENBQUM7SUFFNUUsZUFBZTtRQUNiLE9BQU8sSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNoRCxDQUFDO0lBRUQsVUFBVSxDQUFDLElBQWlCO1FBQzFCLE9BQU8sSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQzNELENBQUM7SUFFRCxXQUFXO1FBQ1QsT0FBTyxJQUFJLElBQUksQ0FBQyxnQ0FBaUIsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDeEUsQ0FBQztJQUVELElBQUksS0FBSztRQUNQLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUNqQyxDQUFDO0lBRUQsSUFBSSxZQUFZO1FBQ2QsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUM3QyxJQUFJLFFBQVEsQ0FBQyxJQUFJLEtBQUssTUFBTSxJQUFJLFFBQVEsQ0FBQyxLQUFLLENBQUMsR0FBRyxLQUFLLE1BQU0sRUFBRTtZQUM3RCxPQUFPLG1CQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQzdCO1FBQ0QsT0FBTyxzQkFBTyxDQUFDO0lBQ2pCLENBQUM7SUFFRCxVQUFVLENBQUMsSUFBaUI7UUFD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aWNlbnNlXG4gKlxuICogQ29weXJpZ2h0IChjKSAyMDIwIFLDqW1pIFZhbiBLZWlzYmVsY2tcbiAqXG4gKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5XG4gKiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSBcIlNvZnR3YXJlXCIpLCB0byBkZWFsXG4gKiBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzXG4gKiB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsXG4gKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXNcbiAqIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6XG4gKlxuICogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4gYWxsXG4gKiBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLlxuICpcbiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1JcbiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxuICogRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFXG4gKiBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXG4gKiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxuICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEVcbiAqIFNPRlRXQVJFLlxuICpcbiAqL1xuXG5pbXBvcnQge1xuICBqdXN0LFxuICBMaXN0V2l0aFNlbGVjdGlvbixcbiAgTWF5YmUsXG4gIG1heWJlT2YsXG4gIG5vdGhpbmcsXG4gIFRhc2ssXG59IGZyb20gJ3RlYS1jdXAtY29yZSc7XG5cbmV4cG9ydCBjbGFzcyBNZW51PFQ+IHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBlbGVtZW50czogTGlzdFdpdGhTZWxlY3Rpb248TWVudUVsZW1lbnQ8VD4+KSB7fVxuXG4gIHNlbGVjdEZpcnN0SXRlbSgpOiBNZW51PFQ+IHtcbiAgICByZXR1cm4gbmV3IE1lbnUodGhpcy5lbGVtZW50cy5zZWxlY3RJbmRleCgwKSk7XG4gIH1cblxuICBzZWxlY3RJdGVtKGl0ZW06IE1lbnVJdGVtPFQ+KTogTWVudTxUPiB7XG4gICAgcmV0dXJuIG5ldyBNZW51KHRoaXMuZWxlbWVudHMuc2VsZWN0KChlKSA9PiBlID09PSBpdGVtKSk7XG4gIH1cblxuICBkZXNlbGVjdEFsbCgpOiBNZW51PFQ+IHtcbiAgICByZXR1cm4gbmV3IE1lbnUoTGlzdFdpdGhTZWxlY3Rpb24uZnJvbUFycmF5KHRoaXMuZWxlbWVudHMudG9BcnJheSgpKSk7XG4gIH1cblxuICBnZXQgZWxlbXMoKTogUmVhZG9ubHlBcnJheTxNZW51RWxlbWVudDxUPj4ge1xuICAgIHJldHVybiB0aGlzLmVsZW1lbnRzLnRvQXJyYXkoKTtcbiAgfVxuXG4gIGdldCBzZWxlY3RlZEl0ZW0oKTogTWF5YmU8TWVudUl0ZW08VD4+IHtcbiAgICBjb25zdCBzZWxlY3RlZCA9IHRoaXMuZWxlbWVudHMuZ2V0U2VsZWN0ZWQoKTtcbiAgICBpZiAoc2VsZWN0ZWQudHlwZSA9PT0gJ0p1c3QnICYmIHNlbGVjdGVkLnZhbHVlLnRhZyA9PT0gJ2l0ZW0nKSB7XG4gICAgICByZXR1cm4ganVzdChzZWxlY3RlZC52YWx1ZSk7XG4gICAgfVxuICAgIHJldHVybiBub3RoaW5nO1xuICB9XG5cbiAgaXNTZWxlY3RlZChpdGVtOiBNZW51SXRlbTxUPik6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmVsZW1lbnRzLmlzU2VsZWN0ZWQoaXRlbSk7XG4gIH1cblxuICBwcml2YXRlIGZpbmROZXh0SXRlbUluZGV4KHN0YXJ0OiBudW1iZXIpOiBNYXliZTxudW1iZXI+IHtcbiAgICBjb25zdCBlbGVtcyA9IHRoaXMuZWxlbXM7XG4gICAgY29uc3QgcyA9IHN0YXJ0ID09PSBlbGVtcy5sZW5ndGggLSAxID8gMCA6IHN0YXJ0ICsgMTtcbiAgICBmb3IgKGxldCBpID0gczsgaSA8IGVsZW1zLmxlbmd0aDsgaSsrKSB7XG4gICAgICBpZiAoZWxlbXNbaV0udGFnID09PSAnaXRlbScpIHtcbiAgICAgICAgcmV0dXJuIGp1c3QoaSk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBub3RoaW5nO1xuICB9XG5cbiAgcHJpdmF0ZSBmaW5kUHJldmlvdXNJdGVtSW5kZXgoc3RhcnQ6IG51bWJlcik6IE1heWJlPG51bWJlcj4ge1xuICAgIGNvbnN0IGVsZW1zID0gdGhpcy5lbGVtcztcbiAgICBjb25zdCBzID0gc3RhcnQgPT09IDAgPyBlbGVtcy5sZW5ndGggLSAxIDogc3RhcnQgLSAxO1xuICAgIGZvciAobGV0IGkgPSBzOyBpID49IDA7IGktLSkge1xuICAgICAgaWYgKGVsZW1zW2ldLnRhZyA9PT0gJ2l0ZW0nKSB7XG4gICAgICAgIHJldHVybiBqdXN0KGkpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbm90aGluZztcbiAgfVxuXG4gIG1vdmVTZWxlY3Rpb24oZG93bjogYm9vbGVhbik6IE1lbnU8VD4ge1xuICAgIHJldHVybiB0aGlzLmVsZW1lbnRzXG4gICAgICAuZ2V0U2VsZWN0ZWRJbmRleCgpXG4gICAgICAubWFwKChzZWxlY3RlZEluZGV4KSA9PiB7XG4gICAgICAgIGNvbnN0IG1iTmV4dEluZGV4ID0gZG93blxuICAgICAgICAgID8gdGhpcy5maW5kTmV4dEl0ZW1JbmRleChzZWxlY3RlZEluZGV4KVxuICAgICAgICAgIDogdGhpcy5maW5kUHJldmlvdXNJdGVtSW5kZXgoc2VsZWN0ZWRJbmRleCk7XG4gICAgICAgIHJldHVybiBtYk5leHRJbmRleFxuICAgICAgICAgIC5tYXAoKG5leHRJbmRleCkgPT4gbmV3IE1lbnUodGhpcy5lbGVtZW50cy5zZWxlY3RJbmRleChuZXh0SW5kZXgpKSlcbiAgICAgICAgICAud2l0aERlZmF1bHQodGhpcyk7XG4gICAgICB9KVxuICAgICAgLndpdGhEZWZhdWx0U3VwcGx5KCgpID0+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBNZW51KFxuICAgICAgICAgIHRoaXMuZWxlbWVudHMuc2VsZWN0SW5kZXgoZG93biA/IDAgOiB0aGlzLmVsZW1lbnRzLmxlbmd0aCgpIC0gMSksXG4gICAgICAgICk7XG4gICAgICB9KTtcbiAgfVxuXG4gIGluZGV4T2ZJdGVtKGl0ZW06IE1lbnVJdGVtPFQ+KTogTWF5YmU8bnVtYmVyPiB7XG4gICAgY29uc3QgaSA9IHRoaXMuZWxlbWVudHMudG9BcnJheSgpLmluZGV4T2YoaXRlbSk7XG4gICAgaWYgKGkgPT09IC0xKSB7XG4gICAgICByZXR1cm4gbm90aGluZztcbiAgICB9XG4gICAgcmV0dXJuIGp1c3QoaSk7XG4gIH1cbn1cblxuZXhwb3J0IHR5cGUgTWVudUVsZW1lbnQ8VD4gPSBNZW51SXRlbTxUPiB8IE1lbnVTZXBhcmF0b3I7XG5cbmV4cG9ydCBpbnRlcmZhY2UgTWVudUl0ZW08VD4ge1xuICB0YWc6ICdpdGVtJztcbiAgcmVhZG9ubHkgdXNlckRhdGE6IFQ7XG4gIHJlYWRvbmx5IHN1Yk1lbnU6IE1heWJlPE1lbnU8VD4+O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIE1lbnVTZXBhcmF0b3Ige1xuICB0YWc6ICdzZXBhcmF0b3InO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbWVudTxUPihpdGVtczogUmVhZG9ubHlBcnJheTxNZW51RWxlbWVudDxUPj4pOiBNZW51PFQ+IHtcbiAgcmV0dXJuIG5ldyBNZW51KExpc3RXaXRoU2VsZWN0aW9uLmZyb21BcnJheShpdGVtcykpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXRlbTxUPih1c2VyRGF0YTogVCwgc3ViTWVudT86IE1lbnU8VD4pOiBNZW51SXRlbTxUPiB7XG4gIHJldHVybiB7XG4gICAgdGFnOiAnaXRlbScsXG4gICAgdXNlckRhdGEsXG4gICAgc3ViTWVudTogbWF5YmVPZihzdWJNZW51KSxcbiAgfTtcbn1cblxuZXhwb3J0IGNvbnN0IHNlcGFyYXRvcjogTWVudVNlcGFyYXRvciA9IHtcbiAgdGFnOiAnc2VwYXJhdG9yJyxcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBtZW51SWQodXVpZDogc3RyaW5nKTogc3RyaW5nIHtcbiAgcmV0dXJuIGB0bS0ke2J0b2EodXVpZCl9YDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1lbnVJdGVtSWQobWVudUlkOiBzdHJpbmcsIGl0ZW1JbmRleDogbnVtYmVyKTogc3RyaW5nIHtcbiAgcmV0dXJuIGB0bS1pdGVtLSR7bWVudUlkfS0ke2l0ZW1JbmRleH1gO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbWVudVRhc2sodXVpZDogc3RyaW5nKTogVGFzazxFcnJvciwgSFRNTEVsZW1lbnQ+IHtcbiAgcmV0dXJuIGJ5SWQobWVudUlkKHV1aWQpKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1lbnVJdGVtVGFzayhcbiAgbWVudUlkOiBzdHJpbmcsXG4gIGl0ZW1JbmRleDogbnVtYmVyLFxuKTogVGFzazxFcnJvciwgSFRNTEVsZW1lbnQ+IHtcbiAgcmV0dXJuIGJ5SWQobWVudUl0ZW1JZChtZW51SWQsIGl0ZW1JbmRleCkpO1xufVxuXG5mdW5jdGlvbiBieUlkKGlkOiBzdHJpbmcpOiBUYXNrPEVycm9yLCBIVE1MRWxlbWVudD4ge1xuICByZXR1cm4gVGFzay5mcm9tTGFtYmRhKCgpID0+IHtcbiAgICBjb25zdCBlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpO1xuICAgIGlmIChlID09PSBudWxsKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2VsZW1lbnQgbm90IGZvdW5kIHdpdGggaWQ6JyArIGlkKTtcbiAgICB9XG4gICAgcmV0dXJuIGU7XG4gIH0pO1xufVxuIl19
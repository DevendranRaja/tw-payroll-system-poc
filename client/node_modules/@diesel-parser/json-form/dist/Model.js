"use strict";
/*
 * Copyright 2018 The Diesel Authors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getFormats = exports.getProposals = exports.updateAddingPropertyName = exports.computeAll = exports.initialModel = exports.computeStringsMetadata = exports.computePropertiesToAdd = exports.computeErrors = exports.doValidate = void 0;
const tea_cup_core_1 = require("tea-cup-core");
const JsonValue_1 = require("./JsonValue");
const JsPath_1 = require("./JsPath");
const JsFacade = __importStar(require("@diesel-parser/json-schema-facade-ts"));
const MyI18n_1 = require("./i18n/MyI18n");
function doValidate(model) {
    return model.schema
        .map((t) => {
        const validationResult = (0, tea_cup_core_1.just)(JsFacade.validate(t.a, model.root.a));
        return Object.assign(Object.assign({}, model), { validationResult });
    })
        .withDefault(model);
}
exports.doValidate = doValidate;
function computeErrors(model) {
    const errors = model.validationResult
        .map(JsFacade.getErrors)
        .map((jsErrors) => {
        const res = new Map();
        jsErrors.forEach((err) => {
            const errsAtPath = res.get(err.path);
            if (errsAtPath) {
                res.set(err.path, [...errsAtPath, err]);
            }
            else {
                res.set(err.path, [err]);
            }
        });
        return res;
    })
        .withDefaultSupply(() => new Map());
    return Object.assign(Object.assign({}, model), { errors });
}
exports.computeErrors = computeErrors;
function computePropertiesToAdd(model) {
    return model.validationResult
        .map((validationResult) => {
        const propertiesToAdd = new Map();
        doComputePropsToAdd(model, validationResult, propertiesToAdd);
        const newModel = Object.assign(Object.assign({}, model), { propertiesToAdd });
        return newModel;
    })
        .withDefault(model);
}
exports.computePropertiesToAdd = computePropertiesToAdd;
function computeStringsMetadata(model) {
    return model.validationResult
        .map((validationResult) => {
        const comboBoxes = new Map();
        const formats = new Map();
        const metadata = {
            comboBoxes,
            formats,
        };
        doComputeStringsMetadata(model, validationResult, metadata);
        const newModel = Object.assign(Object.assign({}, model), { comboBoxes,
            formats });
        return newModel;
    })
        .withDefault(model);
}
exports.computeStringsMetadata = computeStringsMetadata;
function doComputeStringsMetadata(model, validationResult, metadata, path = JsPath_1.JsPath.empty) {
    (0, JsonValue_1.getValueAt)(model.root.b, path).forEach((value) => {
        switch (value.tag) {
            case 'jv-object': {
                value.properties.forEach((prop) => doComputeStringsMetadata(model, validationResult, metadata, path.append(prop.name)));
                break;
            }
            case 'jv-array': {
                // recurse
                value.elems.forEach((elem, elemIndex) => doComputeStringsMetadata(model, validationResult, metadata, path.append(elemIndex)));
                break;
            }
            case 'jv-string': {
                const proposals = getProposals(validationResult, path, -1)
                    .flatMap((proposal) => {
                    if (proposal.tag === 'jv-string') {
                        return [proposal.value];
                    }
                    else {
                        return [];
                    }
                })
                    .filter((s) => s !== '');
                if (proposals.length > 0) {
                    metadata.comboBoxes.set(path.format(), proposals);
                }
                const formats = getFormats(validationResult, path);
                if (formats.length > 0) {
                    metadata.formats.set(path.format(), formats);
                }
            }
        }
    });
}
function doComputePropsToAdd(model, validationResult, props, path = JsPath_1.JsPath.empty) {
    (0, JsonValue_1.getValueAt)(model.root.b, path).forEach((value) => {
        switch (value.tag) {
            case 'jv-object': {
                // compute props for this object and recurse
                const propNameProposals = getProposals(validationResult, path, -1).flatMap((proposal) => {
                    if (proposal.tag === 'jv-object') {
                        return proposal.properties.map((p) => p.name);
                    }
                    return [];
                });
                props.set(path.format(), propNameProposals);
                value.properties.forEach((prop) => doComputePropsToAdd(model, validationResult, props, path.append(prop.name)));
                break;
            }
            case 'jv-array': {
                // recurse
                value.elems.forEach((elem, elemIndex) => doComputePropsToAdd(model, validationResult, props, path.append(elemIndex)));
                break;
            }
        }
    });
}
function toValueTuple(v) {
    return new tea_cup_core_1.Tuple((0, JsonValue_1.valueToAny)(v), v);
}
function initialModel(lang, schema, root, strictMode, debounceMs) {
    const t = (0, MyI18n_1.initMyI18n)(lang);
    const model = {
        lang,
        t,
        schema: schema.map(toValueTuple),
        root: toValueTuple(root),
        validationResult: tea_cup_core_1.nothing,
        errors: new Map(),
        adding: tea_cup_core_1.nothing,
        menuModel: tea_cup_core_1.nothing,
        collapsedPaths: new Set(),
        propertiesToAdd: new Map(),
        comboBoxes: new Map(),
        formats: new Map(),
        strictMode,
        customRenderers: new Map(),
        debounceMs: Math.max(0, debounceMs),
    };
    return computeAll(doValidate(model));
}
exports.initialModel = initialModel;
function computeAll(model) {
    return computeStringsMetadata(computePropertiesToAdd(computeErrors(model)));
}
exports.computeAll = computeAll;
function updateAddingPropertyName(model, propName) {
    return Object.assign(Object.assign({}, model), { adding: model.adding.map((addingState) => {
            const res = Object.assign(Object.assign({}, addingState), { addingPropName: propName, isDuplicate: (0, JsonValue_1.getValueAt)(model.root.b, addingState.ownerPath)
                    .map((ownerValue) => {
                    if (ownerValue.tag === 'jv-object') {
                        return (ownerValue.properties.find((p) => p.name === propName) !==
                            undefined);
                    }
                    else {
                        return false;
                    }
                })
                    .withDefault(false) });
            return res;
        }) });
}
exports.updateAddingPropertyName = updateAddingPropertyName;
function getProposals(validationResult, path, depth) {
    const proposals = JsFacade.propose(validationResult, path.format(), depth);
    return proposals.flatMap((proposalAny) => {
        return (0, JsonValue_1.valueFromAny)(proposalAny).match((jsonValue) => [jsonValue], () => []);
    });
}
exports.getProposals = getProposals;
function getFormats(validationResult, path) {
    return JsFacade.getFormats(validationResult, path.format());
}
exports.getFormats = getFormats;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTW9kZWwuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvTW9kZWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7Ozs7Ozs7OztHQWNHOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVILCtDQUEyRDtBQUMzRCwyQ0FBOEU7QUFDOUUscUNBQWtDO0FBR2xDLCtFQUFpRTtBQU1qRSwwQ0FBMkM7QUErQjNDLFNBQWdCLFVBQVUsQ0FBQyxLQUFZO0lBQ3JDLE9BQU8sS0FBSyxDQUFDLE1BQU07U0FDaEIsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUU7UUFDVCxNQUFNLGdCQUFnQixHQUFHLElBQUEsbUJBQUksRUFBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3BFLHVDQUNLLEtBQUssS0FDUixnQkFBZ0IsSUFDaEI7SUFDSixDQUFDLENBQUM7U0FDRCxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDeEIsQ0FBQztBQVZELGdDQVVDO0FBRUQsU0FBZ0IsYUFBYSxDQUFDLEtBQVk7SUFDeEMsTUFBTSxNQUFNLEdBQUcsS0FBSyxDQUFDLGdCQUFnQjtTQUNsQyxHQUFHLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQztTQUN2QixHQUFHLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRTtRQUNoQixNQUFNLEdBQUcsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ3RCLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTtZQUN2QixNQUFNLFVBQVUsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNyQyxJQUFJLFVBQVUsRUFBRTtnQkFDZCxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxHQUFHLFVBQVUsRUFBRSxH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biAqIENvcHlyaWdodCAyMDE4IFRoZSBEaWVzZWwgQXV0aG9yc1xuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBqdXN0LCBNYXliZSwgbm90aGluZywgVHVwbGUgfSBmcm9tICd0ZWEtY3VwLWNvcmUnO1xuaW1wb3J0IHsgZ2V0VmFsdWVBdCwgSnNvblZhbHVlLCB2YWx1ZUZyb21BbnksIHZhbHVlVG9BbnkgfSBmcm9tICcuL0pzb25WYWx1ZSc7XG5pbXBvcnQgeyBKc1BhdGggfSBmcm9tICcuL0pzUGF0aCc7XG5pbXBvcnQgKiBhcyBUUE0gZnJvbSAndGVhLXBvcC1tZW51JztcbmltcG9ydCB7IE1lbnVBY3Rpb24gfSBmcm9tICcuL0NvbnRleHRNZW51QWN0aW9ucyc7XG5pbXBvcnQgKiBhcyBKc0ZhY2FkZSBmcm9tICdAZGllc2VsLXBhcnNlci9qc29uLXNjaGVtYS1mYWNhZGUtdHMnO1xuaW1wb3J0IHtcbiAgSnNWYWxpZGF0aW9uRXJyb3IsXG4gIEpzVmFsaWRhdGlvblJlc3VsdCxcbn0gZnJvbSAnQGRpZXNlbC1wYXJzZXIvanNvbi1zY2hlbWEtZmFjYWRlLXRzJztcbmltcG9ydCB7IFRGdW5jdGlvbiB9IGZyb20gJ2kxOG5leHQnO1xuaW1wb3J0IHsgaW5pdE15STE4biB9IGZyb20gJy4vaTE4bi9NeUkxOG4nO1xuXG5leHBvcnQgaW50ZXJmYWNlIE1vZGVsIHtcbiAgcmVhZG9ubHkgc2NoZW1hOiBNYXliZTxUdXBsZTxhbnksIEpzb25WYWx1ZT4+O1xuICByZWFkb25seSByb290OiBUdXBsZTxhbnksIEpzb25WYWx1ZT47XG4gIHJlYWRvbmx5IHZhbGlkYXRpb25SZXN1bHQ6IE1heWJlPEpzVmFsaWRhdGlvblJlc3VsdD47XG4gIHJlYWRvbmx5IGVycm9yczogUmVhZG9ubHlNYXA8c3RyaW5nLCBSZWFkb25seUFycmF5PEpzVmFsaWRhdGlvbkVycm9yPj47XG4gIHJlYWRvbmx5IGFkZGluZzogTWF5YmU8QWRkaW5nU3RhdGU+O1xuICByZWFkb25seSBtZW51TW9kZWw6IE1heWJlPFRQTS5Nb2RlbDxNZW51QWN0aW9uPj47XG4gIHJlYWRvbmx5IGNvbGxhcHNlZFBhdGhzOiBSZWFkb25seVNldDxzdHJpbmc+O1xuICByZWFkb25seSBwcm9wZXJ0aWVzVG9BZGQ6IFJlYWRvbmx5TWFwPHN0cmluZywgUmVhZG9ubHlBcnJheTxzdHJpbmc+PjtcbiAgcmVhZG9ubHkgY29tYm9Cb3hlczogUmVhZG9ubHlNYXA8c3RyaW5nLCBSZWFkb25seUFycmF5PHN0cmluZz4+O1xuICByZWFkb25seSBmb3JtYXRzOiBSZWFkb25seU1hcDxzdHJpbmcsIFJlYWRvbmx5QXJyYXk8c3RyaW5nPj47XG4gIHJlYWRvbmx5IHQ6IFRGdW5jdGlvbjtcbiAgcmVhZG9ubHkgbGFuZzogc3RyaW5nO1xuICByZWFkb25seSBzdHJpY3RNb2RlOiBib29sZWFuO1xuICByZWFkb25seSBjdXN0b21SZW5kZXJlcnM6IFJlYWRvbmx5TWFwPHN0cmluZywgTWF5YmU8Q3VzdG9tUmVuZGVyZXJNb2RlbD4+O1xuICByZWFkb25seSBkZWJvdW5jZU1zOiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ3VzdG9tUmVuZGVyZXJNb2RlbCB7XG4gIHJlYWRvbmx5IGtleTogc3RyaW5nO1xuICByZWFkb25seSByZW5kZXJlck1vZGVsOiBhbnk7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQWRkaW5nU3RhdGUge1xuICByZWFkb25seSBvd25lclBhdGg6IEpzUGF0aDtcbiAgcmVhZG9ubHkgYWRkaW5nUHJvcE5hbWU6IHN0cmluZztcbiAgcmVhZG9ubHkgaXNEdXBsaWNhdGU6IGJvb2xlYW47XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBkb1ZhbGlkYXRlKG1vZGVsOiBNb2RlbCk6IE1vZGVsIHtcbiAgcmV0dXJuIG1vZGVsLnNjaGVtYVxuICAgIC5tYXAoKHQpID0+IHtcbiAgICAgIGNvbnN0IHZhbGlkYXRpb25SZXN1bHQgPSBqdXN0KEpzRmFjYWRlLnZhbGlkYXRlKHQuYSwgbW9kZWwucm9vdC5hKSk7XG4gICAgICByZXR1cm4ge1xuICAgICAgICAuLi5tb2RlbCxcbiAgICAgICAgdmFsaWRhdGlvblJlc3VsdCxcbiAgICAgIH07XG4gICAgfSlcbiAgICAud2l0aERlZmF1bHQobW9kZWwpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY29tcHV0ZUVycm9ycyhtb2RlbDogTW9kZWwpOiBNb2RlbCB7XG4gIGNvbnN0IGVycm9ycyA9IG1vZGVsLnZhbGlkYXRpb25SZXN1bHRcbiAgICAubWFwKEpzRmFjYWRlLmdldEVycm9ycylcbiAgICAubWFwKChqc0Vycm9ycykgPT4ge1xuICAgICAgY29uc3QgcmVzID0gbmV3IE1hcCgpO1xuICAgICAganNFcnJvcnMuZm9yRWFjaCgoZXJyKSA9PiB7XG4gICAgICAgIGNvbnN0IGVycnNBdFBhdGggPSByZXMuZ2V0KGVyci5wYXRoKTtcbiAgICAgICAgaWYgKGVycnNBdFBhdGgpIHtcbiAgICAgICAgICByZXMuc2V0KGVyci5wYXRoLCBbLi4uZXJyc0F0UGF0aCwgZXJyXSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzLnNldChlcnIucGF0aCwgW2Vycl0pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIHJldHVybiByZXM7XG4gICAgfSlcbiAgICAud2l0aERlZmF1bHRTdXBwbHkoXG4gICAgICAoKSA9PiBuZXcgTWFwPHN0cmluZywgUmVhZG9ubHlBcnJheTxKc1ZhbGlkYXRpb25FcnJvcj4+KCksXG4gICAgKTtcblxuICByZXR1cm4ge1xuICAgIC4uLm1vZGVsLFxuICAgIGVycm9ycyxcbiAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNvbXB1dGVQcm9wZXJ0aWVzVG9BZGQobW9kZWw6IE1vZGVsKTogTW9kZWwge1xuICByZXR1cm4gbW9kZWwudmFsaWRhdGlvblJlc3VsdFxuICAgIC5tYXAoKHZhbGlkYXRpb25SZXN1bHQpID0+IHtcbiAgICAgIGNvbnN0IHByb3BlcnRpZXNUb0FkZCA9IG5ldyBNYXA8c3RyaW5nLCBSZWFkb25seUFycmF5PHN0cmluZz4+KCk7XG4gICAgICBkb0NvbXB1dGVQcm9wc1RvQWRkKG1vZGVsLCB2YWxpZGF0aW9uUmVzdWx0LCBwcm9wZXJ0aWVzVG9BZGQpO1xuICAgICAgY29uc3QgbmV3TW9kZWw6IE1vZGVsID0ge1xuICAgICAgICAuLi5tb2RlbCxcbiAgICAgICAgcHJvcGVydGllc1RvQWRkLFxuICAgICAgfTtcbiAgICAgIHJldHVybiBuZXdNb2RlbDtcbiAgICB9KVxuICAgIC53aXRoRGVmYXVsdChtb2RlbCk7XG59XG5cbmludGVyZmFjZSBTdHJpbmdzTWV0YWRhdGEge1xuICByZWFkb25seSBjb21ib0JveGVzOiBNYXA8c3RyaW5nLCBSZWFkb25seUFycmF5PHN0cmluZz4+O1xuICByZWFkb25seSBmb3JtYXRzOiBNYXA8c3RyaW5nLCBSZWFkb25seUFycmF5PHN0cmluZz4+O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY29tcHV0ZVN0cmluZ3NNZXRhZGF0YShtb2RlbDogTW9kZWwpOiBNb2RlbCB7XG4gIHJldHVybiBtb2RlbC52YWxpZGF0aW9uUmVzdWx0XG4gICAgLm1hcCgodmFsaWRhdGlvblJlc3VsdCkgPT4ge1xuICAgICAgY29uc3QgY29tYm9Cb3hlcyA9IG5ldyBNYXA8c3RyaW5nLCBSZWFkb25seUFycmF5PHN0cmluZz4+KCk7XG4gICAgICBjb25zdCBmb3JtYXRzID0gbmV3IE1hcDxzdHJpbmcsIFJlYWRvbmx5QXJyYXk8c3RyaW5nPj4oKTtcbiAgICAgIGNvbnN0IG1ldGFkYXRhOiBTdHJpbmdzTWV0YWRhdGEgPSB7XG4gICAgICAgIGNvbWJvQm94ZXMsXG4gICAgICAgIGZvcm1hdHMsXG4gICAgICB9O1xuICAgICAgZG9Db21wdXRlU3RyaW5nc01ldGFkYXRhKG1vZGVsLCB2YWxpZGF0aW9uUmVzdWx0LCBtZXRhZGF0YSk7XG4gICAgICBjb25zdCBuZXdNb2RlbDogTW9kZWwgPSB7XG4gICAgICAgIC4uLm1vZGVsLFxuICAgICAgICBjb21ib0JveGVzLFxuICAgICAgICBmb3JtYXRzLFxuICAgICAgfTtcbiAgICAgIHJldHVybiBuZXdNb2RlbDtcbiAgICB9KVxuICAgIC53aXRoRGVmYXVsdChtb2RlbCk7XG59XG5cbmZ1bmN0aW9uIGRvQ29tcHV0ZVN0cmluZ3NNZXRhZGF0YShcbiAgbW9kZWw6IE1vZGVsLFxuICB2YWxpZGF0aW9uUmVzdWx0OiBKc1ZhbGlkYXRpb25SZXN1bHQsXG4gIG1ldGFkYXRhOiBTdHJpbmdzTWV0YWRhdGEsXG4gIHBhdGg6IEpzUGF0aCA9IEpzUGF0aC5lbXB0eSxcbik6IHZvaWQge1xuICBnZXRWYWx1ZUF0KG1vZGVsLnJvb3QuYiwgcGF0aCkuZm9yRWFjaCgodmFsdWUpID0+IHtcbiAgICBzd2l0Y2ggKHZhbHVlLnRhZykge1xuICAgICAgY2FzZSAnanYtb2JqZWN0Jzoge1xuICAgICAgICB2YWx1ZS5wcm9wZXJ0aWVzLmZvckVhY2goKHByb3ApID0+XG4gICAgICAgICAgZG9Db21wdXRlU3RyaW5nc01ldGFkYXRhKFxuICAgICAgICAgICAgbW9kZWwsXG4gICAgICAgICAgICB2YWxpZGF0aW9uUmVzdWx0LFxuICAgICAgICAgICAgbWV0YWRhdGEsXG4gICAgICAgICAgICBwYXRoLmFwcGVuZChwcm9wLm5hbWUpLFxuICAgICAgICAgICksXG4gICAgICAgICk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgY2FzZSAnanYtYXJyYXknOiB7XG4gICAgICAgIC8vIHJlY3Vyc2VcbiAgICAgICAgdmFsdWUuZWxlbXMuZm9yRWFjaCgoZWxlbSwgZWxlbUluZGV4KSA9PlxuICAgICAgICAgIGRvQ29tcHV0ZVN0cmluZ3NNZXRhZGF0YShcbiAgICAgICAgICAgIG1vZGVsLFxuICAgICAgICAgICAgdmFsaWRhdGlvblJlc3VsdCxcbiAgICAgICAgICAgIG1ldGFkYXRhLFxuICAgICAgICAgICAgcGF0aC5hcHBlbmQoZWxlbUluZGV4KSxcbiAgICAgICAgICApLFxuICAgICAgICApO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGNhc2UgJ2p2LXN0cmluZyc6IHtcbiAgICAgICAgY29uc3QgcHJvcG9zYWxzOiBSZWFkb25seUFycmF5PHN0cmluZz4gPSBnZXRQcm9wb3NhbHMoXG4gICAgICAgICAgdmFsaWRhdGlvblJlc3VsdCxcbiAgICAgICAgICBwYXRoLFxuICAgICAgICAgIC0xLFxuICAgICAgICApXG4gICAgICAgICAgLmZsYXRNYXAoKHByb3Bvc2FsKSA9PiB7XG4gICAgICAgICAgICBpZiAocHJvcG9zYWwudGFnID09PSAnanYtc3RyaW5nJykge1xuICAgICAgICAgICAgICByZXR1cm4gW3Byb3Bvc2FsLnZhbHVlXTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJldHVybiBbXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KVxuICAgICAgICAgIC5maWx0ZXIoKHMpID0+IHMgIT09ICcnKTtcblxuICAgICAgICBpZiAocHJvcG9zYWxzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICBtZXRhZGF0YS5jb21ib0JveGVzLnNldChwYXRoLmZvcm1hdCgpLCBwcm9wb3NhbHMpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZm9ybWF0czogUmVhZG9ubHlBcnJheTxzdHJpbmc+ID0gZ2V0Rm9ybWF0cyhcbiAgICAgICAgICB2YWxpZGF0aW9uUmVzdWx0LFxuICAgICAgICAgIHBhdGgsXG4gICAgICAgICk7XG4gICAgICAgIGlmIChmb3JtYXRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICBtZXRhZGF0YS5mb3JtYXRzLnNldChwYXRoLmZvcm1hdCgpLCBmb3JtYXRzKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGRvQ29tcHV0ZVByb3BzVG9BZGQoXG4gIG1vZGVsOiBNb2RlbCxcbiAgdmFsaWRhdGlvblJlc3VsdDogSnNWYWxpZGF0aW9uUmVzdWx0LFxuICBwcm9wczogTWFwPHN0cmluZywgUmVhZG9ubHlBcnJheTxzdHJpbmc+PixcbiAgcGF0aDogSnNQYXRoID0gSnNQYXRoLmVtcHR5LFxuKTogdm9pZCB7XG4gIGdldFZhbHVlQXQobW9kZWwucm9vdC5iLCBwYXRoKS5mb3JFYWNoKCh2YWx1ZSkgPT4ge1xuICAgIHN3aXRjaCAodmFsdWUudGFnKSB7XG4gICAgICBjYXNlICdqdi1vYmplY3QnOiB7XG4gICAgICAgIC8vIGNvbXB1dGUgcHJvcHMgZm9yIHRoaXMgb2JqZWN0IGFuZCByZWN1cnNlXG4gICAgICAgIGNvbnN0IHByb3BOYW1lUHJvcG9zYWxzOiBzdHJpbmdbXSA9IGdldFByb3Bvc2FscyhcbiAgICAgICAgICB2YWxpZGF0aW9uUmVzdWx0LFxuICAgICAgICAgIHBhdGgsXG4gICAgICAgICAgLTEsXG4gICAgICAgICkuZmxhdE1hcCgocHJvcG9zYWwpID0+IHtcbiAgICAgICAgICBpZiAocHJvcG9zYWwudGFnID09PSAnanYtb2JqZWN0Jykge1xuICAgICAgICAgICAgcmV0dXJuIHByb3Bvc2FsLnByb3BlcnRpZXMubWFwKChwKSA9PiBwLm5hbWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gW107XG4gICAgICAgIH0pO1xuICAgICAgICBwcm9wcy5zZXQocGF0aC5mb3JtYXQoKSwgcHJvcE5hbWVQcm9wb3NhbHMpO1xuICAgICAgICB2YWx1ZS5wcm9wZXJ0aWVzLmZvckVhY2goKHByb3ApID0+XG4gICAgICAgICAgZG9Db21wdXRlUHJvcHNUb0FkZChcbiAgICAgICAgICAgIG1vZGVsLFxuICAgICAgICAgICAgdmFsaWRhdGlvblJlc3VsdCxcbiAgICAgICAgICAgIHByb3BzLFxuICAgICAgICAgICAgcGF0aC5hcHBlbmQocHJvcC5uYW1lKSxcbiAgICAgICAgICApLFxuICAgICAgICApO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGNhc2UgJ2p2LWFycmF5Jzoge1xuICAgICAgICAvLyByZWN1cnNlXG4gICAgICAgIHZhbHVlLmVsZW1zLmZvckVhY2goKGVsZW0sIGVsZW1JbmRleCkgPT5cbiAgICAgICAgICBkb0NvbXB1dGVQcm9wc1RvQWRkKFxuICAgICAgICAgICAgbW9kZWwsXG4gICAgICAgICAgICB2YWxpZGF0aW9uUmVzdWx0LFxuICAgICAgICAgICAgcHJvcHMsXG4gICAgICAgICAgICBwYXRoLmFwcGVuZChlbGVtSW5kZXgpLFxuICAgICAgICAgICksXG4gICAgICAgICk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHRvVmFsdWVUdXBsZSh2OiBKc29uVmFsdWUpOiBUdXBsZTxhbnksIEpzb25WYWx1ZT4ge1xuICByZXR1cm4gbmV3IFR1cGxlKHZhbHVlVG9BbnkodiksIHYpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaW5pdGlhbE1vZGVsKFxuICBsYW5nOiBzdHJpbmcsXG4gIHNjaGVtYTogTWF5YmU8SnNvblZhbHVlPixcbiAgcm9vdDogSnNvblZhbHVlLFxuICBzdHJpY3RNb2RlOiBib29sZWFuLFxuICBkZWJvdW5jZU1zOiBudW1iZXIsXG4pOiBNb2RlbCB7XG4gIGNvbnN0IHQgPSBpbml0TXlJMThuKGxhbmcpO1xuICBjb25zdCBtb2RlbDogTW9kZWwgPSB7XG4gICAgbGFuZyxcbiAgICB0LFxuICAgIHNjaGVtYTogc2NoZW1hLm1hcCh0b1ZhbHVlVHVwbGUpLFxuICAgIHJvb3Q6IHRvVmFsdWVUdXBsZShyb290KSxcbiAgICB2YWxpZGF0aW9uUmVzdWx0OiBub3RoaW5nLFxuICAgIGVycm9yczogbmV3IE1hcCgpLFxuICAgIGFkZGluZzogbm90aGluZyxcbiAgICBtZW51TW9kZWw6IG5vdGhpbmcsXG4gICAgY29sbGFwc2VkUGF0aHM6IG5ldyBTZXQoKSxcbiAgICBwcm9wZXJ0aWVzVG9BZGQ6IG5ldyBNYXAoKSxcbiAgICBjb21ib0JveGVzOiBuZXcgTWFwKCksXG4gICAgZm9ybWF0czogbmV3IE1hcCgpLFxuICAgIHN0cmljdE1vZGUsXG4gICAgY3VzdG9tUmVuZGVyZXJzOiBuZXcgTWFwKCksXG4gICAgZGVib3VuY2VNczogTWF0aC5tYXgoMCwgZGVib3VuY2VNcyksXG4gIH07XG5cbiAgcmV0dXJuIGNvbXB1dGVBbGwoZG9WYWxpZGF0ZShtb2RlbCkpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY29tcHV0ZUFsbChtb2RlbDogTW9kZWwpOiBNb2RlbCB7XG4gIHJldHVybiBjb21wdXRlU3RyaW5nc01ldGFkYXRhKGNvbXB1dGVQcm9wZXJ0aWVzVG9BZGQoY29tcHV0ZUVycm9ycyhtb2RlbCkpKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHVwZGF0ZUFkZGluZ1Byb3BlcnR5TmFtZShcbiAgbW9kZWw6IE1vZGVsLFxuICBwcm9wTmFtZTogc3RyaW5nLFxuKTogTW9kZWwge1xuICByZXR1cm4ge1xuICAgIC4uLm1vZGVsLFxuICAgIGFkZGluZzogbW9kZWwuYWRkaW5nLm1hcCgoYWRkaW5nU3RhdGUpID0+IHtcbiAgICAgIGNvbnN0IHJlczogQWRkaW5nU3RhdGUgPSB7XG4gICAgICAgIC4uLmFkZGluZ1N0YXRlLFxuICAgICAgICBhZGRpbmdQcm9wTmFtZTogcHJvcE5hbWUsXG4gICAgICAgIGlzRHVwbGljYXRlOiBnZXRWYWx1ZUF0KG1vZGVsLnJvb3QuYiwgYWRkaW5nU3RhdGUub3duZXJQYXRoKVxuICAgICAgICAgIC5tYXAoKG93bmVyVmFsdWUpID0+IHtcbiAgICAgICAgICAgIGlmIChvd25lclZhbHVlLnRhZyA9PT0gJ2p2LW9iamVjdCcpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICBvd25lclZhbHVlLnByb3BlcnRpZXMuZmluZCgocCkgPT4gcC5uYW1lID09PSBwcm9wTmFtZSkgIT09XG4gICAgICAgICAgICAgICAgdW5kZWZpbmVkXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgICAgICAud2l0aERlZmF1bHQoZmFsc2UpLFxuICAgICAgfTtcbiAgICAgIHJldHVybiByZXM7XG4gICAgfSksXG4gIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRQcm9wb3NhbHMoXG4gIHZhbGlkYXRpb25SZXN1bHQ6IEpzVmFsaWRhdGlvblJlc3VsdCxcbiAgcGF0aDogSnNQYXRoLFxuICBkZXB0aDogbnVtYmVyLFxuKTogUmVhZG9ubHlBcnJheTxKc29uVmFsdWU+IHtcbiAgY29uc3QgcHJvcG9zYWxzID0gSnNGYWNhZGUucHJvcG9zZSh2YWxpZGF0aW9uUmVzdWx0LCBwYXRoLmZvcm1hdCgpLCBkZXB0aCk7XG4gIHJldHVybiBwcm9wb3NhbHMuZmxhdE1hcCgocHJvcG9zYWxBbnkpID0+IHtcbiAgICByZXR1cm4gdmFsdWVGcm9tQW55KHByb3Bvc2FsQW55KS5tYXRjaChcbiAgICAgIChqc29uVmFsdWUpID0+IFtqc29uVmFsdWVdLFxuICAgICAgKCkgPT4gW10sIC8vIFRPRE8gZXJyb3IgaWdub3JlZCBub3Qgc28gZ29vZCA/XG4gICAgKTtcbiAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRGb3JtYXRzKFxuICB2YWxpZGF0aW9uUmVzdWx0OiBKc1ZhbGlkYXRpb25SZXN1bHQsXG4gIHBhdGg6IEpzUGF0aCxcbik6IFJlYWRvbmx5QXJyYXk8c3RyaW5nPiB7XG4gIHJldHVybiBKc0ZhY2FkZS5nZXRGb3JtYXRzKHZhbGlkYXRpb25SZXN1bHQsIHBhdGguZm9ybWF0KCkpO1xufVxuIl19
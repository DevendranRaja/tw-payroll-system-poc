"use strict";
/*
 * Copyright 2018 The Diesel Authors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.createMenu = exports.createProposeMenu = exports.createTypesMenu = void 0;
const tea_pop_menu_1 = require("tea-pop-menu");
const JsonValue_1 = require("./JsonValue");
const RenderOptions_1 = require("./RenderOptions");
function maDelete(path) {
    return {
        tag: 'delete',
        path,
    };
}
function maMove() {
    return {
        tag: 'move',
    };
}
function maMoveUp(path) {
    return {
        tag: 'move-up',
        path,
    };
}
function maMoveDown(path) {
    return {
        tag: 'move-down',
        path,
    };
}
function createTypesMenu(path, valueAtPath, proposals, strictMode) {
    const buildChangeTypeItem = (value) => {
        return (0, tea_pop_menu_1.item)({
            tag: 'change-type',
            path,
            value: value,
        });
    };
    const uniqueProposalTypes = proposals
        .map((p) => p.tag)
        .filter((value, index, array) => array.indexOf(value) === index);
    const buildChangeTypeMenuItems = () => {
        const jsonValues = strictMode
            ? proposals
            : [
                JsonValue_1.jvNull,
                (0, JsonValue_1.jvString)(''),
                (0, JsonValue_1.jvNumber)('0'),
                (0, JsonValue_1.jvBool)(true),
                (0, JsonValue_1.jvObject)(),
                (0, JsonValue_1.jvArray)(),
            ];
        return (jsonValues
            // keep only JsonValue type
            .map((p) => p.tag)
            // Get unique values
            .filter((value, index, array) => array.indexOf(value) === index)
            // Exclude actual type
            .filter((value) => value !== valueAtPath.tag)
            // Build MenuItem from unique JsonValue
            .map((t) => {
            switch (t) {
                case 'jv-array':
                    return buildChangeTypeItem((0, JsonValue_1.jvArray)());
                case 'jv-boolean':
                    return buildChangeTypeItem((0, JsonValue_1.jvBool)(true));
                case 'jv-null':
                    return buildChangeTypeItem(JsonValue_1.jvNull);
                case 'jv-number':
                    return buildChangeTypeItem((0, JsonValue_1.jvNumber)('0'));
                case 'jv-object':
                    return buildChangeTypeItem((0, JsonValue_1.jvObject)());
                case 'jv-string':
                    return buildChangeTypeItem((0, JsonValue_1.jvString)(''));
            }
        }));
    };
    if (strictMode &&
        uniqueProposalTypes.length === 1 &&
        valueAtPath.tag === proposals[0].tag) {
        // Only one type accepted and the value has already the right one -> no menu at all
        return [];
    }
    return buildChangeTypeMenuItems().length > 0
        ? [(0, tea_pop_menu_1.item)({ tag: 'types' }, (0, tea_pop_menu_1.menu)(buildChangeTypeMenuItems()))]
        : [];
}
exports.createTypesMenu = createTypesMenu;
function createProposeMenu(path, proposals, strictMode) {
    if (strictMode || proposals.length === 0) {
        // Strict mode or no proposal => no menu
        return [];
    }
    const proposeMenu = (0, tea_pop_menu_1.menu)(proposals.map((value, index) => (0, tea_pop_menu_1.item)({
        tag: 'proposal',
        path,
        value,
        index,
    })));
    return [(0, tea_pop_menu_1.item)({ tag: 'propose', path }, proposeMenu)];
}
exports.createProposeMenu = createProposeMenu;
function createMenu(props) {
    const { path, proposals, valueAtPath, root, strictMode, menuFilter } = props;
    const addItems = () => {
        const isArray = valueAtPath.tag === 'jv-array';
        const isObject = !strictMode && valueAtPath.tag === 'jv-object';
        if ((isArray || isObject) &&
            !(0, RenderOptions_1.isMenuOptionHidden)(RenderOptions_1.MenuOptions.ADD, menuFilter)) {
            return [(0, tea_pop_menu_1.item)({ tag: 'add', path, isArray })];
        }
        return [];
    };
    const isRoot = path.isEmpty();
    const nbItems = path
        .parent()
        .andThen((pp) => (0, JsonValue_1.getValueAt)(root, pp))
        .map((pv) => {
        switch (pv.tag) {
            case 'jv-object':
                return pv.properties.length;
            case 'jv-array':
                return pv.elems.length;
            default:
                return 0;
        }
    })
        .withDefault(0);
    const hasMoveMenu = !isRoot && nbItems > 1 && !(0, RenderOptions_1.isMenuOptionHidden)(RenderOptions_1.MenuOptions.MOVE, menuFilter);
    const moveMenu = () => {
        const index = (0, JsonValue_1.indexOfPathInParent)(root, path);
        const canMoveUp = index > 0;
        const canMoveDown = index >= 0 && index < nbItems - 1;
        const moveUpItems = canMoveUp ? [(0, tea_pop_menu_1.item)(maMoveUp(path))] : [];
        const moveDownItems = canMoveDown ? [(0, tea_pop_menu_1.item)(maMoveDown(path))] : [];
        return (0, tea_pop_menu_1.menu)(moveUpItems.concat(moveDownItems));
    };
    const moveItems = hasMoveMenu ? [(0, tea_pop_menu_1.item)(maMove(), moveMenu())] : [];
    const deleteItems = isRoot &&
        (menuFilter === null || menuFilter === void 0 ? void 0 : menuFilter.menuFilters) &&
        (0, RenderOptions_1.isMenuOptionHidden)(RenderOptions_1.MenuOptions.DELETE, menuFilter)
        ? []
        : [(0, tea_pop_menu_1.item)(maDelete(path))];
    const changeTypes = (0, RenderOptions_1.isMenuOptionHidden)(RenderOptions_1.MenuOptions.CHANGE_TYPE, menuFilter)
        ? []
        : createTypesMenu(path, valueAtPath, proposals, strictMode);
    const proposeItems = (0, RenderOptions_1.isMenuOptionHidden)(RenderOptions_1.MenuOptions.PROPOSE, menuFilter)
        ? []
        : createProposeMenu(path, proposals, strictMode);
    return (0, tea_pop_menu_1.menu)(moveItems
        .concat(addItems())
        .concat(changeTypes)
        .concat(proposeItems)
        .concat(deleteItems));
}
exports.createMenu = createMenu;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29udGV4dE1lbnVBY3Rpb25zLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL0NvbnRleHRNZW51QWN0aW9ucy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7Ozs7O0dBY0c7OztBQUVILCtDQUEwRDtBQUUxRCwyQ0FVcUI7QUFDckIsbURBSXlCO0FBYXpCLFNBQVMsUUFBUSxDQUFDLElBQVk7SUFDNUIsT0FBTztRQUNMLEdBQUcsRUFBRSxRQUFRO1FBQ2IsSUFBSTtLQUNMLENBQUM7QUFDSixDQUFDO0FBRUQsU0FBUyxNQUFNO0lBQ2IsT0FBTztRQUNMLEdBQUcsRUFBRSxNQUFNO0tBQ1osQ0FBQztBQUNKLENBQUM7QUFFRCxTQUFTLFFBQVEsQ0FBQyxJQUFZO0lBQzVCLE9BQU87UUFDTCxHQUFHLEVBQUUsU0FBUztRQUNkLElBQUk7S0FDTCxDQUFDO0FBQ0osQ0FBQztBQUVELFNBQVMsVUFBVSxDQUFDLElBQVk7SUFDOUIsT0FBTztRQUNMLEdBQUcsRUFBRSxXQUFXO1FBQ2hCLElBQUk7S0FDTCxDQUFDO0FBQ0osQ0FBQztBQVdELFNBQWdCLGVBQWUsQ0FDN0IsSUFBWSxFQUNaLFdBQXNCLEVBQ3RCLFNBQW1DLEVBQ25DLFVBQW1CO0lBRW5CLE1BQU0sbUJBQW1CLEdBQUcsQ0FBQyxLQUFnQixFQUF3QixFQUFFO1FBQ3JFLE9BQU8sSUFBQSxtQkFBSSxFQUFhO1lBQ3RCLEdBQUcsRUFBRSxhQUFhO1lBQ2xCLElBQUk7WUFDSixLQUFLLEVBQUUsS0FBSztTQUNiLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQztJQUVGLE1BQU0sbUJBQW1CLEdBQUcsU0FBUztTQUNsQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUM7U0FDakIsTUFBTSxDQUNMLENBQUMsS0FBYSxFQUFFLEtBQWEsRUFBRSxLQUE0QixFQUFFLEVBQUUsQ0FDN0QsS0FBSyxDQUFDLE9BQU8sQ0FB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TSxXQUFXLEdBQ2YsTUFBTTtTQUNOLFVBQVUsYUFBVixVQUFVLHVCQUFWLFVBQVUsQ0FBRSxXQUFXLENBQUE7UUFDdkIsSUFBQSxrQ0FBa0IsRUFBQywyQkFBVyxDQUFDLE1BQU0sRUFBRSxVQUFVLENBQUM7UUFDaEQsQ0FBQyxDQUFDLEVBQUU7UUFDSixDQUFDLENBQUMsQ0FBQyxJQUFBLG1CQUFJLEVBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUU3QixNQUFNLFdBQVcsR0FBRyxJQUFBLGtDQUFrQixFQUFDLDJCQUFXLENBQUMsV0FBVyxFQUFFLFVBQVUsQ0FBQztRQUN6RSxDQUFDLENBQUMsRUFBRTtRQUNKLENBQUMsQ0FBQyxlQUFlLENBQUMsSUFBSSxFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFDOUQsTUFBTSxZQUFZLEdBQUcsSUFBQSxrQ0FBa0IsRUFBQywyQkFBVyxDQUFDLE9BQU8sRUFBRSxVQUFVLENBQUM7UUFDdEUsQ0FBQyxDQUFDLEVBQUU7UUFDSixDQUFDLENBQUMsaUJBQWlCLENBQUMsSUFBSSxFQUFFLFNBQVMsRUFBRSxVQUFVLENBQUMsQ0FBQztJQUVuRCxPQUFPLElBQUEsbUJBQUksRUFDVCxTQUFTO1NBQ04sTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDO1NBQ2xCLE1BQU0sQ0FBQyxXQUFXLENBQUM7U0FDbkIsTUFBTSxDQUFDLFlBQVksQ0FBQztTQUNwQixNQUFNLENBQUMsV0FBVyxDQUFDLENBQ3ZCLENBQUM7QUFDSixDQUFDO0FBcEVELGdDQW9FQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgMjAxOCBUaGUgRGllc2VsIEF1dGhvcnNcbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgaXRlbSwgTWVudSwgbWVudSwgTWVudUl0ZW0gfSBmcm9tICd0ZWEtcG9wLW1lbnUnO1xuaW1wb3J0IHsgSnNQYXRoIH0gZnJvbSAnLi9Kc1BhdGgnO1xuaW1wb3J0IHtcbiAgZ2V0VmFsdWVBdCxcbiAgaW5kZXhPZlBhdGhJblBhcmVudCxcbiAgSnNvblZhbHVlLFxuICBqdkFycmF5LFxuICBqdkJvb2wsXG4gIGp2TnVsbCxcbiAganZOdW1iZXIsXG4gIGp2T2JqZWN0LFxuICBqdlN0cmluZyxcbn0gZnJvbSAnLi9Kc29uVmFsdWUnO1xuaW1wb3J0IHtcbiAgaXNNZW51T3B0aW9uSGlkZGVuLFxuICBNZW51T3B0aW9uRmlsdGVyLFxuICBNZW51T3B0aW9ucyxcbn0gZnJvbSAnLi9SZW5kZXJPcHRpb25zJztcblxuZXhwb3J0IHR5cGUgTWVudUFjdGlvbiA9XG4gIHwgeyB0YWc6ICdkZWxldGUnOyBwYXRoOiBKc1BhdGggfVxuICB8IHsgdGFnOiAnbW92ZScgfVxuICB8IHsgdGFnOiAnbW92ZS11cCc7IHBhdGg6IEpzUGF0aCB9XG4gIHwgeyB0YWc6ICdtb3ZlLWRvd24nOyBwYXRoOiBKc1BhdGggfVxuICB8IHsgdGFnOiAncHJvcG9zZSc7IHBhdGg6IEpzUGF0aCB9XG4gIHwgeyB0YWc6ICdwcm9wb3NhbCc7IHBhdGg6IEpzUGF0aDsgdmFsdWU6IEpzb25WYWx1ZTsgaW5kZXg6IG51bWJlciB9XG4gIHwgeyB0YWc6ICd0eXBlcycgfVxuICB8IHsgdGFnOiAnY2hhbmdlLXR5cGUnOyBwYXRoOiBKc1BhdGg7IHZhbHVlOiBKc29uVmFsdWUgfVxuICB8IHsgdGFnOiAnYWRkJzsgcGF0aDogSnNQYXRoOyBpc0FycmF5OiBib29sZWFuIH07XG5cbmZ1bmN0aW9uIG1hRGVsZXRlKHBhdGg6IEpzUGF0aCk6IE1lbnVBY3Rpb24ge1xuICByZXR1cm4ge1xuICAgIHRhZzogJ2RlbGV0ZScsXG4gICAgcGF0aCxcbiAgfTtcbn1cblxuZnVuY3Rpb24gbWFNb3ZlKCk6IE1lbnVBY3Rpb24ge1xuICByZXR1cm4ge1xuICAgIHRhZzogJ21vdmUnLFxuICB9O1xufVxuXG5mdW5jdGlvbiBtYU1vdmVVcChwYXRoOiBKc1BhdGgpOiBNZW51QWN0aW9uIHtcbiAgcmV0dXJuIHtcbiAgICB0YWc6ICdtb3ZlLXVwJyxcbiAgICBwYXRoLFxuICB9O1xufVxuXG5mdW5jdGlvbiBtYU1vdmVEb3duKHBhdGg6IEpzUGF0aCk6IE1lbnVBY3Rpb24ge1xuICByZXR1cm4ge1xuICAgIHRhZzogJ21vdmUtZG93bicsXG4gICAgcGF0aCxcbiAgfTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBNZW51UHJvcGVydHlQcm9wcyB7XG4gIHJlYWRvbmx5IHJvb3Q6IEpzb25WYWx1ZTtcbiAgcmVhZG9ubHkgcGF0aDogSnNQYXRoO1xuICByZWFkb25seSB2YWx1ZUF0UGF0aDogSnNvblZhbHVlO1xuICByZWFkb25seSBwcm9wb3NhbHM6IFJlYWRvbmx5QXJyYXk8SnNvblZhbHVlPjtcbiAgcmVhZG9ubHkgc3RyaWN0TW9kZTogYm9vbGVhbjtcbiAgcmVhZG9ubHkgbWVudUZpbHRlcj86IE1lbnVPcHRpb25GaWx0ZXI7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVUeXBlc01lbnUoXG4gIHBhdGg6IEpzUGF0aCxcbiAgdmFsdWVBdFBhdGg6IEpzb25WYWx1ZSxcbiAgcHJvcG9zYWxzOiBSZWFkb25seUFycmF5PEpzb25WYWx1ZT4sXG4gIHN0cmljdE1vZGU6IGJvb2xlYW4sXG4pOiBSZWFkb25seUFycmF5PE1lbnVJdGVtPE1lbnVBY3Rpb24+PiB7XG4gIGNvbnN0IGJ1aWxkQ2hhbmdlVHlwZUl0ZW0gPSAodmFsdWU6IEpzb25WYWx1ZSk6IE1lbnVJdGVtPE1lbnVBY3Rpb24+ID0+IHtcbiAgICByZXR1cm4gaXRlbTxNZW51QWN0aW9uPih7XG4gICAgICB0YWc6ICdjaGFuZ2UtdHlwZScsXG4gICAgICBwYXRoLFxuICAgICAgdmFsdWU6IHZhbHVlLFxuICAgIH0pO1xuICB9O1xuXG4gIGNvbnN0IHVuaXF1ZVByb3Bvc2FsVHlwZXMgPSBwcm9wb3NhbHNcbiAgICAubWFwKChwKSA9PiBwLnRhZylcbiAgICAuZmlsdGVyKFxuICAgICAgKHZhbHVlOiBzdHJpbmcsIGluZGV4OiBudW1iZXIsIGFycmF5OiBSZWFkb25seUFycmF5PHN0cmluZz4pID0+XG4gICAgICAgIGFycmF5LmluZGV4T2YodmFsdWUpID09PSBpbmRleCxcbiAgICApO1xuXG4gIGNvbnN0IGJ1aWxkQ2hhbmdlVHlwZU1lbnVJdGVtcyA9ICgpOiBSZWFkb25seUFycmF5PE1lbnVJdGVtPE1lbnVBY3Rpb24+PiA9PiB7XG4gICAgY29uc3QganNvblZhbHVlcyA9IHN0cmljdE1vZGVcbiAgICAgID8gcHJvcG9zYWxzXG4gICAgICA6IFtcbiAgICAgICAgICBqdk51bGwsXG4gICAgICAgICAganZTdHJpbmcoJycpLFxuICAgICAgICAgIGp2TnVtYmVyKCcwJyksXG4gICAgICAgICAganZCb29sKHRydWUpLFxuICAgICAgICAgIGp2T2JqZWN0KCksXG4gICAgICAgICAganZBcnJheSgpLFxuICAgICAgICBdO1xuXG4gICAgcmV0dXJuIChcbiAgICAgIGpzb25WYWx1ZXNcbiAgICAgICAgLy8ga2VlcCBvbmx5IEpzb25WYWx1ZSB0eXBlXG4gICAgICAgIC5tYXAoKHApID0+IHAudGFnKVxuICAgICAgICAvLyBHZXQgdW5pcXVlIHZhbHVlc1xuICAgICAgICAuZmlsdGVyKFxuICAgICAgICAgICh2YWx1ZTogc3RyaW5nLCBpbmRleDogbnVtYmVyLCBhcnJheTogUmVhZG9ubHlBcnJheTxzdHJpbmc+KSA9PlxuICAgICAgICAgICAgYXJyYXkuaW5kZXhPZih2YWx1ZSkgPT09IGluZGV4LFxuICAgICAgICApXG4gICAgICAgIC8vIEV4Y2x1ZGUgYWN0dWFsIHR5cGVcbiAgICAgICAgLmZpbHRlcigodmFsdWUpID0+IHZhbHVlICE9PSB2YWx1ZUF0UGF0aC50YWcpXG4gICAgICAgIC8vIEJ1aWxkIE1lbnVJdGVtIGZyb20gdW5pcXVlIEpzb25WYWx1ZVxuICAgICAgICAubWFwKCh0KSA9PiB7XG4gICAgICAgICAgc3dpdGNoICh0KSB7XG4gICAgICAgICAgICBjYXNlICdqdi1hcnJheSc6XG4gICAgICAgICAgICAgIHJldHVybiBidWlsZENoYW5nZVR5cGVJdGVtKGp2QXJyYXkoKSk7XG4gICAgICAgICAgICBjYXNlICdqdi1ib29sZWFuJzpcbiAgICAgICAgICAgICAgcmV0dXJuIGJ1aWxkQ2hhbmdlVHlwZUl0ZW0oanZCb29sKHRydWUpKTtcbiAgICAgICAgICAgIGNhc2UgJ2p2LW51bGwnOlxuICAgICAgICAgICAgICByZXR1cm4gYnVpbGRDaGFuZ2VUeXBlSXRlbShqdk51bGwpO1xuICAgICAgICAgICAgY2FzZSAnanYtbnVtYmVyJzpcbiAgICAgICAgICAgICAgcmV0dXJuIGJ1aWxkQ2hhbmdlVHlwZUl0ZW0oanZOdW1iZXIoJzAnKSk7XG4gICAgICAgICAgICBjYXNlICdqdi1vYmplY3QnOlxuICAgICAgICAgICAgICByZXR1cm4gYnVpbGRDaGFuZ2VUeXBlSXRlbShqdk9iamVjdCgpKTtcbiAgICAgICAgICAgIGNhc2UgJ2p2LXN0cmluZyc6XG4gICAgICAgICAgICAgIHJldHVybiBidWlsZENoYW5nZVR5cGVJdGVtKGp2U3RyaW5nKCcnKSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICk7XG4gIH07XG5cbiAgaWYgKFxuICAgIHN0cmljdE1vZGUgJiZcbiAgICB1bmlxdWVQcm9wb3NhbFR5cGVzLmxlbmd0aCA9PT0gMSAmJlxuICAgIHZhbHVlQXRQYXRoLnRhZyA9PT0gcHJvcG9zYWxzWzBdLnRhZ1xuICApIHtcbiAgICAvLyBPbmx5IG9uZSB0eXBlIGFjY2VwdGVkIGFuZCB0aGUgdmFsdWUgaGFzIGFscmVhZHkgdGhlIHJpZ2h0IG9uZSAtPiBubyBtZW51IGF0IGFsbFxuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIHJldHVybiBidWlsZENoYW5nZVR5cGVNZW51SXRlbXMoKS5sZW5ndGggPiAwXG4gICAgPyBbaXRlbSh7IHRhZzogJ3R5cGVzJyB9LCBtZW51KGJ1aWxkQ2hhbmdlVHlwZU1lbnVJdGVtcygpKSldXG4gICAgOiBbXTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVByb3Bvc2VNZW51KFxuICBwYXRoOiBKc1BhdGgsXG4gIHByb3Bvc2FsczogUmVhZG9ubHlBcnJheTxKc29uVmFsdWU+LFxuICBzdHJpY3RNb2RlOiBib29sZWFuLFxuKTogUmVhZG9ubHlBcnJheTxNZW51SXRlbTxNZW51QWN0aW9uPj4ge1xuICBpZiAoc3RyaWN0TW9kZSB8fCBwcm9wb3NhbHMubGVuZ3RoID09PSAwKSB7XG4gICAgLy8gU3RyaWN0IG1vZGUgb3Igbm8gcHJvcG9zYWwgPT4gbm8gbWVudVxuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIGNvbnN0IHByb3Bvc2VNZW51OiBNZW51PE1lbnVBY3Rpb24+ID0gbWVudShcbiAgICBwcm9wb3NhbHMubWFwKCh2YWx1ZSwgaW5kZXgpID0+XG4gICAgICBpdGVtKHtcbiAgICAgICAgdGFnOiAncHJvcG9zYWwnLFxuICAgICAgICBwYXRoLFxuICAgICAgICB2YWx1ZSxcbiAgICAgICAgaW5kZXgsXG4gICAgICB9KSxcbiAgICApLFxuICApO1xuICByZXR1cm4gW2l0ZW0oeyB0YWc6ICdwcm9wb3NlJywgcGF0aCB9LCBwcm9wb3NlTWVudSldO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlTWVudShwcm9wczogTWVudVByb3BlcnR5UHJvcHMpOiBNZW51PE1lbnVBY3Rpb24+IHtcbiAgY29uc3QgeyBwYXRoLCBwcm9wb3NhbHMsIHZhbHVlQXRQYXRoLCByb290LCBzdHJpY3RNb2RlLCBtZW51RmlsdGVyIH0gPSBwcm9wcztcblxuICBjb25zdCBhZGRJdGVtczogKCkgPT4gTWVudUl0ZW08TWVudUFjdGlvbj5bXSA9ICgpID0+IHtcbiAgICBjb25zdCBpc0FycmF5ID0gdmFsdWVBdFBhdGgudGFnID09PSAnanYtYXJyYXknO1xuICAgIGNvbnN0IGlzT2JqZWN0ID0gIXN0cmljdE1vZGUgJiYgdmFsdWVBdFBhdGgudGFnID09PSAnanYtb2JqZWN0JztcbiAgICBpZiAoXG4gICAgICAoaXNBcnJheSB8fCBpc09iamVjdCkgJiZcbiAgICAgICFpc01lbnVPcHRpb25IaWRkZW4oTWVudU9wdGlvbnMuQURELCBtZW51RmlsdGVyKVxuICAgICkge1xuICAgICAgcmV0dXJuIFtpdGVtKHsgdGFnOiAnYWRkJywgcGF0aCwgaXNBcnJheSB9KV07XG4gICAgfVxuICAgIHJldHVybiBbXTtcbiAgfTtcblxuICBjb25zdCBpc1Jvb3QgPSBwYXRoLmlzRW1wdHkoKTtcblxuICBjb25zdCBuYkl0ZW1zID0gcGF0aFxuICAgIC5wYXJlbnQoKVxuICAgIC5hbmRUaGVuKChwcCkgPT4gZ2V0VmFsdWVBdChyb290LCBwcCkpXG4gICAgLm1hcCgocHYpID0+IHtcbiAgICAgIHN3aXRjaCAocHYudGFnKSB7XG4gICAgICAgIGNhc2UgJ2p2LW9iamVjdCc6XG4gICAgICAgICAgcmV0dXJuIHB2LnByb3BlcnRpZXMubGVuZ3RoO1xuICAgICAgICBjYXNlICdqdi1hcnJheSc6XG4gICAgICAgICAgcmV0dXJuIHB2LmVsZW1zLmxlbmd0aDtcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICByZXR1cm4gMDtcbiAgICAgIH1cbiAgICB9KVxuICAgIC53aXRoRGVmYXVsdCgwKTtcblxuICBjb25zdCBoYXNNb3ZlTWVudSA9XG4gICAgIWlzUm9vdCAmJiBuYkl0ZW1zID4gMSAmJiAhaXNNZW51T3B0aW9uSGlkZGVuKE1lbnVPcHRpb25zLk1PVkUsIG1lbnVGaWx0ZXIpO1xuXG4gIGNvbnN0IG1vdmVNZW51OiAoKSA9PiBNZW51PE1lbnVBY3Rpb24+ID0gKCkgPT4ge1xuICAgIGNvbnN0IGluZGV4ID0gaW5kZXhPZlBhdGhJblBhcmVudChyb290LCBwYXRoKTtcbiAgICBjb25zdCBjYW5Nb3ZlVXAgPSBpbmRleCA+IDA7XG4gICAgY29uc3QgY2FuTW92ZURvd24gPSBpbmRleCA+PSAwICYmIGluZGV4IDwgbmJJdGVtcyAtIDE7XG4gICAgY29uc3QgbW92ZVVwSXRlbXMgPSBjYW5Nb3ZlVXAgPyBbaXRlbShtYU1vdmVVcChwYXRoKSldIDogW107XG4gICAgY29uc3QgbW92ZURvd25JdGVtcyA9IGNhbk1vdmVEb3duID8gW2l0ZW0obWFNb3ZlRG93bihwYXRoKSldIDogW107XG5cbiAgICByZXR1cm4gbWVudShtb3ZlVXBJdGVtcy5jb25jYXQobW92ZURvd25JdGVtcykpO1xuICB9O1xuXG4gIGNvbnN0IG1vdmVJdGVtcyA9IGhhc01vdmVNZW51ID8gW2l0ZW0obWFNb3ZlKCksIG1vdmVNZW51KCkpXSA6IFtdO1xuXG4gIGNvbnN0IGRlbGV0ZUl0ZW1zID1cbiAgICBpc1Jvb3QgJiZcbiAgICBtZW51RmlsdGVyPy5tZW51RmlsdGVycyAmJlxuICAgIGlzTWVudU9wdGlvbkhpZGRlbihNZW51T3B0aW9ucy5ERUxFVEUsIG1lbnVGaWx0ZXIpXG4gICAgICA/IFtdXG4gICAgICA6IFtpdGVtKG1hRGVsZXRlKHBhdGgpKV07XG5cbiAgY29uc3QgY2hhbmdlVHlwZXMgPSBpc01lbnVPcHRpb25IaWRkZW4oTWVudU9wdGlvbnMuQ0hBTkdFX1RZUEUsIG1lbnVGaWx0ZXIpXG4gICAgPyBbXVxuICAgIDogY3JlYXRlVHlwZXNNZW51KHBhdGgsIHZhbHVlQXRQYXRoLCBwcm9wb3NhbHMsIHN0cmljdE1vZGUpO1xuICBjb25zdCBwcm9wb3NlSXRlbXMgPSBpc01lbnVPcHRpb25IaWRkZW4oTWVudU9wdGlvbnMuUFJPUE9TRSwgbWVudUZpbHRlcilcbiAgICA/IFtdXG4gICAgOiBjcmVhdGVQcm9wb3NlTWVudShwYXRoLCBwcm9wb3NhbHMsIHN0cmljdE1vZGUpO1xuXG4gIHJldHVybiBtZW51KFxuICAgIG1vdmVJdGVtc1xuICAgICAgLmNvbmNhdChhZGRJdGVtcygpKVxuICAgICAgLmNvbmNhdChjaGFuZ2VUeXBlcylcbiAgICAgIC5jb25jYXQocHJvcG9zZUl0ZW1zKVxuICAgICAgLmNvbmNhdChkZWxldGVJdGVtcyksXG4gICk7XG59XG4iXX0=
"use strict";
/*
 * Copyright 2018 The Diesel Authors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.JsonEditor = exports.subscriptions = exports.setDebounceMsPort = exports.setStrictModePort = exports.sendJsonPort = exports.setStrictMode = exports.update = exports.ViewJsonEditor = exports.init = void 0;
const JsFacade = __importStar(require("@diesel-parser/json-schema-facade-ts"));
const react_1 = __importDefault(require("react"));
const react_tea_cup_1 = require("react-tea-cup");
const tea_cup_core_1 = require("tea-cup-core");
const TPM = __importStar(require("tea-pop-menu"));
const Actions_1 = require("./Actions");
const ContextMenu_1 = require("./ContextMenu");
const ContextMenuRenderer_1 = require("./ContextMenuRenderer");
const JsonValue_1 = require("./JsonValue");
const JsPath_1 = require("./JsPath");
const Model_1 = require("./Model");
const Msg_1 = require("./Msg");
const OutMsg_1 = require("./OutMsg");
const Renderer_1 = require("./renderer/Renderer");
function init(language, schema, initialValue, strictMode, rendererFactory, debounceMs) {
    JsFacade.setLang(language);
    const model = (0, Model_1.initialModel)(language, schema, initialValue, strictMode, debounceMs);
    return reInitRenderers(model, rendererFactory);
}
exports.init = init;
function reInitRenderers(model, customRendererFactory) {
    return model.validationResult
        .map((validationResult) => {
        const renderers = JsFacade.getRenderers(validationResult);
        const newCustomRenderers = new Map();
        const cmds = [];
        for (const [path, rendererDef] of renderers) {
            if (rendererDef !== undefined) {
                const key = rendererDef.key;
                const renderer = customRendererFactory.getRenderer(key);
                if (renderer.type === 'Just') {
                    const existingModel = model.customRenderers.get(path);
                    const m = existingModel === undefined ? tea_cup_core_1.nothing : existingModel;
                    const jValue = (0, JsonValue_1.getValueAt)(model.root.b, JsPath_1.JsPath.parse(path));
                    if (jValue.type === 'Just') {
                        const mac = renderer.value.reinit({
                            path: JsPath_1.JsPath.parse(path),
                            formModel: model,
                            value: jValue.value,
                            model: m.map((x) => x.rendererModel),
                            schema: rendererDef.schemaValue,
                        });
                        const customRendererModel = {
                            rendererModel: mac[0],
                            key,
                        };
                        newCustomRenderers.set(path, (0, tea_cup_core_1.just)(customRendererModel));
                        const cmd = mac[1].map((msg) => {
                            return {
                                tag: 'renderer-child-msg',
                                path,
                                msg,
                            };
                        });
                        cmds.push(cmd);
                    }
                }
            }
        }
        const newModel = Object.assign(Object.assign({}, model), { customRenderers: newCustomRenderers });
        return tea_cup_core_1.Tuple.t2n(newModel, tea_cup_core_1.Cmd.batch(cmds));
    })
        .withDefaultSupply(() => (0, tea_cup_core_1.noCmd)(model));
}
function ViewJsonEditor(props) {
    const { model, dispatch, renderOptions } = props;
    return (react_1.default.createElement("div", { className: "diesel-json-editor" },
        react_1.default.createElement("div", { className: "diesel-json-editor-scrollpane" },
            !(renderOptions === null || renderOptions === void 0 ? void 0 : renderOptions.hideDocRoot) && (react_1.default.createElement("div", { className: 'doc-root' },
                react_1.default.createElement("em", null, model.t('documentRoot')),
                react_1.default.createElement(Renderer_1.ArrayCounter, { value: model.root.b }),
                react_1.default.createElement(Renderer_1.MenuTrigger, { dispatch: dispatch, path: JsPath_1.JsPath.empty, disabled: model.adding.isJust(), t: model.t, renderOptions: renderOptions }))),
            react_1.default.createElement(Renderer_1.ViewJsonValue, { model: model, path: JsPath_1.JsPath.empty, value: model.root.b, dispatch: dispatch, rendererFactory: props.rendererFactory, language: props.model.lang, renderOptions: renderOptions })),
        model.menuModel
            .map((menuModel) => (react_1.default.createElement("div", { className: 'diesel-json-editor-menu', key: 'editor-menu' },
            react_1.default.createElement(TPM.ViewMenu, { model: menuModel, dispatch: (0, tea_cup_core_1.map)(dispatch, Msg_1.contextMenuMsg), renderer: (0, ContextMenuRenderer_1.contextMenuRenderer)(model.t) }))))
            .withDefault(react_1.default.createElement(react_1.default.Fragment, null)),
        react_1.default.createElement("textarea", { id: 'dummy-textarea', "aria-label": 'hidden textarea' })));
}
exports.ViewJsonEditor = ViewJsonEditor;
function withOut(mac, outMsg) {
    return [mac[0], mac[1], outMsg];
}
function noOut(mac) {
    return withOut(mac, tea_cup_core_1.nothing);
}
function withOutValueChanged(prevModel, mac) {
    const prev = JSON.stringify((0, JsonValue_1.valueToAny)(prevModel.root.b));
    const cur = JSON.stringify((0, JsonValue_1.valueToAny)(mac[0].root.b));
    return [
        mac[0],
        mac[1],
        cur === prev ? tea_cup_core_1.nothing : (0, tea_cup_core_1.just)((0, OutMsg_1.outValueChanged)(mac[0].root.b)),
    ];
}
function update(msg, model, rendererFactory, menuFilter) {
    switch (msg.tag) {
        case 'delete-property':
            return withOutValueChanged(model, (0, Actions_1.actionDeleteValue)(model, msg.path));
        case 'update-property': {
            const mac = (0, Actions_1.actionUpdateValue)(model, msg.path, msg.value);
            return withOutValueChanged(model, mac);
        }
        case 'add-property-clicked':
            return noOut((0, Actions_1.actionAddPropertyClicked)(model, msg.path));
        case 'new-property-name-changed':
            return noOut((0, tea_cup_core_1.noCmd)((0, Model_1.updateAddingPropertyName)(model, msg.value)));
        case 'new-property-name-key-down':
            switch (msg.key) {
                case 'Enter':
                    return withOutValueChanged(model, (0, Actions_1.actionConfirmAddProperty)(model, true));
                case 'Escape':
                    return withOutValueChanged(model, (0, Actions_1.actionConfirmAddProperty)(model, false));
                default:
                    return noOut((0, tea_cup_core_1.noCmd)(model));
            }
        case 'add-prop-ok-cancel-clicked': {
            return withOutValueChanged(model, (0, Actions_1.actionConfirmAddProperty)(model, msg.ok));
        }
        case 'menu-trigger-clicked': {
            return noOut((0, Actions_1.actionTriggerClicked)(model, msg.path, msg.refBox, menuFilter));
        }
        case 'menu-msg': {
            return withOutValueChanged(model, model.menuModel
                .map((menuModel) => {
                const mco = TPM.update(msg.child, menuModel);
                const newModel = Object.assign(Object.assign({}, model), { menuModel: (0, tea_cup_core_1.just)(mco[0]) });
                const cmd = mco[1].map(Msg_1.contextMenuMsg);
                const outMsg = mco[2];
                return outMsg
                    .map((out) => {
                    switch (out.tag) {
                        case 'request-close': {
                            const mac2 = closeMenu(newModel);
                            return tea_cup_core_1.Tuple.fromNative(mac2)
                                .mapSecond((c) => tea_cup_core_1.Cmd.batch([cmd, c]))
                                .toNative();
                        }
                        case 'item-selected': {
                            return tea_cup_core_1.Tuple.fromNative((0, tea_cup_core_1.updatePiped)(model, (m) => closeMenu(m), (m) => (0, ContextMenu_1.executeContextMenuAction)(m, out.data)))
                                .mapSecond((c) => tea_cup_core_1.Cmd.batch([cmd, c]))
                                .toNative();
                        }
                    }
                    return tea_cup_core_1.Tuple.t2n(newModel, cmd);
                })
                    .withDefaultSupply(() => tea_cup_core_1.Tuple.t2n(newModel, cmd));
            })
                .withDefaultSupply(() => (0, tea_cup_core_1.noCmd)(model)));
        }
        case 'add-elem-clicked':
            return withOutValueChanged(model, (0, Actions_1.actionAddElementToArray)(model, msg.path));
        case 'set-json-str': {
            return noOut(init(model.lang, msg.schema, msg.json, model.strictMode, rendererFactory, model.debounceMs));
        }
        case 'toggle-expand-collapse': {
            return noOut((0, Actions_1.actionToggleExpandCollapsePath)(model, msg.path));
        }
        case 'add-property-btn-clicked': {
            return withOutValueChanged(model, (0, Actions_1.actionAddProperty)(model, msg.path, msg.propertyName));
        }
        case 'no-op':
            return noOut((0, tea_cup_core_1.noCmd)(model));
        case 'set-strict-mode':
            return noOut((0, tea_cup_core_1.noCmd)(setStrictMode(model, msg.strictMode)));
        case 'set-debounce-ms':
            return noOut((0, tea_cup_core_1.noCmd)(Object.assign(Object.assign({}, model), { debounceMs: msg.debounceMs })));
        case 'recompute-metadata': {
            const newModel = (0, Model_1.computeAll)((0, Model_1.doValidate)(model));
            return withOutValueChanged(model, reInitRenderers(newModel, rendererFactory));
        }
        case 'renderer-child-msg': {
            const rendererModel = model.customRenderers.get(msg.path);
            if (rendererModel && rendererModel.type === 'Just') {
                const renderer = rendererFactory.getRenderer(rendererModel.value.key);
                if (renderer.type === 'Just') {
                    const maco = renderer.value.update(msg.msg, rendererModel.value.rendererModel);
                    const newCustomRenderers = new Map(model.customRenderers);
                    const newCustomRendererModel = Object.assign(Object.assign({}, rendererModel.value), { rendererModel: maco[0] });
                    newCustomRenderers.set(msg.path, (0, tea_cup_core_1.just)(newCustomRendererModel));
                    const newModel = Object.assign(Object.assign({}, model), { customRenderers: newCustomRenderers });
                    const cmd = maco[1].map((childMsg) => {
                        return {
                            tag: 'renderer-child-msg',
                            msg: childMsg,
                            path: msg.path,
                        };
                    });
                    const newValue = maco[2];
                    switch (newValue.type) {
                        case 'Nothing': {
                            return noOut(tea_cup_core_1.Tuple.t2n(newModel, cmd));
                        }
                        case 'Just': {
                            const mac2 = (0, Actions_1.actionUpdateValue)(newModel, JsPath_1.JsPath.parse(msg.path), newValue.value);
                            return withOutValueChanged(model, [
                                mac2[0],
                                tea_cup_core_1.Cmd.batch([cmd, mac2[1]]),
                            ]);
                        }
                    }
                }
            }
            return noOut((0, tea_cup_core_1.noCmd)(model));
        }
    }
}
exports.update = update;
function closeMenu(model) {
    return (0, tea_cup_core_1.noCmd)(Object.assign(Object.assign({}, model), { menuModel: tea_cup_core_1.nothing }));
}
function setStrictMode(model, strictMode) {
    return Object.assign(Object.assign({}, model), { strictMode });
}
exports.setStrictMode = setStrictMode;
// the ports allow to send Msgs to the update loop from the outside
// TODO not a const !
exports.sendJsonPort = new tea_cup_core_1.Port();
exports.setStrictModePort = new tea_cup_core_1.Port();
exports.setDebounceMsPort = new tea_cup_core_1.Port();
function subscriptions(model) {
    // the menu's subs
    const subMenu = model.menuModel
        .map((mm) => TPM.subscriptions(mm).map(Msg_1.contextMenuMsg))
        .withDefaultSupply(() => tea_cup_core_1.Sub.none());
    // the ports subs
    const portSub = exports.sendJsonPort.subscribe(Msg_1.setJsonStr);
    const setStrictModePortSub = exports.setStrictModePort.subscribe(Msg_1.setStrictModeMsg);
    const setDebouceMsPortSub = exports.setDebounceMsPort.subscribe(Msg_1.setDebounceMsMsg);
    return tea_cup_core_1.Sub.batch([
        subMenu,
        portSub,
        setStrictModePortSub,
        setDebouceMsPortSub,
    ]);
}
exports.subscriptions = subscriptions;
function JsonEditor(props) {
    return (react_1.default.createElement(react_tea_cup_1.Program, { init: () => init(props.language, props.schema, props.value, props.strictMode, props.rendererFactory, props.debounceMs || 500), view: (dispatch, model) => (react_1.default.createElement(ViewJsonEditor, { dispatch: dispatch, model: model, rendererFactory: props.rendererFactory, renderOptions: props.renderOptions })), update: (msg, model) => {
            const maco = update(msg, model, props.rendererFactory, props.menuFilter);
            maco[2].forEach((outMsg) => {
                switch (outMsg.tag) {
                    case 'value-changed': {
                        props.onChange && props.onChange(outMsg.value);
                    }
                }
            });
            return [maco[0], maco[1]];
        }, subscriptions: subscriptions }));
}
exports.JsonEditor = JsonEditor;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSnNvbkVkaXRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9Kc29uRWRpdG9yLnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7Ozs7O0dBY0c7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBRUgsK0VBQWlFO0FBQ2pFLGtEQUEwQjtBQUMxQixpREFBd0M7QUFDeEMsK0NBWXNCO0FBQ3RCLGtEQUFvQztBQUNwQyx1Q0FTbUI7QUFDbkIsK0NBQXlEO0FBRXpELCtEQUE0RDtBQUM1RCwyQ0FBZ0U7QUFDaEUscUNBQWtDO0FBQ2xDLG1DQU9pQjtBQUNqQiwrQkFNZTtBQUNmLHFDQUFtRDtBQUNuRCxrREFLNkI7QUFHN0IsU0FBZ0IsSUFBSSxDQUNsQixRQUFnQixFQUNoQixNQUF3QixFQUN4QixZQUF1QixFQUN2QixVQUFtQixFQUNuQixlQUFnQyxFQUNoQyxVQUFrQjtJQUVsQixRQUFRLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQzNCLE1BQU0sS0FBSyxHQUFHLElBQUEsb0JBQVksRUFDeEIsUUFBUSxFQUNSLE1BQU0sRUFDTixZQUFZLEVBQ1osVUFBVSxFQUNWLFVBQVUsQ0FDWCxDQUFDO0lBQ0YsT0FBTyxlQUFlLENBQUMsS0FBSyxFQUFFLGVBQWUsQ0FBQyxDQUFDO0FBQ2pELENBQUM7QUFqQkQsb0JBaUJDO0FBRUQsU0FBUyxlQUFlLENBQ3RCLEtBQVksRUFDWixxQkFBc0M7SUFFdEMsT0FBTyxLQUFLLENBQUMsZ0JBQWdCO1NBQzFCLEdBQUcsQ0FBQyxDQUFDLGdCQUFnQixFQUFFLEVBQUU7UUFDeEIsTUFBTSxTQUFTLEdBQUcsUUFBUSxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQzFELE1BQU0sa0JBQWtCLEdBR3BCLElBQUksR0FBRyxFQUFFLENBQUM7UUFDZCxNQUFNLElBQUksR0FBZSxFQUFFLENBQUM7UUFDNUIsS0FBSyxNQUFNLENBQUMsSUFBSSxFQUFF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O1lBQ0gsQ0FBQyxDQUFDLENBQUM7WUFDSCxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzVCLENBQUMsRUFDRCxhQUFhLEVBQUUsYUFBYSxHQUU1QixDQUNILENBQUM7QUFDSixDQUFDO0FBekNELGdDQXlDQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgMjAxOCBUaGUgRGllc2VsIEF1dGhvcnNcbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0ICogYXMgSnNGYWNhZGUgZnJvbSAnQGRpZXNlbC1wYXJzZXIvanNvbi1zY2hlbWEtZmFjYWRlLXRzJztcbmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyBQcm9ncmFtIH0gZnJvbSAncmVhY3QtdGVhLWN1cCc7XG5pbXBvcnQge1xuICBDbWQsXG4gIERpc3BhdGNoZXIsXG4gIGp1c3QsXG4gIG1hcCxcbiAgTWF5YmUsXG4gIG5vQ21kLFxuICBub3RoaW5nLFxuICBQb3J0LFxuICBTdWIsXG4gIFR1cGxlLFxuICB1cGRhdGVQaXBlZCxcbn0gZnJvbSAndGVhLWN1cC1jb3JlJztcbmltcG9ydCAqIGFzIFRQTSBmcm9tICd0ZWEtcG9wLW1lbnUnO1xuaW1wb3J0IHtcbiAgYWN0aW9uQWRkRWxlbWVudFRvQXJyYXksXG4gIGFjdGlvbkFkZFByb3BlcnR5LFxuICBhY3Rpb25BZGRQcm9wZXJ0eUNsaWNrZWQsXG4gIGFjdGlvbkNvbmZpcm1BZGRQcm9wZXJ0eSxcbiAgYWN0aW9uRGVsZXRlVmFsdWUsXG4gIGFjdGlvblRvZ2dsZUV4cGFuZENvbGxhcHNlUGF0aCxcbiAgYWN0aW9uVHJpZ2dlckNsaWNrZWQsXG4gIGFjdGlvblVwZGF0ZVZhbHVlLFxufSBmcm9tICcuL0FjdGlvbnMnO1xuaW1wb3J0IHsgZXhlY3V0ZUNvbnRleHRNZW51QWN0aW9uIH0gZnJvbSAnLi9Db250ZXh0TWVudSc7XG5pbXBvcnQgeyBNZW51QWN0aW9uIH0gZnJvbSAnLi9Db250ZXh0TWVudUFjdGlvbnMnO1xuaW1wb3J0IHsgY29udGV4dE1lbnVSZW5kZXJlciB9IGZyb20gJy4vQ29udGV4dE1lbnVSZW5kZXJlcic7XG5pbXBvcnQgeyBnZXRWYWx1ZUF0LCBKc29uVmFsdWUsIHZhbHVlVG9BbnkgfSBmcm9tICcuL0pzb25WYWx1ZSc7XG5pbXBvcnQgeyBKc1BhdGggfSBmcm9tICcuL0pzUGF0aCc7XG5pbXBvcnQge1xuICBjb21wdXRlQWxsLFxuICBDdXN0b21SZW5kZXJlck1vZGVsLFxuICBkb1ZhbGlkYXRlLFxuICBpbml0aWFsTW9kZWwsXG4gIE1vZGVsLFxuICB1cGRhdGVBZGRpbmdQcm9wZXJ0eU5hbWUsXG59IGZyb20gJy4vTW9kZWwnO1xuaW1wb3J0IHtcbiAgY29udGV4dE1lbnVNc2csXG4gIE1zZyxcbiAgc2V0RGVib3VuY2VNc01zZyxcbiAgc2V0SnNvblN0cixcbiAgc2V0U3RyaWN0TW9kZU1zZyxcbn0gZnJvbSAnLi9Nc2cnO1xuaW1wb3J0IHsgT3V0TXNnLCBvdXRWYWx1ZUNoYW5nZWQgfSBmcm9tICcuL091dE1zZyc7XG5pbXBvcnQge1xuICBBcnJheUNvdW50ZXIsXG4gIE1lbnVUcmlnZ2VyLFxuICBSZW5kZXJlckZhY3RvcnksXG4gIFZpZXdKc29uVmFsdWUsXG59IGZyb20gJy4vcmVuZGVyZXIvUmVuZGVyZXInO1xuaW1wb3J0IHsgTWVudU9wdGlvbkZpbHRlciwgUmVuZGVyT3B0aW9ucyB9IGZyb20gJy4vUmVuZGVyT3B0aW9ucyc7XG5cbmV4cG9ydCBmdW5jdGlvbiBpbml0KFxuICBsYW5ndWFnZTogc3RyaW5nLFxuICBzY2hlbWE6IE1heWJlPEpzb25WYWx1ZT4sXG4gIGluaXRpYWxWYWx1ZTogSnNvblZhbHVlLFxuICBzdHJpY3RNb2RlOiBib29sZWFuLFxuICByZW5kZXJlckZhY3Rvcnk6IFJlbmRlcmVyRmFjdG9yeSxcbiAgZGVib3VuY2VNczogbnVtYmVyLFxuKTogW01vZGVsLCBDbWQ8TXNnPl0ge1xuICBKc0ZhY2FkZS5zZXRMYW5nKGxhbmd1YWdlKTtcbiAgY29uc3QgbW9kZWwgPSBpbml0aWFsTW9kZWwoXG4gICAgbGFuZ3VhZ2UsXG4gICAgc2NoZW1hLFxuICAgIGluaXRpYWxWYWx1ZSxcbiAgICBzdHJpY3RNb2RlLFxuICAgIGRlYm91bmNlTXMsXG4gICk7XG4gIHJldHVybiByZUluaXRSZW5kZXJlcnMobW9kZWwsIHJlbmRlcmVyRmFjdG9yeSk7XG59XG5cbmZ1bmN0aW9uIHJlSW5pdFJlbmRlcmVycyhcbiAgbW9kZWw6IE1vZGVsLFxuICBjdXN0b21SZW5kZXJlckZhY3Rvcnk6IFJlbmRlcmVyRmFjdG9yeSxcbik6IFtNb2RlbCwgQ21kPE1zZz5dIHtcbiAgcmV0dXJuIG1vZGVsLnZhbGlkYXRpb25SZXN1bHRcbiAgICAubWFwKCh2YWxpZGF0aW9uUmVzdWx0KSA9PiB7XG4gICAgICBjb25zdCByZW5kZXJlcnMgPSBKc0ZhY2FkZS5nZXRSZW5kZXJlcnModmFsaWRhdGlvblJlc3VsdCk7XG4gICAgICBjb25zdCBuZXdDdXN0b21SZW5kZXJlcnM6IE1hcDxcbiAgICAgICAgc3RyaW5nLFxuICAgICAgICBNYXliZTxDdXN0b21SZW5kZXJlck1vZGVsPlxuICAgICAgPiA9IG5ldyBNYXAoKTtcbiAgICAgIGNvbnN0IGNtZHM6IENtZDxNc2c+W10gPSBbXTtcbiAgICAgIGZvciAoY29uc3QgW3BhdGgsIHJlbmRlcmVyRGVmXSBvZiByZW5kZXJlcnMpIHtcbiAgICAgICAgaWYgKHJlbmRlcmVyRGVmICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICBjb25zdCBrZXkgPSByZW5kZXJlckRlZi5rZXk7XG4gICAgICAgICAgY29uc3QgcmVuZGVyZXIgPSBjdXN0b21SZW5kZXJlckZhY3RvcnkuZ2V0UmVuZGVyZXIoa2V5KTtcbiAgICAgICAgICBpZiAocmVuZGVyZXIudHlwZSA9PT0gJ0p1c3QnKSB7XG4gICAgICAgICAgICBjb25zdCBleGlzdGluZ01vZGVsID0gbW9kZWwuY3VzdG9tUmVuZGVyZXJzLmdldChwYXRoKTtcbiAgICAgICAgICAgIGNvbnN0IG06IE1heWJlPEN1c3RvbVJlbmRlcmVyTW9kZWw+ID1cbiAgICAgICAgICAgICAgZXhpc3RpbmdNb2RlbCA9PT0gdW5kZWZpbmVkID8gbm90aGluZyA6IGV4aXN0aW5nTW9kZWw7XG4gICAgICAgICAgICBjb25zdCBqVmFsdWU6IE1heWJlPEpzb25WYWx1ZT4gPSBnZXRWYWx1ZUF0KFxuICAgICAgICAgICAgICBtb2RlbC5yb290LmIsXG4gICAgICAgICAgICAgIEpzUGF0aC5wYXJzZShwYXRoKSxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBpZiAoalZhbHVlLnR5cGUgPT09ICdKdXN0Jykge1xuICAgICAgICAgICAgICBjb25zdCBtYWMgPSByZW5kZXJlci52YWx1ZS5yZWluaXQoe1xuICAgICAgICAgICAgICAgIHBhdGg6IEpzUGF0aC5wYXJzZShwYXRoKSxcbiAgICAgICAgICAgICAgICBmb3JtTW9kZWw6IG1vZGVsLFxuICAgICAgICAgICAgICAgIHZhbHVlOiBqVmFsdWUudmFsdWUsXG4gICAgICAgICAgICAgICAgbW9kZWw6IG0ubWFwKCh4KSA9PiB4LnJlbmRlcmVyTW9kZWwpLFxuICAgICAgICAgICAgICAgIHNjaGVtYTogcmVuZGVyZXJEZWYuc2NoZW1hVmFsdWUsXG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICBjb25zdCBjdXN0b21SZW5kZXJlck1vZGVsOiBDdXN0b21SZW5kZXJlck1vZGVsID0ge1xuICAgICAgICAgICAgICAgIHJlbmRlcmVyTW9kZWw6IG1hY1swXSxcbiAgICAgICAgICAgICAgICBrZXksXG4gICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgIG5ld0N1c3RvbVJlbmRlcmVycy5zZXQocGF0aCwganVzdChjdXN0b21SZW5kZXJlck1vZGVsKSk7XG4gICAgICAgICAgICAgIGNvbnN0IGNtZDogQ21kPE1zZz4gPSBtYWNbMV0ubWFwKChtc2c6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICB0YWc6ICdyZW5kZXJlci1jaGlsZC1tc2cnLFxuICAgICAgICAgICAgICAgICAgcGF0aCxcbiAgICAgICAgICAgICAgICAgIG1zZyxcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgY21kcy5wdXNoKGNtZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBjb25zdCBuZXdNb2RlbDogTW9kZWwgPSB7XG4gICAgICAgIC4uLm1vZGVsLFxuICAgICAgICBjdXN0b21SZW5kZXJlcnM6IG5ld0N1c3RvbVJlbmRlcmVycyxcbiAgICAgIH07XG4gICAgICByZXR1cm4gVHVwbGUudDJuKG5ld01vZGVsLCBDbWQuYmF0Y2goY21kcykpO1xuICAgIH0pXG4gICAgLndpdGhEZWZhdWx0U3VwcGx5KCgpID0+IG5vQ21kKG1vZGVsKSk7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVmlld0pzb25FZGl0b3JQcm9wcyB7XG4gIHJlYWRvbmx5IGRpc3BhdGNoOiBEaXNwYXRjaGVyPE1zZz47XG4gIHJlYWRvbmx5IG1vZGVsOiBNb2RlbDtcbiAgcmVhZG9ubHkgcmVuZGVyZXJGYWN0b3J5OiBSZW5kZXJlckZhY3Rvcnk7XG4gIHJlYWRvbmx5IHJlbmRlck9wdGlvbnM/OiBSZW5kZXJPcHRpb25zO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gVmlld0pzb25FZGl0b3IocHJvcHM6IFZpZXdKc29uRWRpdG9yUHJvcHMpIHtcbiAgY29uc3QgeyBtb2RlbCwgZGlzcGF0Y2gsIHJlbmRlck9wdGlvbnMgfSA9IHByb3BzO1xuICByZXR1cm4gKFxuICAgIDxkaXYgY2xhc3NOYW1lPVwiZGllc2VsLWpzb24tZWRpdG9yXCI+XG4gICAgICA8ZGl2IGNsYXNzTmFtZT1cImRpZXNlbC1qc29uLWVkaXRvci1zY3JvbGxwYW5lXCI+XG4gICAgICAgIHshcmVuZGVyT3B0aW9ucz8uaGlkZURvY1Jvb3QgJiYgKFxuICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPXsnZG9jLXJvb3QnfT5cbiAgICAgICAgICAgIDxlbT57bW9kZWwudCgnZG9jdW1lbnRSb290Jyl9PC9lbT5cbiAgICAgICAgICAgIDxBcnJheUNvdW50ZXIgdmFsdWU9e21vZGVsLnJvb3QuYn0gLz5cbiAgICAgICAgICAgIDxNZW51VHJpZ2dlclxuICAgICAgICAgICAgICBkaXNwYXRjaD17ZGlzcGF0Y2h9XG4gICAgICAgICAgICAgIHBhdGg9e0pzUGF0aC5lbXB0eX1cbiAgICAgICAgICAgICAgZGlzYWJsZWQ9e21vZGVsLmFkZGluZy5pc0p1c3QoKX1cbiAgICAgICAgICAgICAgdD17bW9kZWwudH1cbiAgICAgICAgICAgICAgcmVuZGVyT3B0aW9ucz17cmVuZGVyT3B0aW9uc31cbiAgICAgICAgICAgIC8+XG4gICAgICAgICAgPC9kaXY+XG4gICAgICAgICl9XG4gICAgICAgIDxWaWV3SnNvblZhbHVlXG4gICAgICAgICAgbW9kZWw9e21vZGVsfVxuICAgICAgICAgIHBhdGg9e0pzUGF0aC5lbXB0eX1cbiAgICAgICAgICB2YWx1ZT17bW9kZWwucm9vdC5ifVxuICAgICAgICAgIGRpc3BhdGNoPXtkaXNwYXRjaH1cbiAgICAgICAgICByZW5kZXJlckZhY3Rvcnk9e3Byb3BzLnJlbmRlcmVyRmFjdG9yeX1cbiAgICAgICAgICBsYW5ndWFnZT17cHJvcHMubW9kZWwubGFuZ31cbiAgICAgICAgICByZW5kZXJPcHRpb25zPXtyZW5kZXJPcHRpb25zfVxuICAgICAgICAvPlxuICAgICAgPC9kaXY+XG4gICAgICB7bW9kZWwubWVudU1vZGVsXG4gICAgICAgIC5tYXAoKG1lbnVNb2RlbCkgPT4gKFxuICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPXsnZGllc2VsLWpzb24tZWRpdG9yLW1lbnUnfSBrZXk9eydlZGl0b3ItbWVudSd9PlxuICAgICAgICAgICAgPFRQTS5WaWV3TWVudVxuICAgICAgICAgICAgICBtb2RlbD17bWVudU1vZGVsfVxuICAgICAgICAgICAgICBkaXNwYXRjaD17bWFwKGRpc3BhdGNoLCBjb250ZXh0TWVudU1zZyl9XG4gICAgICAgICAgICAgIHJlbmRlcmVyPXtjb250ZXh0TWVudVJlbmRlcmVyKG1vZGVsLnQpfVxuICAgICAgICAgICAgLz5cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgKSlcbiAgICAgICAgLndpdGhEZWZhdWx0KDw+PC8+KX1cbiAgICAgIDx0ZXh0YXJlYSBpZD17J2R1bW15LXRleHRhcmVhJ30gYXJpYS1sYWJlbD17J2hpZGRlbiB0ZXh0YXJlYSd9IC8+XG4gICAgPC9kaXY+XG4gICk7XG59XG5cbmZ1bmN0aW9uIHdpdGhPdXQoXG4gIG1hYzogW01vZGVsLCBDbWQ8TXNnPl0sXG4gIG91dE1zZzogTWF5YmU8T3V0TXNnPixcbik6IFtNb2RlbCwgQ21kPE1zZz4sIE1heWJlPE91dE1zZz5dIHtcbiAgcmV0dXJuIFttYWNbMF0sIG1hY1sxXSwgb3V0TXNnXTtcbn1cblxuZnVuY3Rpb24gbm9PdXQobWFjOiBbTW9kZWwsIENtZDxNc2c+XSk6IFtNb2RlbCwgQ21kPE1zZz4sIE1heWJlPE91dE1zZz5dIHtcbiAgcmV0dXJuIHdpdGhPdXQobWFjLCBub3RoaW5nKTtcbn1cblxuZnVuY3Rpb24gd2l0aE91dFZhbHVlQ2hhbmdlZChcbiAgcHJldk1vZGVsOiBNb2RlbCxcbiAgbWFjOiBbTW9kZWwsIENtZDxNc2c+XSxcbik6IFtNb2RlbCwgQ21kPE1zZz4sIE1heWJlPE91dE1zZz5dIHtcbiAgY29uc3QgcHJldiA9IEpTT04uc3RyaW5naWZ5KHZhbHVlVG9BbnkocHJldk1vZGVsLnJvb3QuYikpO1xuICBjb25zdCBjdXIgPSBKU09OLnN0cmluZ2lmeSh2YWx1ZVRvQW55KG1hY1swXS5yb290LmIpKTtcbiAgcmV0dXJuIFtcbiAgICBtYWNbMF0sXG4gICAgbWFjWzFdLFxuICAgIGN1ciA9PT0gcHJldiA/IG5vdGhpbmcgOiBqdXN0KG91dFZhbHVlQ2hhbmdlZChtYWNbMF0ucm9vdC5iKSksXG4gIF07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB1cGRhdGUoXG4gIG1zZzogTXNnLFxuICBtb2RlbDogTW9kZWwsXG4gIHJlbmRlcmVyRmFjdG9yeTogUmVuZGVyZXJGYWN0b3J5LFxuICBtZW51RmlsdGVyPzogTWVudU9wdGlvbkZpbHRlcixcbik6IFtNb2RlbCwgQ21kPE1zZz4sIE1heWJlPE91dE1zZz5dIHtcbiAgc3dpdGNoIChtc2cudGFnKSB7XG4gICAgY2FzZSAnZGVsZXRlLXByb3BlcnR5JzpcbiAgICAgIHJldHVybiB3aXRoT3V0VmFsdWVDaGFuZ2VkKG1vZGVsLCBhY3Rpb25EZWxldGVWYWx1ZShtb2RlbCwgbXNnLnBhdGgpKTtcbiAgICBjYXNlICd1cGRhdGUtcHJvcGVydHknOiB7XG4gICAgICBjb25zdCBtYWMgPSBhY3Rpb25VcGRhdGVWYWx1ZShtb2RlbCwgbXNnLnBhdGgsIG1zZy52YWx1ZSk7XG4gICAgICByZXR1cm4gd2l0aE91dFZhbHVlQ2hhbmdlZChtb2RlbCwgbWFjKTtcbiAgICB9XG4gICAgY2FzZSAnYWRkLXByb3BlcnR5LWNsaWNrZWQnOlxuICAgICAgcmV0dXJuIG5vT3V0KGFjdGlvbkFkZFByb3BlcnR5Q2xpY2tlZChtb2RlbCwgbXNnLnBhdGgpKTtcbiAgICBjYXNlICduZXctcHJvcGVydHktbmFtZS1jaGFuZ2VkJzpcbiAgICAgIHJldHVybiBub091dChub0NtZCh1cGRhdGVBZGRpbmdQcm9wZXJ0eU5hbWUobW9kZWwsIG1zZy52YWx1ZSkpKTtcbiAgICBjYXNlICduZXctcHJvcGVydHktbmFtZS1rZXktZG93bic6XG4gICAgICBzd2l0Y2ggKG1zZy5rZXkpIHtcbiAgICAgICAgY2FzZSAnRW50ZXInOlxuICAgICAgICAgIHJldHVybiB3aXRoT3V0VmFsdWVDaGFuZ2VkKFxuICAgICAgICAgICAgbW9kZWwsXG4gICAgICAgICAgICBhY3Rpb25Db25maXJtQWRkUHJvcGVydHkobW9kZWwsIHRydWUpLFxuICAgICAgICAgICk7XG4gICAgICAgIGNhc2UgJ0VzY2FwZSc6XG4gICAgICAgICAgcmV0dXJuIHdpdGhPdXRWYWx1ZUNoYW5nZWQoXG4gICAgICAgICAgICBtb2RlbCxcbiAgICAgICAgICAgIGFjdGlvbkNvbmZpcm1BZGRQcm9wZXJ0eShtb2RlbCwgZmFsc2UpLFxuICAgICAgICAgICk7XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgcmV0dXJuIG5vT3V0KG5vQ21kKG1vZGVsKSk7XG4gICAgICB9XG4gICAgY2FzZSAnYWRkLXByb3Atb2stY2FuY2VsLWNsaWNrZWQnOiB7XG4gICAgICByZXR1cm4gd2l0aE91dFZhbHVlQ2hhbmdlZChcbiAgICAgICAgbW9kZWwsXG4gICAgICAgIGFjdGlvbkNvbmZpcm1BZGRQcm9wZXJ0eShtb2RlbCwgbXNnLm9rKSxcbiAgICAgICk7XG4gICAgfVxuICAgIGNhc2UgJ21lbnUtdHJpZ2dlci1jbGlja2VkJzoge1xuICAgICAgcmV0dXJuIG5vT3V0KFxuICAgICAgICBhY3Rpb25UcmlnZ2VyQ2xpY2tlZChtb2RlbCwgbXNnLnBhdGgsIG1zZy5yZWZCb3gsIG1lbnVGaWx0ZXIpLFxuICAgICAgKTtcbiAgICB9XG4gICAgY2FzZSAnbWVudS1tc2cnOiB7XG4gICAgICByZXR1cm4gd2l0aE91dFZhbHVlQ2hhbmdlZChcbiAgICAgICAgbW9kZWwsXG4gICAgICAgIG1vZGVsLm1lbnVNb2RlbFxuICAgICAgICAgIC5tYXAoKG1lbnVNb2RlbCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgbWNvID0gVFBNLnVwZGF0ZShtc2cuY2hpbGQsIG1lbnVNb2RlbCk7XG4gICAgICAgICAgICBjb25zdCBuZXdNb2RlbDogTW9kZWwgPSB7XG4gICAgICAgICAgICAgIC4uLm1vZGVsLFxuICAgICAgICAgICAgICBtZW51TW9kZWw6IGp1c3QobWNvWzBdKSxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBjb25zdCBjbWQ6IENtZDxNc2c+ID0gbWNvWzFdLm1hcChjb250ZXh0TWVudU1zZyk7XG4gICAgICAgICAgICBjb25zdCBvdXRNc2c6IE1heWJlPFRQTS5PdXRNc2c8TWVudUFjdGlvbj4+ID0gbWNvWzJdO1xuICAgICAgICAgICAgcmV0dXJuIG91dE1zZ1xuICAgICAgICAgICAgICAubWFwPFtNb2RlbCwgQ21kPE1zZz5dPigob3V0KSA9PiB7XG4gICAgICAgICAgICAgICAgc3dpdGNoIChvdXQudGFnKSB7XG4gICAgICAgICAgICAgICAgICBjYXNlICdyZXF1ZXN0LWNsb3NlJzoge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBtYWMyID0gY2xvc2VNZW51KG5ld01vZGVsKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFR1cGxlLmZyb21OYXRpdmUobWFjMilcbiAgICAgICAgICAgICAgICAgICAgICAubWFwU2Vjb25kKChjKSA9PiBDbWQuYmF0Y2goW2NtZCwgY10pKVxuICAgICAgICAgICAgICAgICAgICAgIC50b05hdGl2ZSgpO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgY2FzZSAnaXRlbS1zZWxlY3RlZCc6IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFR1cGxlLmZyb21OYXRpdmUoXG4gICAgICAgICAgICAgICAgICAgICAgdXBkYXRlUGlwZWQoXG4gICAgICAgICAgICAgICAgICAgICAgICBtb2RlbCxcbiAgICAgICAgICAgICAgICAgICAgICAgIChtKSA9PiBjbG9zZU1lbnUobSksXG4gICAgICAgICAgICAgICAgICAgICAgICAobSkgPT4gZXhlY3V0ZUNvbnRleHRNZW51QWN0aW9uKG0sIG91dC5kYXRhKSxcbiAgICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICAgLm1hcFNlY29uZCgoYykgPT4gQ21kLmJhdGNoKFtjbWQsIGNdKSlcbiAgICAgICAgICAgICAgICAgICAgICAudG9OYXRpdmUoKTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIFR1cGxlLnQybihuZXdNb2RlbCwgY21kKTtcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgLndpdGhEZWZhdWx0U3VwcGx5KCgpID0+IFR1cGxlLnQybihuZXdNb2RlbCwgY21kKSk7XG4gICAgICAgICAgfSlcbiAgICAgICAgICAud2l0aERlZmF1bHRTdXBwbHkoKCkgPT4gbm9DbWQobW9kZWwpKSxcbiAgICAgICk7XG4gICAgfVxuICAgIGNhc2UgJ2FkZC1lbGVtLWNsaWNrZWQnOlxuICAgICAgcmV0dXJuIHdpdGhPdXRWYWx1ZUNoYW5nZWQoXG4gICAgICAgIG1vZGVsLFxuICAgICAgICBhY3Rpb25BZGRFbGVtZW50VG9BcnJheShtb2RlbCwgbXNnLnBhdGgpLFxuICAgICAgKTtcbiAgICBjYXNlICdzZXQtanNvbi1zdHInOiB7XG4gICAgICByZXR1cm4gbm9PdXQoXG4gICAgICAgIGluaXQoXG4gICAgICAgICAgbW9kZWwubGFuZyxcbiAgICAgICAgICBtc2cuc2NoZW1hLFxuICAgICAgICAgIG1zZy5qc29uLFxuICAgICAgICAgIG1vZGVsLnN0cmljdE1vZGUsXG4gICAgICAgICAgcmVuZGVyZXJGYWN0b3J5LFxuICAgICAgICAgIG1vZGVsLmRlYm91bmNlTXMsXG4gICAgICAgICksXG4gICAgICApO1xuICAgIH1cbiAgICBjYXNlICd0b2dnbGUtZXhwYW5kLWNvbGxhcHNlJzoge1xuICAgICAgcmV0dXJuIG5vT3V0KGFjdGlvblRvZ2dsZUV4cGFuZENvbGxhcHNlUGF0aChtb2RlbCwgbXNnLnBhdGgpKTtcbiAgICB9XG4gICAgY2FzZSAnYWRkLXByb3BlcnR5LWJ0bi1jbGlja2VkJzoge1xuICAgICAgcmV0dXJuIHdpdGhPdXRWYWx1ZUNoYW5nZWQoXG4gICAgICAgIG1vZGVsLFxuICAgICAgICBhY3Rpb25BZGRQcm9wZXJ0eShtb2RlbCwgbXNnLnBhdGgsIG1zZy5wcm9wZXJ0eU5hbWUpLFxuICAgICAgKTtcbiAgICB9XG4gICAgY2FzZSAnbm8tb3AnOlxuICAgICAgcmV0dXJuIG5vT3V0KG5vQ21kKG1vZGVsKSk7XG4gICAgY2FzZSAnc2V0LXN0cmljdC1tb2RlJzpcbiAgICAgIHJldHVybiBub091dChub0NtZChzZXRTdHJpY3RNb2RlKG1vZGVsLCBtc2cuc3RyaWN0TW9kZSkpKTtcbiAgICBjYXNlICdzZXQtZGVib3VuY2UtbXMnOlxuICAgICAgcmV0dXJuIG5vT3V0KG5vQ21kKHsgLi4ubW9kZWwsIGRlYm91bmNlTXM6IG1zZy5kZWJvdW5jZU1zIH0pKTtcbiAgICBjYXNlICdyZWNvbXB1dGUtbWV0YWRhdGEnOiB7XG4gICAgICBjb25zdCBuZXdNb2RlbCA9IGNvbXB1dGVBbGwoZG9WYWxpZGF0ZShtb2RlbCkpO1xuICAgICAgcmV0dXJuIHdpdGhPdXRWYWx1ZUNoYW5nZWQoXG4gICAgICAgIG1vZGVsLFxuICAgICAgICByZUluaXRSZW5kZXJlcnMobmV3TW9kZWwsIHJlbmRlcmVyRmFjdG9yeSksXG4gICAgICApO1xuICAgIH1cbiAgICBjYXNlICdyZW5kZXJlci1jaGlsZC1tc2cnOiB7XG4gICAgICBjb25zdCByZW5kZXJlck1vZGVsID0gbW9kZWwuY3VzdG9tUmVuZGVyZXJzLmdldChtc2cucGF0aCk7XG4gICAgICBpZiAocmVuZGVyZXJNb2RlbCAmJiByZW5kZXJlck1vZGVsLnR5cGUgPT09ICdKdXN0Jykge1xuICAgICAgICBjb25zdCByZW5kZXJlciA9IHJlbmRlcmVyRmFjdG9yeS5nZXRSZW5kZXJlcihyZW5kZXJlck1vZGVsLnZhbHVlLmtleSk7XG4gICAgICAgIGlmIChyZW5kZXJlci50eXBlID09PSAnSnVzdCcpIHtcbiAgICAgICAgICBjb25zdCBtYWNvID0gcmVuZGVyZXIudmFsdWUudXBkYXRlKFxuICAgICAgICAgICAgbXNnLm1zZyxcbiAgICAgICAgICAgIHJlbmRlcmVyTW9kZWwudmFsdWUucmVuZGVyZXJNb2RlbCxcbiAgICAgICAgICApO1xuICAgICAgICAgIGNvbnN0IG5ld0N1c3RvbVJlbmRlcmVyczogTWFwPFxuICAgICAgICAgICAgc3RyaW5nLFxuICAgICAgICAgICAgTWF5YmU8Q3VzdG9tUmVuZGVyZXJNb2RlbD5cbiAgICAgICAgICA+ID0gbmV3IE1hcChtb2RlbC5jdXN0b21SZW5kZXJlcnMpO1xuICAgICAgICAgIGNvbnN0IG5ld0N1c3RvbVJlbmRlcmVyTW9kZWw6IEN1c3RvbVJlbmRlcmVyTW9kZWwgPSB7XG4gICAgICAgICAgICAuLi5yZW5kZXJlck1vZGVsLnZhbHVlLFxuICAgICAgICAgICAgcmVuZGVyZXJNb2RlbDogbWFjb1swXSxcbiAgICAgICAgICB9O1xuICAgICAgICAgIG5ld0N1c3RvbVJlbmRlcmVycy5zZXQobXNnLnBhdGgsIGp1c3QobmV3Q3VzdG9tUmVuZGVyZXJNb2RlbCkpO1xuICAgICAgICAgIGNvbnN0IG5ld01vZGVsOiBNb2RlbCA9IHtcbiAgICAgICAgICAgIC4uLm1vZGVsLFxuICAgICAgICAgICAgY3VzdG9tUmVuZGVyZXJzOiBuZXdDdXN0b21SZW5kZXJlcnMsXG4gICAgICAgICAgfTtcbiAgICAgICAgICBjb25zdCBjbWQ6IENtZDxNc2c+ID0gbWFjb1sxXS5tYXAoKGNoaWxkTXNnKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICB0YWc6ICdyZW5kZXJlci1jaGlsZC1tc2cnLFxuICAgICAgICAgICAgICBtc2c6IGNoaWxkTXNnLFxuICAgICAgICAgICAgICBwYXRoOiBtc2cucGF0aCxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgY29uc3QgbmV3VmFsdWU6IE1heWJlPEpzb25WYWx1ZT4gPSBtYWNvWzJdO1xuICAgICAgICAgIHN3aXRjaCAobmV3VmFsdWUudHlwZSkge1xuICAgICAgICAgICAgY2FzZSAnTm90aGluZyc6IHtcbiAgICAgICAgICAgICAgcmV0dXJuIG5vT3V0KFR1cGxlLnQybihuZXdNb2RlbCwgY21kKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjYXNlICdKdXN0Jzoge1xuICAgICAgICAgICAgICBjb25zdCBtYWMyID0gYWN0aW9uVXBkYXRlVmFsdWUoXG4gICAgICAgICAgICAgICAgbmV3TW9kZWwsXG4gICAgICAgICAgICAgICAgSnNQYXRoLnBhcnNlKG1zZy5wYXRoKSxcbiAgICAgICAgICAgICAgICBuZXdWYWx1ZS52YWx1ZSxcbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgcmV0dXJuIHdpdGhPdXRWYWx1ZUNoYW5nZWQobW9kZWwsIFtcbiAgICAgICAgICAgICAgICBtYWMyWzBdLFxuICAgICAgICAgICAgICAgIENtZC5iYXRjaChbY21kLCBtYWMyWzFdXSksXG4gICAgICAgICAgICAgIF0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIG5vT3V0KG5vQ21kKG1vZGVsKSk7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIGNsb3NlTWVudShtb2RlbDogTW9kZWwpOiBbTW9kZWwsIENtZDxNc2c+XSB7XG4gIHJldHVybiBub0NtZCh7XG4gICAgLi4ubW9kZWwsXG4gICAgbWVudU1vZGVsOiBub3RoaW5nLFxuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNldFN0cmljdE1vZGUobW9kZWw6IE1vZGVsLCBzdHJpY3RNb2RlOiBib29sZWFuKTogTW9kZWwge1xuICByZXR1cm4geyAuLi5tb2RlbCwgc3RyaWN0TW9kZSB9O1xufVxuXG4vLyB0aGUgcG9ydHMgYWxsb3cgdG8gc2VuZCBNc2dzIHRvIHRoZSB1cGRhdGUgbG9vcCBmcm9tIHRoZSBvdXRzaWRlXG4vLyBUT0RPIG5vdCBhIGNvbnN0ICFcbmV4cG9ydCBjb25zdCBzZW5kSnNvblBvcnQgPSBuZXcgUG9ydDxbTWF5YmU8SnNvblZhbHVlPiwgSnNvblZhbHVlXT4oKTtcblxuZXhwb3J0IGNvbnN0IHNldFN0cmljdE1vZGVQb3J0ID0gbmV3IFBvcnQ8Ym9vbGVhbj4oKTtcblxuZXhwb3J0IGNvbnN0IHNldERlYm91bmNlTXNQb3J0ID0gbmV3IFBvcnQ8bnVtYmVyPigpO1xuXG5leHBvcnQgZnVuY3Rpb24gc3Vic2NyaXB0aW9ucyhtb2RlbDogTW9kZWwpOiBTdWI8TXNnPiB7XG4gIC8vIHRoZSBtZW51J3Mgc3Vic1xuICBjb25zdCBzdWJNZW51ID0gbW9kZWwubWVudU1vZGVsXG4gICAgLm1hcCgobW0pID0+IFRQTS5zdWJzY3JpcHRpb25zKG1tKS5tYXAoY29udGV4dE1lbnVNc2cpKVxuICAgIC53aXRoRGVmYXVsdFN1cHBseSgoKSA9PiBTdWIubm9uZSgpKTtcbiAgLy8gdGhlIHBvcnRzIHN1YnNcbiAgY29uc3QgcG9ydFN1YiA9IHNlbmRKc29uUG9ydC5zdWJzY3JpYmUoc2V0SnNvblN0cik7XG4gIGNvbnN0IHNldFN0cmljdE1vZGVQb3J0U3ViID0gc2V0U3RyaWN0TW9kZVBvcnQuc3Vic2NyaWJlKHNldFN0cmljdE1vZGVNc2cpO1xuICBjb25zdCBzZXREZWJvdWNlTXNQb3J0U3ViID0gc2V0RGVib3VuY2VNc1BvcnQuc3Vic2NyaWJlKHNldERlYm91bmNlTXNNc2cpO1xuICByZXR1cm4gU3ViLmJhdGNoKFtcbiAgICBzdWJNZW51LFxuICAgIHBvcnRTdWIsXG4gICAgc2V0U3RyaWN0TW9kZVBvcnRTdWIsXG4gICAgc2V0RGVib3VjZU1zUG9ydFN1YixcbiAgXSk7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSnNvbkVkaXRvclByb3BzIHtcbiAgcmVhZG9ubHkgc2NoZW1hOiBNYXliZTxKc29uVmFsdWU+O1xuICByZWFkb25seSB2YWx1ZTogSnNvblZhbHVlO1xuICByZWFkb25seSBsYW5ndWFnZTogc3RyaW5nO1xuICByZWFkb25seSBzdHJpY3RNb2RlOiBib29sZWFuO1xuICByZWFkb25seSBvbkNoYW5nZT86ICh2YWx1ZTogSnNvblZhbHVlKSA9PiB2b2lkO1xuICByZWFkb25seSByZW5kZXJlckZhY3Rvcnk6IFJlbmRlcmVyRmFjdG9yeTtcbiAgcmVhZG9ubHkgZGVib3VuY2VNcz86IG51bWJlcjtcbiAgcmVhZG9ubHkgcmVuZGVyT3B0aW9ucz86IFJlbmRlck9wdGlvbnM7XG4gIHJlYWRvbmx5IG1lbnVGaWx0ZXI/OiBNZW51T3B0aW9uRmlsdGVyO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gSnNvbkVkaXRvcihwcm9wczogSnNvbkVkaXRvclByb3BzKTogUmVhY3QuUmVhY3RFbGVtZW50IHtcbiAgcmV0dXJuIChcbiAgICA8UHJvZ3JhbVxuICAgICAgaW5pdD17KCkgPT5cbiAgICAgICAgaW5pdChcbiAgICAgICAgICBwcm9wcy5sYW5ndWFnZSxcbiAgICAgICAgICBwcm9wcy5zY2hlbWEsXG4gICAgICAgICAgcHJvcHMudmFsdWUsXG4gICAgICAgICAgcHJvcHMuc3RyaWN0TW9kZSxcbiAgICAgICAgICBwcm9wcy5yZW5kZXJlckZhY3RvcnksXG4gICAgICAgICAgcHJvcHMuZGVib3VuY2VNcyB8fCA1MDAsXG4gICAgICAgIClcbiAgICAgIH1cbiAgICAgIHZpZXc9eyhkaXNwYXRjaCwgbW9kZWwpID0+IChcbiAgICAgICAgPFZpZXdKc29uRWRpdG9yXG4gICAgICAgICAgZGlzcGF0Y2g9e2Rpc3BhdGNofVxuICAgICAgICAgIG1vZGVsPXttb2RlbH1cbiAgICAgICAgICByZW5kZXJlckZhY3Rvcnk9e3Byb3BzLnJlbmRlcmVyRmFjdG9yeX1cbiAgICAgICAgICByZW5kZXJPcHRpb25zPXtwcm9wcy5yZW5kZXJPcHRpb25zfVxuICAgICAgICAvPlxuICAgICAgKX1cbiAgICAgIHVwZGF0ZT17KG1zZywgbW9kZWwpID0+IHtcbiAgICAgICAgY29uc3QgbWFjbyA9IHVwZGF0ZShcbiAgICAgICAgICBtc2csXG4gICAgICAgICAgbW9kZWwsXG4gICAgICAgICAgcHJvcHMucmVuZGVyZXJGYWN0b3J5LFxuICAgICAgICAgIHByb3BzLm1lbnVGaWx0ZXIsXG4gICAgICAgICk7XG4gICAgICAgIG1hY29bMl0uZm9yRWFjaCgob3V0TXNnKSA9PiB7XG4gICAgICAgICAgc3dpdGNoIChvdXRNc2cudGFnKSB7XG4gICAgICAgICAgICBjYXNlICd2YWx1ZS1jaGFuZ2VkJzoge1xuICAgICAgICAgICAgICBwcm9wcy5vbkNoYW5nZSAmJiBwcm9wcy5vbkNoYW5nZShvdXRNc2cudmFsdWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBbbWFjb1swXSwgbWFjb1sxXV07XG4gICAgICB9fVxuICAgICAgc3Vic2NyaXB0aW9ucz17c3Vic2NyaXB0aW9uc31cbiAgICAgIC8vIGRldlRvb2xzPXtEZXZUb29scy5pbml0PE1vZGVsLCBNc2c+KHdpbmRvdyl9XG4gICAgLz5cbiAgKTtcbn1cbiJdfQ==
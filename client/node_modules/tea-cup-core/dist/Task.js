/*
 * MIT License
 *
 * Copyright (c) 2019 RÃ©mi Van Keisbelck
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
import { Cmd } from './Cmd';
import { err, Err, ok } from './Result';
import { just, nothing } from './Maybe';
import { asError } from './Try';
/**
 * Base class for Tasks.
 */
export class Task {
    /**
     * Send a Task to the runtime for execution
     * @param t the task
     * @param toMsg a function that turns the result of the task into a Msg
     */
    static attempt(t, toMsg) {
        return new TaskCmd(t, toMsg);
    }
    /**
     * Send a Task that never fails to the runtime for execution
     * @param t the task
     * @param toMsg a function that turns the result of the task into a Msg
     */
    static perform(t, toMsg) {
        return new TaskNoErrCmd(t, toMsg);
    }
    /**
     * Create a task that succeeds with a value
     * @param r the value
     */
    static succeed(r) {
        return new TSuccess(() => r);
    }
    /**
     * Create a task that succeeds with a lazily-supplied value
     * @param r the value supplier
     */
    static succeedLazy(r) {
        return new TSuccess(r);
    }
    /**
     * Create a task that fails with an error
     * @param e the error
     */
    static fail(e) {
        return new TError(() => e);
    }
    /**
     * Create a task that fails with a lazily-supplied error
     * @param e the error supplier
     */
    static failLazy(e) {
        return new TError(e);
    }
    /**
     * Create a task from a Promise
     * @param promiseSupplier a function that returns the promise (will be called on Task execution)
     */
    static fromPromise(promiseSupplier) {
        return new TPromise(promiseSupplier);
    }
    /**
     * Create a task from a supplier (lazy). Will return an error if the lambda throws an error.
     */
    static fromLambda(lambda) {
        return new TLambda(lambda);
    }
    /**
     * Map the ok result of this task
     * @param f the mapping function
     */
    map(f) {
        return new TMapped(this, f);
    }
    /**
     * Map the error result of this task
     * @param f the mapping function
     */
    mapError(f) {
        return new TMappedErr(this, f);
    }
    /**
     * Recover from error (turns error into a success !)
     * @param f the error-to-success converter
     */
    recover(f) {
        return new TRecover(this, f);
    }
    /**
     * Chain this task with another task
     * @param f a function that accepts the result of this task, and yields a new task
     */
    andThen(f) {
        return new TThen(this, f);
    }
    /**
     * Runs tasks in parallel
     * @param t the task to be run in parallel with this task
     * @param f a function that maps the results of the 2 parallel tasks
     */
    parallel(t, f) {
        return new TParallel(f, this, t);
    }
}
class TRecover extends Task {
    constructor(t, f) {
        super();
        this.t = t;
        this.f = f;
    }
    execute(callback) {
        this.t.execute((tRes) => tRes.match((tOk) => callback(ok(tOk)), (tErr) => callback(ok(this.f(tErr)))));
    }
}
class TParallel extends Task {
    constructor(f, t1, t2) {
        super();
        this.f = f;
        this.t1 = t1;
        this.t2 = t2;
    }
    execute(callback) {
        let ra = nothing;
        let rb = nothing;
        let error = nothing;
        const done = () => {
            if (error.type !== 'Nothing' || ra.type === 'Nothing' || rb.type === 'Nothing') {
                return;
            }
            callback(ok(this.f(ra.value, rb.value)));
        };
        function handle(t, assign) {
            t.execute((r) => {
                switch (r.tag) {
                    case 'Err': {
                        if (error === null || error === void 0 ? void 0 : error.isNothing()) {
                            callback(err(r.err));
                            error = just(r.err);
                        }
                        break;
                    }
                    case 'Ok': {
                        assign(r.value);
                        done();
                        break;
                    }
                }
            });
        }
        handle(this.t1, (x) => (ra = just(x)));
        handle(this.t2, (x) => (rb = just(x)));
    }
}
class TLambda extends Task {
    constructor(f) {
        super();
        this.f = f;
    }
    execute(callback) {
        try {
            callback(ok(this.f()));
        }
        catch (e) {
            callback(err(asError(e)));
        }
    }
}
class TPromise extends Task {
    constructor(p) {
        super();
        this.p = p;
    }
    execute(callback) {
        this.p()
            .then((r) => callback(ok(r)), (e) => callback(err(e)))
            .catch((e) => callback(err(e)));
    }
}
class TThen extends Task {
    constructor(task, f) {
        super();
        this.task = task;
        this.f = f;
    }
    execute(callback) {
        this.task.execute((r) => {
            r.match((r) => {
                const next = this.f(r);
                next.execute(callback);
            }, (e) => {
                callback(new Err(e));
            });
        });
    }
}
class TMapped extends Task {
    constructor(task, mapper) {
        super();
        this.task = task;
        this.mapper = mapper;
    }
    execute(callback) {
        this.task.execute((r) => {
            callback(r.map(this.mapper));
        });
    }
}
class TMappedErr extends Task {
    constructor(task, mapper) {
        super();
        this.task = task;
        this.mapper = mapper;
    }
    execute(callback) {
        this.task.execute((r) => {
            callback(r.mapError(this.mapper));
        });
    }
}
class TSuccess extends Task {
    constructor(result) {
        super();
        this.result = result;
    }
    execute(callback) {
        callback(ok(this.result()));
    }
}
class TError extends Task {
    constructor(err) {
        super();
        this.err = err;
    }
    execute(callback) {
        callback(err(this.err()));
    }
}
class TaskCmd extends Cmd {
    constructor(task, toMsg) {
        super();
        this.task = task;
        this.toMsg = toMsg;
    }
    execute(dispatch) {
        this.task.execute((r) => {
            dispatch(this.toMsg(r));
        });
    }
}
class TaskNoErrCmd extends Cmd {
    constructor(task, toMsg) {
        super();
        this.task = task;
        this.toMsg = toMsg;
    }
    execute(dispatch) {
        this.task.execute((r) => {
            r.match((ok) => dispatch(this.toMsg(ok)), (err) => {
                throw Error('got an error from a void task : ' + r + ', ' + err);
            });
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGFzay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9UZWFDdXAvVGFzay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0F1Qkc7QUFFSCxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sT0FBTyxDQUFDO0FBRTVCLE9BQU8sRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEVBQUUsRUFBYyxNQUFNLFVBQVUsQ0FBQztBQUNwRCxPQUFPLEVBQUUsSUFBSSxFQUFTLE9BQU8sRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUMvQyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sT0FBTyxDQUFDO0FBRWhDOztHQUVHO0FBQ0gsTUFBTSxPQUFnQixJQUFJO0lBT3hCOzs7O09BSUc7SUFDSCxNQUFNLENBQUMsT0FBTyxDQUFVLENBQWEsRUFBRSxLQUE2QjtRQUNsRSxPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUMvQixDQUFDO0lBRUQ7Ozs7T0FJRztJQUNILE1BQU0sQ0FBQyxPQUFPLENBQU8sQ0FBaUIsRUFBRSxLQUFrQjtRQUN4RCxPQUFPLElBQUksWUFBWSxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNwQyxDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsTUFBTSxDQUFDLE9BQU8sQ0FBSSxDQUFJO1FBQ3BCLE9BQU8sSUFBSSxRQUFRLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDL0IsQ0FBQztJQUVEOzs7T0FHRztJQUNILE1BQU0sQ0FBQyxXQUFXLENBQUksQ0FBVTtRQUM5QixPQUFPLElBQUksUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3pCLENBQUM7SUFFRDs7O09BR0c7SUFDSCxNQUFNLENBQUMsSUFBSSxDQUFJLENBQUk7UUFDakIsT0FBTyxJQUFJLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztJ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Q0FBQyxDQUFrQixFQUFFLEVBQUU7WUFDdkMsQ0FBQyxDQUFDLEtBQUssQ0FDTCxDQUFDLEVBQUssRUFBRSxFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUMsRUFDbkMsQ0FBQyxHQUFRLEVBQUUsRUFBRTtnQkFDWCxNQUFNLEtBQUssQ0FBQyxrQ0FBa0MsR0FBRyxDQUFDLEdBQUcsSUFBSSxHQUFHLEdBQUcsQ0FBQyxDQUFDO1lBQ25FLENBQUMsQ0FDRixDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTUlUIExpY2Vuc2VcbiAqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTkgUsOpbWkgVmFuIEtlaXNiZWxja1xuICpcbiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlIFwiU29mdHdhcmVcIiksIHRvIGRlYWxcbiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHNcbiAqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGxcbiAqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpc1xuICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczpcbiAqXG4gKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbiBhbGxcbiAqIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuXG4gKlxuICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuICogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksXG4gKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbiAqIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXG4gKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRVxuICogU09GVFdBUkUuXG4gKlxuICovXG5cbmltcG9ydCB7IENtZCB9IGZyb20gJy4vQ21kJztcbmltcG9ydCB7IERpc3BhdGNoZXIgfSBmcm9tICcuL0Rpc3BhdGNoZXInO1xuaW1wb3J0IHsgZXJyLCBFcnIsIG9rLCBPaywgUmVzdWx0IH0gZnJvbSAnLi9SZXN1bHQnO1xuaW1wb3J0IHsganVzdCwgTWF5YmUsIG5vdGhpbmcgfSBmcm9tICcuL01heWJlJztcbmltcG9ydCB7IGFzRXJyb3IgfSBmcm9tICcuL1RyeSc7XG5cbi8qKlxuICogQmFzZSBjbGFzcyBmb3IgVGFza3MuXG4gKi9cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBUYXNrPEUsIFI+IHtcbiAgLyoqXG4gICAqIFRvIGJlIGltcGxlbWVudGVkIGJ5IGNvbmNyZXRlIFRhc2tzLlxuICAgKiBAcGFyYW0gY2FsbGJhY2sgdGhlIGNhbGxiYWNrIHRvIGNhbGwgd2hlbiB0aGUgdGFzayBpcyByYW5cbiAgICovXG4gIGFic3RyYWN0IGV4ZWN1dGUoY2FsbGJhY2s6IChyOiBSZXN1bHQ8RSwgUj4pID0+IHZvaWQpOiB2b2lkO1xuXG4gIC8qKlxuICAgKiBTZW5kIGEgVGFzayB0byB0aGUgcnVudGltZSBmb3IgZXhlY3V0aW9uXG4gICAqIEBwYXJhbSB0IHRoZSB0YXNrXG4gICAqIEBwYXJhbSB0b01zZyBhIGZ1bmN0aW9uIHRoYXQgdHVybnMgdGhlIHJlc3VsdCBvZiB0aGUgdGFzayBpbnRvIGEgTXNnXG4gICAqL1xuICBzdGF0aWMgYXR0ZW1wdDxFLCBSLCBNPih0OiBUYXNrPEUsIFI+LCB0b01zZzogKHI6IFJlc3VsdDxFLCBSPikgPT4gTSk6IENtZDxNPiB7XG4gICAgcmV0dXJuIG5ldyBUYXNrQ21kKHQsIHRvTXNnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZW5kIGEgVGFzayB0aGF0IG5ldmVyIGZhaWxzIHRvIHRoZSBydW50aW1lIGZvciBleGVjdXRpb25cbiAgICogQHBhcmFtIHQgdGhlIHRhc2tcbiAgICogQHBhcmFtIHRvTXNnIGEgZnVuY3Rpb24gdGhhdCB0dXJucyB0aGUgcmVzdWx0IG9mIHRoZSB0YXNrIGludG8gYSBNc2dcbiAgICovXG4gIHN0YXRpYyBwZXJmb3JtPFIsIE0+KHQ6IFRhc2s8bmV2ZXIsIFI+LCB0b01zZzogKHI6IFIpID0+IE0pOiBDbWQ8TT4ge1xuICAgIHJldHVybiBuZXcgVGFza05vRXJyQ21kKHQsIHRvTXNnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgYSB0YXNrIHRoYXQgc3VjY2VlZHMgd2l0aCBhIHZhbHVlXG4gICAqIEBwYXJhbSByIHRoZSB2YWx1ZVxuICAgKi9cbiAgc3RhdGljIHN1Y2NlZWQ8Uj4ocjogUik6IFRhc2s8bmV2ZXIsIFI+IHtcbiAgICByZXR1cm4gbmV3IFRTdWNjZXNzKCgpID0+IHIpO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBhIHRhc2sgdGhhdCBzdWNjZWVkcyB3aXRoIGEgbGF6aWx5LXN1cHBsaWVkIHZhbHVlXG4gICAqIEBwYXJhbSByIHRoZSB2YWx1ZSBzdXBwbGllclxuICAgKi9cbiAgc3RhdGljIHN1Y2NlZWRMYXp5PFI+KHI6ICgpID0+IFIpOiBUYXNrPG5ldmVyLCBSPiB7XG4gICAgcmV0dXJuIG5ldyBUU3VjY2VzcyhyKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgYSB0YXNrIHRoYXQgZmFpbHMgd2l0aCBhbiBlcnJvclxuICAgKiBAcGFyYW0gZSB0aGUgZXJyb3JcbiAgICovXG4gIHN0YXRpYyBmYWlsPEU+KGU6IEUpOiBUYXNrPEUsIG5ldmVyPiB7XG4gICAgcmV0dXJuIG5ldyBURXJyb3IoKCkgPT4gZSk7XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIGEgdGFzayB0aGF0IGZhaWxzIHdpdGggYSBsYXppbHktc3VwcGxpZWQgZXJyb3JcbiAgICogQHBhcmFtIGUgdGhlIGVycm9yIHN1cHBsaWVyXG4gICAqL1xuICBzdGF0aWMgZmFpbExhenk8RT4oZTogKCkgPT4gRSk6IFRhc2s8RSwgbmV2ZXI+IHtcbiAgICByZXR1cm4gbmV3IFRFcnJvcihlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgYSB0YXNrIGZyb20gYSBQcm9taXNlXG4gICAqIEBwYXJhbSBwcm9taXNlU3VwcGxpZXIgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlIHByb21pc2UgKHdpbGwgYmUgY2FsbGVkIG9uIFRhc2sgZXhlY3V0aW9uKVxuICAgKi9cbiAgc3RhdGljIGZyb21Qcm9taXNlPFI+KHByb21pc2VTdXBwbGllcjogUHJvbWlzZVN1cHBsaWVyPFI+KTogVGFzazxhbnksIFI+IHtcbiAgICByZXR1cm4gbmV3IFRQcm9taXNlKHByb21pc2VTdXBwbGllcik7XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIGEgdGFzayBmcm9tIGEgc3VwcGxpZXIgKGxhenkpLiBXaWxsIHJldHVybiBhbiBlcnJvciBpZiB0aGUgbGFtYmRhIHRocm93cyBhbiBlcnJvci5cbiAgICovXG4gIHN0YXRpYyBmcm9tTGFtYmRhPFI+KGxhbWJkYTogKCkgPT4gUik6IFRhc2s8RXJyb3IsIFI+IHtcbiAgICByZXR1cm4gbmV3IFRMYW1iZGEobGFtYmRhKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBNYXAgdGhlIG9rIHJlc3VsdCBvZiB0aGlzIHRhc2tcbiAgICogQHBhcmFtIGYgdGhlIG1hcHBpbmcgZnVuY3Rpb25cbiAgICovXG4gIG1hcDxSMj4oZjogKHI6IFIpID0+IFIyKTogVGFzazxFLCBSMj4ge1xuICAgIHJldHVybiBuZXcgVE1hcHBlZCh0aGlzLCBmKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBNYXAgdGhlIGVycm9yIHJlc3VsdCBvZiB0aGlzIHRhc2tcbiAgICogQHBhcmFtIGYgdGhlIG1hcHBpbmcgZnVuY3Rpb25cbiAgICovXG4gIG1hcEVycm9yPEUyPihmOiAoZTogRSkgPT4gRTIpOiBUYXNrPEUyLCBSPiB7XG4gICAgcmV0dXJuIG5ldyBUTWFwcGVkRXJyKHRoaXMsIGYpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlY292ZXIgZnJvbSBlcnJvciAodHVybnMgZXJyb3IgaW50byBhIHN1Y2Nlc3MgISlcbiAgICogQHBhcmFtIGYgdGhlIGVycm9yLXRvLXN1Y2Nlc3MgY29udmVydGVyXG4gICAqL1xuICByZWNvdmVyKGY6IChlOiBFKSA9PiBSKTogVGFzazxuZXZlciwgUj4ge1xuICAgIHJldHVybiBuZXcgVFJlY292ZXIodGhpcywgZik7XG4gIH1cblxuICAvKipcbiAgICogQ2hhaW4gdGhpcyB0YXNrIHdpdGggYW5vdGhlciB0YXNrXG4gICAqIEBwYXJhbSBmIGEgZnVuY3Rpb24gdGhhdCBhY2NlcHRzIHRoZSByZXN1bHQgb2YgdGhpcyB0YXNrLCBhbmQgeWllbGRzIGEgbmV3IHRhc2tcbiAgICovXG4gIGFuZFRoZW48UjI+KGY6IChyOiBSKSA9PiBUYXNrPEUsIFIyPik6IFRhc2s8RSwgUjI+IHtcbiAgICByZXR1cm4gbmV3IFRUaGVuKHRoaXMsIGYpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJ1bnMgdGFza3MgaW4gcGFyYWxsZWxcbiAgICogQHBhcmFtIHQgdGhlIHRhc2sgdG8gYmUgcnVuIGluIHBhcmFsbGVsIHdpdGggdGhpcyB0YXNrXG4gICAqIEBwYXJhbSBmIGEgZnVuY3Rpb24gdGhhdCBtYXBzIHRoZSByZXN1bHRzIG9mIHRoZSAyIHBhcmFsbGVsIHRhc2tzXG4gICAqL1xuICBwYXJhbGxlbDxUMiwgUjI+KHQ6IFRhc2s8RSwgVDI+LCBmOiAoYTogUiwgYjogVDIpID0+IFIyKTogVGFzazxFLCBSMj4ge1xuICAgIHJldHVybiBuZXcgVFBhcmFsbGVsPEUsIFIyLCBSLCBUMj4oZiwgdGhpcywgdCk7XG4gIH1cbn1cblxuY2xhc3MgVFJlY292ZXI8RSwgUj4gZXh0ZW5kcyBUYXNrPG5ldmVyLCBSPiB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgdDogVGFzazxFLCBSPiwgcHJpdmF0ZSByZWFkb25seSBmOiAoZTogRSkgPT4gUikge1xuICAgIHN1cGVyKCk7XG4gIH1cblxuICBleGVjdXRlKGNhbGxiYWNrOiAocjogUmVzdWx0PG5ldmVyLCBSPikgPT4gdm9pZCk6IHZvaWQge1xuICAgIHRoaXMudC5leGVjdXRlKCh0UmVzKSA9PlxuICAgICAgdFJlcy5tYXRjaChcbiAgICAgICAgKHRPaykgPT4gY2FsbGJhY2sob2sodE9rKSksXG4gICAgICAgICh0RXJyKSA9PiBjYWxsYmFjayhvayh0aGlzLmYodEVycikpKSxcbiAgICAgICksXG4gICAgKTtcbiAgfVxufVxuXG5jbGFzcyBUUGFyYWxsZWw8RSwgUiwgQSwgQj4gZXh0ZW5kcyBUYXNrPEUsIFI+IHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBmOiAoYTogQSwgYjogQikgPT4gUiwgcHJpdmF0ZSByZWFkb25seSB0MTogVGFzazxFLCBBPiwgcHJpdmF0ZSByZWFkb25seSB0MjogVGFzazxFLCBCPikge1xuICAgIHN1cGVyKCk7XG4gIH1cblxuICBleGVjdXRlKGNhbGxiYWNrOiAocjogUmVzdWx0PEUsIFI+KSA9PiB2b2lkKTogdm9pZCB7XG4gICAgbGV0IHJhOiBNYXliZTxBPiA9IG5vdGhpbmc7XG4gICAgbGV0IHJiOiBNYXliZTxCPiA9IG5vdGhpbmc7XG4gICAgbGV0IGVycm9yOiBNYXliZTxFPiA9IG5vdGhpbmc7XG5cbiAgICBjb25zdCBkb25lID0gKCkgPT4ge1xuICAgICAgaWYgKGVycm9yLnR5cGUgIT09ICdOb3RoaW5nJyB8fCByYS50eXBlID09PSAnTm90aGluZycgfHwgcmIudHlwZSA9PT0gJ05vdGhpbmcnKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGNhbGxiYWNrKG9rKHRoaXMuZihyYS52YWx1ZSwgcmIudmFsdWUpKSk7XG4gICAgfTtcblxuICAgIGZ1bmN0aW9uIGhhbmRsZTxYPih0OiBUYXNrPEUsIFg+LCBhc3NpZ246ICh4OiBYKSA9PiB2b2lkKSB7XG4gICAgICB0LmV4ZWN1dGUoKHI6IFJlc3VsdDxFLCBYPikgPT4ge1xuICAgICAgICBzd2l0Y2ggKHIudGFnKSB7XG4gICAgICAgICAgY2FzZSAnRXJyJzoge1xuICAgICAgICAgICAgaWYgKGVycm9yPy5pc05vdGhpbmcoKSkge1xuICAgICAgICAgICAgICBjYWxsYmFjayhlcnIoci5lcnIpKTtcbiAgICAgICAgICAgICAgZXJyb3IgPSBqdXN0KHIuZXJyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgICBjYXNlICdPayc6IHtcbiAgICAgICAgICAgIGFzc2lnbihyLnZhbHVlKTtcbiAgICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaGFuZGxlKHRoaXMudDEsICh4KSA9PiAocmEgPSBqdXN0KHgpKSk7XG4gICAgaGFuZGxlKHRoaXMudDIsICh4KSA9PiAocmIgPSBqdXN0KHgpKSk7XG4gIH1cbn1cblxuY2xhc3MgVExhbWJkYTxSPiBleHRlbmRzIFRhc2s8RXJyb3IsIFI+IHtcbiAgcHJpdmF0ZSByZWFkb25seSBmOiAoKSA9PiBSO1xuXG4gIGNvbnN0cnVjdG9yKGY6ICgpID0+IFIpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuZiA9IGY7XG4gIH1cblxuICBleGVjdXRlKGNhbGxiYWNrOiAocjogUmVzdWx0PEVycm9yLCBSPikgPT4gdm9pZCk6IHZvaWQge1xuICAgIHRyeSB7XG4gICAgICBjYWxsYmFjayhvayh0aGlzLmYoKSkpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNhbGxiYWNrKGVycihhc0Vycm9yKGUpKSk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCB0eXBlIFByb21pc2VTdXBwbGllcjxUPiA9ICgpID0+IFByb21pc2U8VD47XG5cbmNsYXNzIFRQcm9taXNlPFI+IGV4dGVuZHMgVGFzazxhbnksIFI+IHtcbiAgcHJpdmF0ZSByZWFkb25seSBwOiBQcm9taXNlU3VwcGxpZXI8Uj47XG5cbiAgY29uc3RydWN0b3IocDogUHJvbWlzZVN1cHBsaWVyPFI+KSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLnAgPSBwO1xuICB9XG5cbiAgZXhlY3V0ZShjYWxsYmFjazogKHI6IFJlc3VsdDxhbnksIFI+KSA9PiB2b2lkKTogdm9pZCB7XG4gICAgdGhpcy5wKClcbiAgICAgIC50aGVuKFxuICAgICAgICAocjogUikgPT4gY2FsbGJhY2sob2socikpLFxuICAgICAgICAoZTogYW55KSA9PiBjYWxsYmFjayhlcnIoZSkpLFxuICAgICAgKVxuICAgICAgLmNhdGNoKChlKSA9PiBjYWxsYmFjayhlcnIoZSkpKTtcbiAgfVxufVxuXG5jbGFzcyBUVGhlbjxFLCBSLCBSMj4gZXh0ZW5kcyBUYXNrPEUsIFIyPiB7XG4gIHByaXZhdGUgcmVhZG9ubHkgdGFzazogVGFzazxFLCBSPjtcbiAgcHJpdmF0ZSByZWFkb25seSBmOiAocjogUikgPT4gVGFzazxFLCBSMj47XG5cbiAgY29uc3RydWN0b3IodGFzazogVGFzazxFLCBSPiwgZjogKHI6IFIpID0+IFRhc2s8RSwgUjI+KSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLnRhc2sgPSB0YXNrO1xuICAgIHRoaXMuZiA9IGY7XG4gIH1cblxuICBleGVjdXRlKGNhbGxiYWNrOiAocjogUmVzdWx0PEUsIFIyPikgPT4gdm9pZCk6IHZvaWQge1xuICAgIHRoaXMudGFzay5leGVjdXRlKChyOiBSZXN1bHQ8RSwgUj4pID0+IHtcbiAgICAgIHIubWF0Y2goXG4gICAgICAgIChyOiBSKSA9PiB7XG4gICAgICAgICAgY29uc3QgbmV4dCA9IHRoaXMuZihyKTtcbiAgICAgICAgICBuZXh0LmV4ZWN1dGUoY2FsbGJhY2spO1xuICAgICAgICB9LFxuICAgICAgICAoZTogRSkgPT4ge1xuICAgICAgICAgIGNhbGxiYWNrKG5ldyBFcnIoZSkpO1xuICAgICAgICB9LFxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxufVxuXG5jbGFzcyBUTWFwcGVkPEUsIFIsIFIyPiBleHRlbmRzIFRhc2s8RSwgUjI+IHtcbiAgcHJpdmF0ZSByZWFkb25seSB0YXNrOiBUYXNrPEUsIFI+O1xuICBwcml2YXRlIHJlYWRvbmx5IG1hcHBlcjogKHI6IFIpID0+IFIyO1xuXG4gIGNvbnN0cnVjdG9yKHRhc2s6IFRhc2s8RSwgUj4sIG1hcHBlcjogKHI6IFIpID0+IFIyKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLnRhc2sgPSB0YXNrO1xuICAgIHRoaXMubWFwcGVyID0gbWFwcGVyO1xuICB9XG5cbiAgZXhlY3V0ZShjYWxsYmFjazogKHI6IFJlc3VsdDxFLCBSMj4pID0+IHZvaWQpOiB2b2lkIHtcbiAgICB0aGlzLnRhc2suZXhlY3V0ZSgocjogUmVzdWx0PEUsIFI+KSA9PiB7XG4gICAgICBjYWxsYmFjayhyLm1hcCh0aGlzLm1hcHBlcikpO1xuICAgIH0pO1xuICB9XG59XG5cbmNsYXNzIFRNYXBwZWRFcnI8RSwgUiwgRTI+IGV4dGVuZHMgVGFzazxFMiwgUj4ge1xuICBwcml2YXRlIHJlYWRvbmx5IHRhc2s6IFRhc2s8RSwgUj47XG4gIHByaXZhdGUgcmVhZG9ubHkgbWFwcGVyOiAoZTogRSkgPT4gRTI7XG5cbiAgY29uc3RydWN0b3IodGFzazogVGFzazxFLCBSPiwgbWFwcGVyOiAoZTogRSkgPT4gRTIpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMudGFzayA9IHRhc2s7XG4gICAgdGhpcy5tYXBwZXIgPSBtYXBwZXI7XG4gIH1cblxuICBleGVjdXRlKGNhbGxiYWNrOiAocjogUmVzdWx0PEUyLCBSPikgPT4gdm9pZCk6IHZvaWQge1xuICAgIHRoaXMudGFzay5leGVjdXRlKChyOiBSZXN1bHQ8RSwgUj4pID0+IHtcbiAgICAgIGNhbGxiYWNrKHIubWFwRXJyb3IodGhpcy5tYXBwZXIpKTtcbiAgICB9KTtcbiAgfVxufVxuXG5jbGFzcyBUU3VjY2VzczxSPiBleHRlbmRzIFRhc2s8bmV2ZXIsIFI+IHtcbiAgcHJpdmF0ZSByZWFkb25seSByZXN1bHQ6ICgpID0+IFI7XG5cbiAgY29uc3RydWN0b3IocmVzdWx0OiAoKSA9PiBSKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLnJlc3VsdCA9IHJlc3VsdDtcbiAgfVxuXG4gIGV4ZWN1dGUoY2FsbGJhY2s6IChyOiBSZXN1bHQ8bmV2ZXIsIFI+KSA9PiB2b2lkKTogdm9pZCB7XG4gICAgY2FsbGJhY2sob2sodGhpcy5yZXN1bHQoKSkpO1xuICB9XG59XG5cbmNsYXNzIFRFcnJvcjxFPiBleHRlbmRzIFRhc2s8RSwgbmV2ZXI+IHtcbiAgcHJpdmF0ZSByZWFkb25seSBlcnI6ICgpID0+IEU7XG5cbiAgY29uc3RydWN0b3IoZXJyOiAoKSA9PiBFKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLmVyciA9IGVycjtcbiAgfVxuXG4gIGV4ZWN1dGUoY2FsbGJhY2s6IChyOiBSZXN1bHQ8RSwgbmV2ZXI+KSA9PiB2b2lkKTogdm9pZCB7XG4gICAgY2FsbGJhY2soZXJyKHRoaXMuZXJyKCkpKTtcbiAgfVxufVxuXG5jbGFzcyBUYXNrQ21kPEUsIFIsIE0+IGV4dGVuZHMgQ21kPE0+IHtcbiAgcmVhZG9ubHkgdGFzazogVGFzazxFLCBSPjtcbiAgcmVhZG9ubHkgdG9Nc2c6IChyOiBSZXN1bHQ8RSwgUj4pID0+IE07XG5cbiAgY29uc3RydWN0b3IodGFzazogVGFzazxFLCBSPiwgdG9Nc2c6IChyOiBSZXN1bHQ8RSwgUj4pID0+IE0pIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMudGFzayA9IHRhc2s7XG4gICAgdGhpcy50b01zZyA9IHRvTXNnO1xuICB9XG5cbiAgZXhlY3V0ZShkaXNwYXRjaDogRGlzcGF0Y2hlcjxNPik6IHZvaWQge1xuICAgIHRoaXMudGFzay5leGVjdXRlKChyOiBSZXN1bHQ8RSwgUj4pID0+IHtcbiAgICAgIGRpc3BhdGNoKHRoaXMudG9Nc2cocikpO1xuICAgIH0pO1xuICB9XG59XG5cbmNsYXNzIFRhc2tOb0VyckNtZDxSLCBNPiBleHRlbmRzIENtZDxNPiB7XG4gIHJlYWRvbmx5IHRhc2s6IFRhc2s8dm9pZCwgUj47XG4gIHJlYWRvbmx5IHRvTXNnOiAocjogUikgPT4gTTtcblxuICBjb25zdHJ1Y3Rvcih0YXNrOiBUYXNrPHZvaWQsIFI+LCB0b01zZzogKHI6IFIpID0+IE0pIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMudGFzayA9IHRhc2s7XG4gICAgdGhpcy50b01zZyA9IHRvTXNnO1xuICB9XG5cbiAgZXhlY3V0ZShkaXNwYXRjaDogRGlzcGF0Y2hlcjxNPik6IHZvaWQge1xuICAgIHRoaXMudGFzay5leGVjdXRlKChyOiBSZXN1bHQ8dm9pZCwgUj4pID0+IHtcbiAgICAgIHIubWF0Y2goXG4gICAgICAgIChvazogUikgPT4gZGlzcGF0Y2godGhpcy50b01zZyhvaykpLFxuICAgICAgICAoZXJyOiBhbnkpID0+IHtcbiAgICAgICAgICB0aHJvdyBFcnJvcignZ290IGFuIGVycm9yIGZyb20gYSB2b2lkIHRhc2sgOiAnICsgciArICcsICcgKyBlcnIpO1xuICAgICAgICB9LFxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxufVxuIl19
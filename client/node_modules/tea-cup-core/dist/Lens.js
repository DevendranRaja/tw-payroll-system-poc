/*
 * MIT License
 *
 * Copyright (c) 2024 RÃ©mi Van Keisbelck, Frank Wagner
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
import { just, nothing } from "./Maybe";
export class Lens {
    constructor(get, set) {
        this.get = get;
        this.set = set;
    }
    update(a, f) {
        return this.set(a, f(this.get(a)));
    }
    updateWithResult(a, f) {
        const [b, r] = f(this.get(a));
        return [this.set(a, b), r];
    }
    field(field) {
        return composeLenses(this, fieldLens(field));
    }
    sub(f) {
        return composeLensPrism(this, subPrism(f));
    }
    flatten() {
        return composeLensPrism(this, flattenPrism());
    }
    andThenLens(lens) {
        return composeLenses(this, lens);
    }
    andThenPrism(prism) {
        return composeLensPrism(this, prism);
    }
}
export class Prism {
    constructor(get, set) {
        this.get = get;
        this.set = set;
    }
    update(a, f) {
        return this.get(a)
            .map(f)
            .map((fb) => this.set(a, fb));
    }
    updateWithResult(a, f) {
        return this.get(a)
            .map(f)
            .map(([b, r]) => [this.set(a, b), r]);
    }
    field(field) {
        return composePrismLens(this, fieldLens(field));
    }
    sub(f) {
        return composePrisms(this, subPrism(f));
    }
    andThen(lens) {
        if (lens instanceof Lens) {
            return composePrismLens(this, lens);
        }
        else {
            return composePrisms(this, lens);
        }
    }
    flatten() {
        return composePrisms(this, flattenPrism());
    }
}
export function idLens() {
    return new Lens((a) => a, (_, v) => v);
}
export function composeLenses(l1, l2) {
    return new Lens((a) => l2.get(l1.get(a)), (a, v) => l1.set(a, l2.set(l1.get(a), v)));
}
export function composeLensPrism(l, p) {
    return new Prism((a) => p.get(l.get(a)), (a, v) => l.set(a, p.set(l.get(a), v)));
}
export function composePrismLens(p, l) {
    return new Prism((a) => p.get(a).map(l.get), (a, v) => p
        .get(a)
        .map((b) => l.set(b, v))
        .map((bc) => p.set(a, bc))
        .withDefault(a));
}
export function composePrisms(p, p2) {
    return new Prism((a) => p.get(a).andThen(p2.get), (a, v) => p
        .get(a)
        .map((b) => p2.set(b, v))
        .map((bc) => p.set(a, bc))
        .withDefault(a));
}
export function fieldLens(field) {
    return new Lens((a) => a[field], (a, v) => {
        const a1 = Object.assign({}, a);
        a1[field] = v;
        return a1;
    });
}
export function flattenPrism() {
    return new Prism((a) => a, (a, v) => a.map(() => v).orElse(a));
}
export function discriminate(tag, v) {
    return (o) => (o[tag] === v ? just(o) : nothing);
}
export function subPrism(f) {
    return new Prism((a) => f(a), (a, v) => f(a)
        .map(() => v)
        .withDefault(a));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTGVucy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9UZWFDdXAvTGVucy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0F1Qkc7QUFFSCxPQUFPLEVBQUUsSUFBSSxFQUFTLE9BQU8sRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUkvQyxNQUFNLE9BQU8sSUFBSTtJQUNmLFlBQXFCLEdBQWdCLEVBQVcsR0FBc0I7UUFBakQsUUFBRyxHQUFILEdBQUcsQ0FBYTtRQUFXLFFBQUcsR0FBSCxHQUFHLENBQW1CO0lBQUcsQ0FBQztJQUUxRSxNQUFNLENBQUMsQ0FBSSxFQUFFLENBQWM7UUFDekIsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDckMsQ0FBQztJQUVELGdCQUFnQixDQUFJLENBQUksRUFBRSxDQUFtQjtRQUMzQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDOUIsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQzdCLENBQUM7SUFFRCxLQUFLLENBQW9CLEtBQVE7UUFDL0IsT0FBTyxhQUFhLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO0lBQy9DLENBQUM7SUFFRCxHQUFHLENBQWMsQ0FBcUI7UUFDcEMsT0FBTyxnQkFBZ0IsQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDN0MsQ0FBQztJQUVELE9BQU87UUFDTCxPQUFPLGdCQUFnQixDQUNyQixJQUE2QyxFQUM3QyxZQUFZLEVBQUssQ0FDbEIsQ0FB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LENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQ1AsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNELEdBQUcsQ0FBSSxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FDZixXQUFXLENBQUMsQ0FBQyxDQUFDLENBQ3BCLENBQUM7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIE1JVCBMaWNlbnNlXG4gKlxuICogQ29weXJpZ2h0IChjKSAyMDI0IFLDqW1pIFZhbiBLZWlzYmVsY2ssIEZyYW5rIFdhZ25lclxuICpcbiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlIFwiU29mdHdhcmVcIiksIHRvIGRlYWxcbiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHNcbiAqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGxcbiAqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpc1xuICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczpcbiAqXG4gKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbiBhbGxcbiAqIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuXG4gKlxuICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuICogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksXG4gKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbiAqIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXG4gKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRVxuICogU09GVFdBUkUuXG4gKlxuICovXG5cbmltcG9ydCB7IGp1c3QsIE1heWJlLCBub3RoaW5nIH0gZnJvbSBcIi4vTWF5YmVcIjtcblxudHlwZSBNYXliZU9mPE0+ID0gTSBleHRlbmRzIE1heWJlPGluZmVyIEE+ID8gQSA6IG5ldmVyO1xuXG5leHBvcnQgY2xhc3MgTGVuczxBLCBCPiB7XG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IGdldDogKGE6IEEpID0+IEIsIHJlYWRvbmx5IHNldDogKGE6IEEsIGI6IEIpID0+IEEpIHt9XG5cbiAgdXBkYXRlKGE6IEEsIGY6IChiOiBCKSA9PiBCKTogQSB7XG4gICAgcmV0dXJuIHRoaXMuc2V0KGEsIGYodGhpcy5nZXQoYSkpKTtcbiAgfVxuXG4gIHVwZGF0ZVdpdGhSZXN1bHQ8Uj4oYTogQSwgZjogKGI6IEIpID0+IFtCLCBSXSk6IFtBLCBSXSB7XG4gICAgY29uc3QgW2IsIHJdID0gZih0aGlzLmdldChhKSk7XG4gICAgcmV0dXJuIFt0aGlzLnNldChhLCBiKSwgcl07XG4gIH1cblxuICBmaWVsZDxLIGV4dGVuZHMga2V5b2YgQj4oZmllbGQ6IEspOiBMZW5zPEEsIEJbS10+IHtcbiAgICByZXR1cm4gY29tcG9zZUxlbnNlcyh0aGlzLCBmaWVsZExlbnMoZmllbGQpKTtcbiAgfVxuXG4gIHN1YjxDIGV4dGVuZHMgQj4oZjogKGI6IEIpID0+IE1heWJlPEM+KTogUHJpc208QSwgQz4ge1xuICAgIHJldHVybiBjb21wb3NlTGVuc1ByaXNtKHRoaXMsIHN1YlByaXNtKGYpKTtcbiAgfVxuXG4gIGZsYXR0ZW4oKTogUHJpc208QSwgTWF5YmVPZjxCPj4ge1xuICAgIHJldHVybiBjb21wb3NlTGVuc1ByaXNtKFxuICAgICAgdGhpcyBhcyB1bmtub3duIGFzIExlbnM8QSwgTWF5YmU8TWF5YmVPZjxCPj4+LFxuICAgICAgZmxhdHRlblByaXNtPEI+KClcbiAgICApO1xuICB9XG5cbiAgYW5kVGhlbkxlbnM8Qz4obGVuczogTGVuczxCLCBDPik6IExlbnM8QSwgQz4ge1xuICAgIHJldHVybiBjb21wb3NlTGVuc2VzKHRoaXMsIGxlbnMpO1xuICB9XG5cbiAgYW5kVGhlblByaXNtPEM+KHByaXNtOiBQcmlzbTxCLCBDPik6IFByaXNtPEEsIEM+IHtcbiAgICByZXR1cm4gY29tcG9zZUxlbnNQcmlzbSh0aGlzLCBwcmlzbSk7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFByaXNtPEEsIEI+IHtcbiAgY29uc3RydWN0b3IoXG4gICAgcmVhZG9ubHkgZ2V0OiAoYTogQSkgPT4gTWF5YmU8Qj4sXG4gICAgcmVhZG9ubHkgc2V0OiAoYTogQSwgYjogQikgPT4gQVxuICApIHt9XG5cbiAgdXBkYXRlKGE6IEEsIGY6IChiOiBCKSA9PiBCKTogTWF5YmU8QT4ge1xuICAgIHJldHVybiB0aGlzLmdldChhKVxuICAgICAgLm1hcChmKVxuICAgICAgLm1hcCgoZmIpID0+IHRoaXMuc2V0KGEsIGZiKSk7XG4gIH1cblxuICB1cGRhdGVXaXRoUmVzdWx0PFI+KGE6IEEsIGY6IChiOiBCKSA9PiBbQiwgUl0pOiBNYXliZTxbQSwgUl0+IHtcbiAgICByZXR1cm4gdGhpcy5nZXQoYSlcbiAgICAgIC5tYXAoZilcbiAgICAgIC5tYXAoKFtiLCByXSkgPT4gW3RoaXMuc2V0KGEsIGIpLCByXSk7XG4gIH1cblxuICBmaWVsZDxLIGV4dGVuZHMga2V5b2YgQj4oZmllbGQ6IEspOiBQcmlzbTxBLCBCW0tdPiB7XG4gICAgcmV0dXJuIGNvbXBvc2VQcmlzbUxlbnModGhpcywgZmllbGRMZW5zKGZpZWxkKSk7XG4gIH1cblxuICBzdWI8QyBleHRlbmRzIEI+KGY6IChiOiBCKSA9PiBNYXliZTxDPik6IFByaXNtPEEsIEM+IHtcbiAgICByZXR1cm4gY29tcG9zZVByaXNtcyh0aGlzLCBzdWJQcmlzbShmKSk7XG4gIH1cblxuICBhbmRUaGVuPEM+KGxlbnM6IExlbnM8QiwgQz4gfCBQcmlzbTxCLCBDPik6IFByaXNtPEEsIEM+IHtcbiAgICBpZiAobGVucyBpbnN0YW5jZW9mIExlbnMpIHtcbiAgICAgIHJldHVybiBjb21wb3NlUHJpc21MZW5zKHRoaXMsIGxlbnMpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gY29tcG9zZVByaXNtcyh0aGlzLCBsZW5zKTtcbiAgICB9XG4gIH1cblxuICBmbGF0dGVuKCk6IFByaXNtPEEsIE1heWJlT2Y8Qj4+IHtcbiAgICByZXR1cm4gY29tcG9zZVByaXNtcyhcbiAgICAgIHRoaXMgYXMgdW5rbm93biBhcyBQcmlzbTxBLCBNYXliZTxNYXliZU9mPEI+Pj4sXG4gICAgICBmbGF0dGVuUHJpc20oKVxuICAgICk7XG4gIH1cbn1cblxuZXhwb3J0IHR5cGUgU3ViVHlwZUd1YXJkPEEsIEIgZXh0ZW5kcyBBPiA9IChhOiBBKSA9PiBNYXliZTxCPjtcblxuZXhwb3J0IGZ1bmN0aW9uIGlkTGVuczxBPigpOiBMZW5zPEEsIEE+IHtcbiAgcmV0dXJuIG5ldyBMZW5zKFxuICAgIChhKSA9PiBhLFxuICAgIChfLCB2KSA9PiB2XG4gICk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb21wb3NlTGVuc2VzPEEsIEIsIEM+KFxuICBsMTogTGVuczxBLCBCPixcbiAgbDI6IExlbnM8QiwgQz5cbik6IExlbnM8QSwgQz4ge1xuICByZXR1cm4gbmV3IExlbnMoXG4gICAgKGEpID0+IGwyLmdldChsMS5nZXQoYSkpLFxuICAgIChhLCB2KSA9PiBsMS5zZXQoYSwgbDIuc2V0KGwxLmdldChhKSwgdikpXG4gICk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb21wb3NlTGVuc1ByaXNtPEEsIEIsIEM+KFxuICBsOiBMZW5zPEEsIEI+LFxuICBwOiBQcmlzbTxCLCBDPlxuKTogUHJpc208QSwgQz4ge1xuICByZXR1cm4gbmV3IFByaXNtKFxuICAgIChhKSA9PiBwLmdldChsLmdldChhKSksXG4gICAgKGEsIHYpID0+IGwuc2V0KGEsIHAuc2V0KGwuZ2V0KGEpLCB2KSlcbiAgKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNvbXBvc2VQcmlzbUxlbnM8QSwgQiwgQz4oXG4gIHA6IFByaXNtPEEsIEI+LFxuICBsOiBMZW5zPEIsIEM+XG4pOiBQcmlzbTxBLCBDPiB7XG4gIHJldHVybiBuZXcgUHJpc20oXG4gICAgKGEpID0+IHAuZ2V0KGEpLm1hcChsLmdldCksXG4gICAgKGEsIHYpID0+XG4gICAgICBwXG4gICAgICAgIC5nZXQoYSlcbiAgICAgICAgLm1hcCgoYikgPT4gbC5zZXQoYiwgdikpXG4gICAgICAgIC5tYXAoKGJjKSA9PiBwLnNldChhLCBiYykpXG4gICAgICAgIC53aXRoRGVmYXVsdChhKVxuICApO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY29tcG9zZVByaXNtczxBLCBCLCBDPihcbiAgcDogUHJpc208QSwgQj4sXG4gIHAyOiBQcmlzbTxCLCBDPlxuKTogUHJpc208QSwgQz4ge1xuICByZXR1cm4gbmV3IFByaXNtKFxuICAgIChhKSA9PiBwLmdldChhKS5hbmRUaGVuKHAyLmdldCksXG4gICAgKGEsIHYpID0+XG4gICAgICBwXG4gICAgICAgIC5nZXQoYSlcbiAgICAgICAgLm1hcCgoYikgPT4gcDIuc2V0KGIsIHYpKVxuICAgICAgICAubWFwKChiYykgPT4gcC5zZXQoYSwgYmMpKVxuICAgICAgICAud2l0aERlZmF1bHQoYSlcbiAgKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZpZWxkTGVuczxBLCBLIGV4dGVuZHMga2V5b2YgQT4oZmllbGQ6IEspOiBMZW5zPEEsIEFbS10+IHtcbiAgcmV0dXJuIG5ldyBMZW5zKFxuICAgIChhKSA9PiBhW2ZpZWxkXSxcbiAgICAoYSwgdikgPT4ge1xuICAgICAgY29uc3QgYTEgPSB7IC4uLmEgfTtcbiAgICAgIGExW2ZpZWxkXSA9IHY7XG4gICAgICByZXR1cm4gYTE7XG4gICAgfVxuICApO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZmxhdHRlblByaXNtPEE+KCk6IFByaXNtPE1heWJlPE1heWJlT2Y8QT4+LCBNYXliZU9mPEE+PiB7XG4gIHJldHVybiBuZXcgUHJpc20oXG4gICAgKGEpID0+IGEsXG4gICAgKGEsIHYpID0+IGEubWFwKCgpID0+IHYpLm9yRWxzZShhKVxuICApO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZGlzY3JpbWluYXRlPEIsIEMgZXh0ZW5kcyBCLCBLIGV4dGVuZHMga2V5b2YgQj4oXG4gIHRhZzogSyxcbiAgdjogQ1tLXVxuKTogU3ViVHlwZUd1YXJkPEIsIEM+IHtcbiAgcmV0dXJuIChvKSA9PiAob1t0YWddID09PSB2ID8ganVzdChvIGFzIEMpIDogbm90aGluZyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzdWJQcmlzbTxBLCBCIGV4dGVuZHMgQT4oZjogKGE6IEEpID0+IE1heWJlPEI+KTogUHJpc208QSwgQj4ge1xuICByZXR1cm4gbmV3IFByaXNtKFxuICAgIChhKSA9PiBmKGEpLFxuICAgIChhLCB2KSA9PlxuICAgICAgZihhKVxuICAgICAgICAubWFwPEE+KCgpID0+IHYpXG4gICAgICAgIC53aXRoRGVmYXVsdChhKVxuICApO1xufVxuIl19
/*
 * MIT License
 *
 * Copyright (c) 2019 RÃ©mi Van Keisbelck
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
import { Dict } from './Dict';
import { Tuple } from './Tuple';
import { Just, Nothing } from './Maybe';
import { Left, Right } from './Either';
import { List } from './List';
import { ListWithSelection } from './ListWithSelection';
import { Err, Ok } from './Result';
const DEFAULT_DISCRIMINANT = '__teacup_class_type';
function serializeDate(d) {
    return JSON.stringify({
        __tea_date: true,
        date: d.toISOString(),
    });
}
function deserializeDate(o) {
    return new Date(o.date);
}
function isSerializedDate(o) {
    return o.__tea_date;
}
export class ObjectSerializer {
    constructor(prototypesMap, discriminantField) {
        this.prototypesMap = prototypesMap;
        this.discriminantField = discriminantField || DEFAULT_DISCRIMINANT;
    }
    static withTeaCupClasses() {
        return ObjectSerializer.withClasses([Dict, Left, Right, List, ListWithSelection, Just, Nothing, Ok, Err, Tuple]);
    }
    static withClasses(classes) {
        return new ObjectSerializer(Dict.empty()).addClasses(classes);
    }
    addClasses(classes) {
        return new ObjectSerializer(Dict.fromList(this.prototypesMap.toList().concat(classes.map((c) => new Tuple(c.name, c.prototype)))));
    }
    deserialize(s) {
        return this.applyTransformations(JSON.parse(s));
    }
    serialize(obj) {
        if (obj instanceof Date) {
            return serializeDate(obj);
        }
        if (Array.isArray(obj)) {
            return '[' + obj.map((x) => this.serialize(x)).join(',') + ']';
        }
        if (typeof obj === 'object') {
            const ctor = obj.constructor.name;
            const tag = ctor === 'Object' ? '' : `"${this.discriminantField}": "${ctor}",`;
            return ('{' +
                tag +
                Object.keys(obj)
                    .reduce((acc, k) => {
                    const fieldVal = obj[k];
                    if (fieldVal !== null && fieldVal !== undefined) {
                        const v = this.serialize(obj[k]);
                        return [...acc, `"${k}":${v}`];
                    }
                    else {
                        return acc;
                    }
                }, [])
                    .join(',') +
                '}');
        }
        return JSON.stringify(obj);
    }
    applyTransformations(obj) {
        if (isSerializedDate(obj)) {
            return deserializeDate(obj);
        }
        if (Array.isArray(obj)) {
            return obj.map((x) => this.applyTransformations(x));
        }
        if (typeof obj === 'object') {
            Object.keys(obj).forEach((key) => {
                if (key === this.discriminantField) {
                    // discriminant found, assign proto
                    const proto = this.prototypesMap.get(obj[key]);
                    if (proto.type === 'Just') {
                        Object.setPrototypeOf(obj, proto.value);
                    }
                    else {
                        throw ('Unable to find registered class for discriminant : \n' +
                            obj[key] +
                            '\n' +
                            "Make sure the type is registered to DevTools' serializer");
                    }
                }
                else {
                    // recurse in field
                    obj[key] = this.applyTransformations(obj[key]);
                }
            });
            return obj;
        }
        return obj;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT2JqZWN0U2VyaWFsaXplci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9UZWFDdXAvT2JqZWN0U2VyaWFsaXplci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0F1Qkc7QUFFSCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBQzlCLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDaEMsT0FBTyxFQUFFLElBQUksRUFBUyxPQUFPLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDL0MsT0FBTyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDdkMsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUM5QixPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN4RCxPQUFPLEVBQUUsR0FBRyxFQUFFLEVBQUUsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUVuQyxNQUFNLG9CQUFvQixHQUFHLHFCQUFxQixDQUFDO0FBRW5ELFNBQVMsYUFBYSxDQUFDLENBQU87SUFDNUIsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDO1FBQ3BCLFVBQVUsRUFBRSxJQUFJO1FBQ2hCLElBQUksRUFBRSxDQUFDLENBQUMsV0FBVyxFQUFFO0tBQ3RCLENBQUMsQ0FBQztBQUNMLENBQUM7QUFFRCxTQUFTLGVBQWUsQ0FBQyxDQUFNO0lBQzdCLE9BQU8sSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQzFCLENBQUM7QUFFRCxTQUFTLGdCQUFnQixDQUFDLENBQU07SUFDOUIsT0FBTyxDQUFDLENBQUMsVUFBVSxDQUFDO0FBQ3RCLENBQUM7QUFFRCxNQUFNLE9BQU8sZ0JBQWdCO0lBSTNCLFlBQW9CLGFBQTJCLEVBQUUsaUJBQTBCO1FBQ3pFLElBQUksQ0FBQyxhQUFhLEdBQUcsYUFBYSxDQUFD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LEdBQUcsQ0FBQztRQUNiLENBQUM7UUFDRCxPQUFPLEdBQUcsQ0FBQztJQUNiLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBNSVQgTGljZW5zZVxuICpcbiAqIENvcHlyaWdodCAoYykgMjAxOSBSw6ltaSBWYW4gS2Vpc2JlbGNrXG4gKlxuICogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weVxuICogb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgXCJTb2Z0d2FyZVwiKSwgdG8gZGVhbFxuICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0c1xuICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbFxuICogY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzXG4gKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOlxuICpcbiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluIGFsbFxuICogY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS5cbiAqXG4gKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXG4gKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcbiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxuICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUlxuICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSxcbiAqIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFXG4gKiBTT0ZUV0FSRS5cbiAqXG4gKi9cblxuaW1wb3J0IHsgRGljdCB9IGZyb20gJy4vRGljdCc7XG5pbXBvcnQgeyBUdXBsZSB9IGZyb20gJy4vVHVwbGUnO1xuaW1wb3J0IHsgSnVzdCwgTWF5YmUsIE5vdGhpbmcgfSBmcm9tICcuL01heWJlJztcbmltcG9ydCB7IExlZnQsIFJpZ2h0IH0gZnJvbSAnLi9FaXRoZXInO1xuaW1wb3J0IHsgTGlzdCB9IGZyb20gJy4vTGlzdCc7XG5pbXBvcnQgeyBMaXN0V2l0aFNlbGVjdGlvbiB9IGZyb20gJy4vTGlzdFdpdGhTZWxlY3Rpb24nO1xuaW1wb3J0IHsgRXJyLCBPayB9IGZyb20gJy4vUmVzdWx0JztcblxuY29uc3QgREVGQVVMVF9ESVNDUklNSU5BTlQgPSAnX190ZWFjdXBfY2xhc3NfdHlwZSc7XG5cbmZ1bmN0aW9uIHNlcmlhbGl6ZURhdGUoZDogRGF0ZSk6IHN0cmluZyB7XG4gIHJldHVybiBKU09OLnN0cmluZ2lmeSh7XG4gICAgX190ZWFfZGF0ZTogdHJ1ZSxcbiAgICBkYXRlOiBkLnRvSVNPU3RyaW5nKCksXG4gIH0pO1xufVxuXG5mdW5jdGlvbiBkZXNlcmlhbGl6ZURhdGUobzogYW55KTogRGF0ZSB7XG4gIHJldHVybiBuZXcgRGF0ZShvLmRhdGUpO1xufVxuXG5mdW5jdGlvbiBpc1NlcmlhbGl6ZWREYXRlKG86IGFueSk6IGJvb2xlYW4ge1xuICByZXR1cm4gby5fX3RlYV9kYXRlO1xufVxuXG5leHBvcnQgY2xhc3MgT2JqZWN0U2VyaWFsaXplciB7XG4gIHByaXZhdGUgcmVhZG9ubHkgcHJvdG90eXBlc01hcDogRGljdDxPYmplY3Q+O1xuICBwcml2YXRlIHJlYWRvbmx5IGRpc2NyaW1pbmFudEZpZWxkOiBzdHJpbmc7XG5cbiAgcHJpdmF0ZSBjb25zdHJ1Y3Rvcihwcm90b3R5cGVzTWFwOiBEaWN0PE9iamVjdD4sIGRpc2NyaW1pbmFudEZpZWxkPzogc3RyaW5nKSB7XG4gICAgdGhpcy5wcm90b3R5cGVzTWFwID0gcHJvdG90eXBlc01hcDtcbiAgICB0aGlzLmRpc2NyaW1pbmFudEZpZWxkID0gZGlzY3JpbWluYW50RmllbGQgfHwgREVGQVVMVF9ESVNDUklNSU5BTlQ7XG4gIH1cblxuICBzdGF0aWMgd2l0aFRlYUN1cENsYXNzZXMoKTogT2JqZWN0U2VyaWFsaXplciB7XG4gICAgcmV0dXJuIE9iamVjdFNlcmlhbGl6ZXIud2l0aENsYXNzZXMoW0RpY3QsIExlZnQsIFJpZ2h0LCBMaXN0LCBMaXN0V2l0aFNlbGVjdGlvbiwgSnVzdCwgTm90aGluZywgT2ssIEVyciwgVHVwbGVdKTtcbiAgfVxuXG4gIHN0YXRpYyB3aXRoQ2xhc3NlcyhjbGFzc2VzOiBhbnlbXSk6IE9iamVjdFNlcmlhbGl6ZXIge1xuICAgIHJldHVybiBuZXcgT2JqZWN0U2VyaWFsaXplcihEaWN0LmVtcHR5KCkpLmFkZENsYXNzZXMoY2xhc3Nlcyk7XG4gIH1cblxuICBhZGRDbGFzc2VzKGNsYXNzZXM6IGFueVtdKTogT2JqZWN0U2VyaWFsaXplciB7XG4gICAgcmV0dXJuIG5ldyBPYmplY3RTZXJpYWxpemVyKFxuICAgICAgRGljdC5mcm9tTGlzdCh0aGlzLnByb3RvdHlwZXNNYXAudG9MaXN0KCkuY29uY2F0KGNsYXNzZXMubWFwKChjKSA9PiBuZXcgVHVwbGUoYy5uYW1lLCBjLnByb3RvdHlwZSkpKSksXG4gICAgKTtcbiAgfVxuXG4gIGRlc2VyaWFsaXplKHM6IHN0cmluZyk6IGFueSB7XG4gICAgcmV0dXJuIHRoaXMuYXBwbHlUcmFuc2Zvcm1hdGlvbnMoSlNPTi5wYXJzZShzKSk7XG4gIH1cblxuICBzZXJpYWxpemUob2JqOiBhbnkpOiBzdHJpbmcge1xuICAgIGlmIChvYmogaW5zdGFuY2VvZiBEYXRlKSB7XG4gICAgICByZXR1cm4gc2VyaWFsaXplRGF0ZShvYmopO1xuICAgIH1cbiAgICBpZiAoQXJyYXkuaXNBcnJheShvYmopKSB7XG4gICAgICByZXR1cm4gJ1snICsgb2JqLm1hcCgoeCkgPT4gdGhpcy5zZXJpYWxpemUoeCkpLmpvaW4oJywnKSArICddJztcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBvYmogPT09ICdvYmplY3QnKSB7XG4gICAgICBjb25zdCBjdG9yID0gb2JqLmNvbnN0cnVjdG9yLm5hbWU7XG4gICAgICBjb25zdCB0YWcgPSBjdG9yID09PSAnT2JqZWN0JyA/ICcnIDogYFwiJHt0aGlzLmRpc2NyaW1pbmFudEZpZWxkfVwiOiBcIiR7Y3Rvcn1cIixgO1xuICAgICAgcmV0dXJuIChcbiAgICAgICAgJ3snICtcbiAgICAgICAgdGFnICtcbiAgICAgICAgT2JqZWN0LmtleXMob2JqKVxuICAgICAgICAgIC5yZWR1Y2UoKGFjYzogc3RyaW5nW10sIGs6IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgY29uc3QgZmllbGRWYWwgPSBvYmpba107XG4gICAgICAgICAgICBpZiAoZmllbGRWYWwgIT09IG51bGwgJiYgZmllbGRWYWwgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICBjb25zdCB2ID0gdGhpcy5zZXJpYWxpemUob2JqW2tdKTtcbiAgICAgICAgICAgICAgcmV0dXJuIFsuLi5hY2MsIGBcIiR7a31cIjoke3Z9YF07XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0sIFtdKVxuICAgICAgICAgIC5qb2luKCcsJykgK1xuICAgICAgICAnfSdcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShvYmopO1xuICB9XG5cbiAgcHJpdmF0ZSBhcHBseVRyYW5zZm9ybWF0aW9ucyhvYmo6IGFueSk6IGFueSB7XG4gICAgaWYgKGlzU2VyaWFsaXplZERhdGUob2JqKSkge1xuICAgICAgcmV0dXJuIGRlc2VyaWFsaXplRGF0ZShvYmopO1xuICAgIH1cbiAgICBpZiAoQXJyYXkuaXNBcnJheShvYmopKSB7XG4gICAgICByZXR1cm4gb2JqLm1hcCgoeCkgPT4gdGhpcy5hcHBseVRyYW5zZm9ybWF0aW9ucyh4KSk7XG4gICAgfVxuICAgIGlmICh0eXBlb2Ygb2JqID09PSAnb2JqZWN0Jykge1xuICAgICAgT2JqZWN0LmtleXMob2JqKS5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgICAgaWYgKGtleSA9PT0gdGhpcy5kaXNjcmltaW5hbnRGaWVsZCkge1xuICAgICAgICAgIC8vIGRpc2NyaW1pbmFudCBmb3VuZCwgYXNzaWduIHByb3RvXG4gICAgICAgICAgY29uc3QgcHJvdG8gPSB0aGlzLnByb3RvdHlwZXNNYXAuZ2V0KG9ialtrZXldKTtcbiAgICAgICAgICBpZiAocHJvdG8udHlwZSA9PT0gJ0p1c3QnKSB7XG4gICAgICAgICAgICBPYmplY3Quc2V0UHJvdG90eXBlT2Yob2JqLCBwcm90by52YWx1ZSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRocm93IChcbiAgICAgICAgICAgICAgJ1VuYWJsZSB0byBmaW5kIHJlZ2lzdGVyZWQgY2xhc3MgZm9yIGRpc2NyaW1pbmFudCA6IFxcbicgK1xuICAgICAgICAgICAgICBvYmpba2V5XSArXG4gICAgICAgICAgICAgICdcXG4nICtcbiAgICAgICAgICAgICAgXCJNYWtlIHN1cmUgdGhlIHR5cGUgaXMgcmVnaXN0ZXJlZCB0byBEZXZUb29scycgc2VyaWFsaXplclwiXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyByZWN1cnNlIGluIGZpZWxkXG4gICAgICAgICAgb2JqW2tleV0gPSB0aGlzLmFwcGx5VHJhbnNmb3JtYXRpb25zKG9ialtrZXldKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICByZXR1cm4gb2JqO1xuICAgIH1cbiAgICByZXR1cm4gb2JqO1xuICB9XG59XG4iXX0=
/*
 * MIT License
 *
 * Copyright (c) 2019 RÃ©mi Van Keisbelck
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
import { Task } from './Task';
import { ok } from './Result';
import { Sub } from './Sub';
const everySubs = [];
const everyIntervals = [];
function initIntervalForDelay(delay) {
    if (everyIntervals[delay] === undefined) {
        everyIntervals[delay] = setInterval(() => {
            const subs = everySubs[delay];
            if (subs) {
                subs.forEach((sub) => sub.trigger());
            }
        }, delay);
    }
}
function cleanupIntervalForDelay(delay) {
    const handle = everyIntervals[delay];
    if (handle) {
        clearInterval(handle);
    }
}
class EverySub extends Sub {
    constructor(delay, toMsg) {
        super();
        this.delay = delay;
        this.toMsg = toMsg;
    }
    onInit() {
        super.onInit();
        let subsForDelay = everySubs[this.delay];
        if (subsForDelay === undefined) {
            subsForDelay = [];
            everySubs[this.delay] = subsForDelay;
        }
        subsForDelay.push(this);
        initIntervalForDelay(this.delay);
    }
    onRelease() {
        super.onRelease();
        let subsForDelay = everySubs[this.delay];
        if (subsForDelay !== undefined) {
            everySubs[this.delay] = subsForDelay.filter((s) => s !== this);
            if (everySubs[this.delay].length === 0) {
                cleanupIntervalForDelay(this.delay);
                delete everySubs[this.delay];
            }
        }
    }
    trigger() {
        this.dispatch(this.toMsg());
    }
}
/**
 * Simple module for getting current time and handling setTimeout
 */
export class Time {
    /**
     * Task that returns the current time
     */
    static now() {
        return new TimeTask();
    }
    /**
     * Task that fires in specified time
     */
    static in(timeout) {
        return new InTask(timeout);
    }
    static every(delay, toMsg) {
        return new EverySub(delay, toMsg);
    }
}
function now() {
    return new Date().getTime();
}
class TimeTask extends Task {
    execute(callback) {
        callback(ok(now()));
    }
}
class InTask extends Task {
    constructor(timeout) {
        super();
        this.t = timeout;
    }
    execute(callback) {
        setTimeout(() => callback(ok(now())), this.t);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGltZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9UZWFDdXAvVGltZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0F1Qkc7QUFFSCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBQzlCLE9BQU8sRUFBRSxFQUFFLEVBQVUsTUFBTSxVQUFVLENBQUM7QUFDdEMsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLE9BQU8sQ0FBQztBQUU1QixNQUFNLFNBQVMsR0FBZ0MsRUFBRSxDQUFDO0FBQ2xELE1BQU0sY0FBYyxHQUFlLEVBQUUsQ0FBQztBQUV0QyxTQUFTLG9CQUFvQixDQUFDLEtBQWE7SUFDekMsSUFBSSxjQUFjLENBQUMsS0FBSyxDQUFDLEtBQUssU0FBUyxFQUFFLENBQUM7UUFDeEMsY0FBYyxDQUFDLEtBQUssQ0FBQyxHQUFHLFdBQVcsQ0FBQyxHQUFHLEVBQUU7WUFDdkMsTUFBTSxJQUFJLEdBQUcsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQzlCLElBQUksSUFBSSxFQUFFLENBQUM7Z0JBQ1QsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7WUFDdkMsQ0FBQztRQUNILENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNaLENBQUM7QUFDSCxDQUFDO0FBRUQsU0FBUyx1QkFBdUIsQ0FBQyxLQUFhO0lBQzVDLE1BQU0sTUFBTSxHQUFHLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNyQyxJQUFJLE1BQU0sRUFBRSxDQUFDO1FBQ1gsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3hCLENBQUM7QUFDSCxDQUFDO0FBRUQsTUFBTSxRQUFZLFNBQVEsR0FBTTtJQUk5QixZQUFZLEtBQWEsRUFBRSxLQUFjO1FBQ3ZDLEtBQUssRUFBRSxDQUFDO1FBQ1IsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDbkIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7SUFDckIsQ0FBQztJQUVTLE1BQU07UUFDZCxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDZixJQUFJLFlBQVksR0FBRyxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3pDLElBQUksWUFBWSxLQUFLLFNBQVMsRUFBRSxDQUFDO1lBQy9CLFlBQVksR0FBRyxFQUFFLENBQUM7WUFDbEIsU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxZQUFZLENBQUM7UUFDdkMsQ0FBQztRQUNELFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDeEIsb0JBQW9CLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ25DLENBQUM7SUFFUyxTQUFTO1FBQ2pCLEtBQUssQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUNsQixJQUFJLFlBQVksR0FBRyxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3pDLElBQUksWUFBWSxLQUFLLFNBQVMsRUFBRSxDQUFDO1lBQy9CLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDO1lBQy9ELElBQUksU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7Z0JBQ3ZDLHVCQUF1QixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDcEMsT0FBTyxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQy9CLENBQUM7UUFDSCxDQUFDO0lBQ0gsQ0FBQztJQUVELE9BQU87UUFDTCxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO0lBQzlCLENBQUM7Q0FDRjtBQUVEOztHQUVHO0FBQ0gsTUFBTSxPQUFPLElBQUk7SUFDZjs7T0FFRztJQUNILE1BQU0sQ0FBQyxHQUFHO1FBQ1IsT0FBTyxJQUFJLFFBQVEsRUFBRSxDQUFDO0lBQ3hCLENBQUM7SUFFRDs7T0FFRztJQUNILE1BQU0sQ0FBQyxFQUFFLENBQUMsT0FBZTtRQUN2QixPQUFPLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzdCLENBQUM7SUFFRCxNQUFNLENBQUMsS0FBSyxDQUFJLEtBQWEsRUFBRSxLQUFjO1FBQzNDLE9BQU8sSUFBSSxRQUFRLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ3BDLENBQUM7Q0FDRjtBQUVELFNBQVMsR0FBRztJQUNWLE9BQU8sSUFBSSxJQUFJLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUM5QixDQUFDO0FBRUQsTUFBTSxRQUFTLFNBQVEsSUFBbUI7SUFDeEMsT0FBTyxDQUFDLFFBQTRDO1FBQ2xELFFBQVEsQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ3RCLENBQUM7Q0FDRjtBQUVELE1BQU0sTUFBTyxTQUFRLElBQW1CO0lBR3RDLFlBQVksT0FBZTtRQUN6QixLQUFLLEVBQUUsQ0FBQztRQUNSLElBQUksQ0FBQyxDQUFDLEdBQUcsT0FBTyxDQUFDO0lBQ25CLENBQUM7SUFFRCxPQUFPLENBQUMsUUFBNEM7UUFDbEQsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNoRCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTUlUIExpY2Vuc2VcbiAqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTkgUsOpbWkgVmFuIEtlaXNiZWxja1xuICpcbiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlIFwiU29mdHdhcmVcIiksIHRvIGRlYWxcbiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHNcbiAqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGxcbiAqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpc1xuICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczpcbiAqXG4gKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbiBhbGxcbiAqIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuXG4gKlxuICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuICogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksXG4gKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbiAqIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXG4gKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRVxuICogU09GVFdBUkUuXG4gKlxuICovXG5cbmltcG9ydCB7IFRhc2sgfSBmcm9tICcuL1Rhc2snO1xuaW1wb3J0IHsgb2ssIFJlc3VsdCB9IGZyb20gJy4vUmVzdWx0JztcbmltcG9ydCB7IFN1YiB9IGZyb20gJy4vU3ViJztcblxuY29uc3QgZXZlcnlTdWJzOiBBcnJheTxBcnJheTxFdmVyeVN1Yjxhbnk+Pj4gPSBbXTtcbmNvbnN0IGV2ZXJ5SW50ZXJ2YWxzOiBBcnJheTxhbnk+ID0gW107XG5cbmZ1bmN0aW9uIGluaXRJbnRlcnZhbEZvckRlbGF5KGRlbGF5OiBudW1iZXIpIHtcbiAgaWYgKGV2ZXJ5SW50ZXJ2YWxzW2RlbGF5XSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgZXZlcnlJbnRlcnZhbHNbZGVsYXldID0gc2V0SW50ZXJ2YWwoKCkgPT4ge1xuICAgICAgY29uc3Qgc3VicyA9IGV2ZXJ5U3Vic1tkZWxheV07XG4gICAgICBpZiAoc3Vicykge1xuICAgICAgICBzdWJzLmZvckVhY2goKHN1YikgPT4gc3ViLnRyaWdnZXIoKSk7XG4gICAgICB9XG4gICAgfSwgZGVsYXkpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGNsZWFudXBJbnRlcnZhbEZvckRlbGF5KGRlbGF5OiBudW1iZXIpIHtcbiAgY29uc3QgaGFuZGxlID0gZXZlcnlJbnRlcnZhbHNbZGVsYXldO1xuICBpZiAoaGFuZGxlKSB7XG4gICAgY2xlYXJJbnRlcnZhbChoYW5kbGUpO1xuICB9XG59XG5cbmNsYXNzIEV2ZXJ5U3ViPE0+IGV4dGVuZHMgU3ViPE0+IHtcbiAgcHJpdmF0ZSByZWFkb25seSBkZWxheTogbnVtYmVyO1xuICBwcml2YXRlIHJlYWRvbmx5IHRvTXNnOiAoKSA9PiBNO1xuXG4gIGNvbnN0cnVjdG9yKGRlbGF5OiBudW1iZXIsIHRvTXNnOiAoKSA9PiBNKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLmRlbGF5ID0gZGVsYXk7XG4gICAgdGhpcy50b01zZyA9IHRvTXNnO1xuICB9XG5cbiAgcHJvdGVjdGVkIG9uSW5pdCgpIHtcbiAgICBzdXBlci5vbkluaXQoKTtcbiAgICBsZXQgc3Vic0ZvckRlbGF5ID0gZXZlcnlTdWJzW3RoaXMuZGVsYXldO1xuICAgIGlmIChzdWJzRm9yRGVsYXkgPT09IHVuZGVmaW5lZCkge1xuICAgICAgc3Vic0ZvckRlbGF5ID0gW107XG4gICAgICBldmVyeVN1YnNbdGhpcy5kZWxheV0gPSBzdWJzRm9yRGVsYXk7XG4gICAgfVxuICAgIHN1YnNGb3JEZWxheS5wdXNoKHRoaXMpO1xuICAgIGluaXRJbnRlcnZhbEZvckRlbGF5KHRoaXMuZGVsYXkpO1xuICB9XG5cbiAgcHJvdGVjdGVkIG9uUmVsZWFzZSgpIHtcbiAgICBzdXBlci5vblJlbGVhc2UoKTtcbiAgICBsZXQgc3Vic0ZvckRlbGF5ID0gZXZlcnlTdWJzW3RoaXMuZGVsYXldO1xuICAgIGlmIChzdWJzRm9yRGVsYXkgIT09IHVuZGVmaW5lZCkge1xuICAgICAgZXZlcnlTdWJzW3RoaXMuZGVsYXldID0gc3Vic0ZvckRlbGF5LmZpbHRlcigocykgPT4gcyAhPT0gdGhpcyk7XG4gICAgICBpZiAoZXZlcnlTdWJzW3RoaXMuZGVsYXldLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICBjbGVhbnVwSW50ZXJ2YWxGb3JEZWxheSh0aGlzLmRlbGF5KTtcbiAgICAgICAgZGVsZXRlIGV2ZXJ5U3Vic1t0aGlzLmRlbGF5XTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICB0cmlnZ2VyKCkge1xuICAgIHRoaXMuZGlzcGF0Y2godGhpcy50b01zZygpKTtcbiAgfVxufVxuXG4vKipcbiAqIFNpbXBsZSBtb2R1bGUgZm9yIGdldHRpbmcgY3VycmVudCB0aW1lIGFuZCBoYW5kbGluZyBzZXRUaW1lb3V0XG4gKi9cbmV4cG9ydCBjbGFzcyBUaW1lIHtcbiAgLyoqXG4gICAqIFRhc2sgdGhhdCByZXR1cm5zIHRoZSBjdXJyZW50IHRpbWVcbiAgICovXG4gIHN0YXRpYyBub3coKTogVGFzazxuZXZlciwgbnVtYmVyPiB7XG4gICAgcmV0dXJuIG5ldyBUaW1lVGFzaygpO1xuICB9XG5cbiAgLyoqXG4gICAqIFRhc2sgdGhhdCBmaXJlcyBpbiBzcGVjaWZpZWQgdGltZVxuICAgKi9cbiAgc3RhdGljIGluKHRpbWVvdXQ6IG51bWJlcik6IFRhc2s8bmV2ZXIsIG51bWJlcj4ge1xuICAgIHJldHVybiBuZXcgSW5UYXNrKHRpbWVvdXQpO1xuICB9XG5cbiAgc3RhdGljIGV2ZXJ5PE0+KGRlbGF5OiBudW1iZXIsIHRvTXNnOiAoKSA9PiBNKTogU3ViPE0+IHtcbiAgICByZXR1cm4gbmV3IEV2ZXJ5U3ViKGRlbGF5LCB0b01zZyk7XG4gIH1cbn1cblxuZnVuY3Rpb24gbm93KCk6IG51bWJlciB7XG4gIHJldHVybiBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbn1cblxuY2xhc3MgVGltZVRhc2sgZXh0ZW5kcyBUYXNrPG5ldmVyLCBudW1iZXI+IHtcbiAgZXhlY3V0ZShjYWxsYmFjazogKHI6IFJlc3VsdDxuZXZlciwgbnVtYmVyPikgPT4gdm9pZCk6IHZvaWQge1xuICAgIGNhbGxiYWNrKG9rKG5vdygpKSk7XG4gIH1cbn1cblxuY2xhc3MgSW5UYXNrIGV4dGVuZHMgVGFzazxuZXZlciwgbnVtYmVyPiB7XG4gIHByaXZhdGUgcmVhZG9ubHkgdDogbnVtYmVyO1xuXG4gIGNvbnN0cnVjdG9yKHRpbWVvdXQ6IG51bWJlcikge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy50ID0gdGltZW91dDtcbiAgfVxuXG4gIGV4ZWN1dGUoY2FsbGJhY2s6IChyOiBSZXN1bHQ8bmV2ZXIsIG51bWJlcj4pID0+IHZvaWQpOiB2b2lkIHtcbiAgICBzZXRUaW1lb3V0KCgpID0+IGNhbGxiYWNrKG9rKG5vdygpKSksIHRoaXMudCk7XG4gIH1cbn1cbiJdfQ==
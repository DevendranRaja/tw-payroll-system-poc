/*
 * MIT License
 *
 * Copyright (c) 2019 RÃ©mi Van Keisbelck
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
import { Task } from './Task';
import { err, ok } from './Result';
import { asError } from './Try';
/**
 * Turns JS's fetch into Tasks.
 */
export class Http {
    /**
     * Create a task over the native fetch() function.
     * @param request the request
     * @param init the request init
     */
    static fetch(request, init) {
        return new FetchTask(request, init);
    }
    /**
     * Helper for JSON responses : uses passed decoder to convert a
     * JSON response
     * @param t the fetch task
     * @param d the decoder
     */
    static jsonBody(t, d) {
        return Http.ifOk(t, (r) => Task.fromPromise(() => r.json()).andThen((json) => {
            const decoded = d.decodeValue(json);
            switch (decoded.tag) {
                case 'Ok':
                    return Task.succeed(decoded.value);
                case 'Err':
                    return Task.fail(new Error(decoded.err));
            }
        }));
    }
    /**
     * Helper for string responses.
     * @param t the fetch task
     */
    static stringBody(t) {
        return Http.ifOk(t, (response) => Task.fromPromise(() => response.text()));
    }
    /**
     * Helper for turning a response that is not ok into an error
     * @param t the response
     * @param f a function that maps the Response to a type
     */
    static ifOk(t, f) {
        return t.andThen((r) => {
            if (r.ok) {
                return f(r);
            }
            else {
                return Task.fail(new Error(`invalid response ${r.status}:${r.statusText}`));
            }
        });
    }
}
class FetchTask extends Task {
    constructor(request, init) {
        super();
        this.request = request;
        this.init = init;
    }
    execute(callback) {
        try {
            fetch(this.request, this.init)
                .then((response) => callback(ok(response)))
                .catch((e) => callback(err(e)));
        }
        catch (e) {
            callback(err(asError(e)));
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSHR0cC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9UZWFDdXAvSHR0cC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0F1Qkc7QUFFSCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBQzlCLE9BQU8sRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFVLE1BQU0sVUFBVSxDQUFDO0FBRTNDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxPQUFPLENBQUM7QUFFaEM7O0dBRUc7QUFDSCxNQUFNLE9BQU8sSUFBSTtJQUNmOzs7O09BSUc7SUFDSCxNQUFNLENBQUMsS0FBSyxDQUFDLE9BQW9CLEVBQUUsSUFBa0I7UUFDbkQsT0FBTyxJQUFJLFNBQVMsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDdEMsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0gsTUFBTSxDQUFDLFFBQVEsQ0FBSSxDQUF3QixFQUFFLENBQWE7UUFDeEQsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQ3hCLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBUyxFQUFFLEVBQUU7WUFDckQsTUFBTSxPQUFPLEdBQXNCLENBQUMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDdkQsUUFBUSxPQUFPLENBQUMsR0FBRyxFQUFFLENBQUM7Z0JBQ3BCLEtBQUssSUFBSTtvQkFDUCxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUNyQyxLQUFLLEtBQUs7b0JBQ1IsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQzdDLENBQUM7UUFDSCxDQUFDLENBQUMsQ0FDSCxDQUFDO0lBQ0osQ0FBQztJQUVEOzs7T0FHRztJQUNILE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBd0I7UUFDeEMsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQzdFLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsTUFBTSxDQUFDLElBQUksQ0FBSSxDQUF3QixFQUFFLENBQWtDO1FBQ3pFLE9BQU8sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFO1lBQ3JCLElBQUksQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDO2dCQUNULE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2QsQ0FBQztpQkFBTSxDQUFDO2dCQUNOLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEtBQUssQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLE1BQU0sSUFBSSxDQUFDLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQzlFLENBQUM7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FDRjtBQUVELE1BQU0sU0FBVSxTQUFRLElBQXFCO0lBSTNDLFlBQVksT0FBb0IsRUFBRSxJQUFrQjtRQUNsRCxLQUFLLEVBQUUsQ0FBQztRQUNSLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0lBQ25CLENBQUM7SUFFRCxPQUFPLENBQUMsUUFBOEM7UUFDcEQsSUFBSSxDQUFDO1lBQ0gsS0FBSyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQztpQkFDM0IsSUFBSSxDQUFDLENBQUMsUUFBa0IsRUFBRSxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO2lCQUNwRCxLQUFLLENBQUMsQ0FBQyxDQUFRLEVBQUUsRUFBRSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzNDLENBQUM7UUFBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1lBQ1gsUUFBUSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzVCLENBQUM7SUFDSCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTUlUIExpY2Vuc2VcbiAqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTkgUsOpbWkgVmFuIEtlaXNiZWxja1xuICpcbiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlIFwiU29mdHdhcmVcIiksIHRvIGRlYWxcbiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHNcbiAqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGxcbiAqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpc1xuICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczpcbiAqXG4gKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbiBhbGxcbiAqIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuXG4gKlxuICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuICogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksXG4gKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbiAqIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXG4gKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRVxuICogU09GVFdBUkUuXG4gKlxuICovXG5cbmltcG9ydCB7IFRhc2sgfSBmcm9tICcuL1Rhc2snO1xuaW1wb3J0IHsgZXJyLCBvaywgUmVzdWx0IH0gZnJvbSAnLi9SZXN1bHQnO1xuaW1wb3J0IHsgRGVjb2RlciB9IGZyb20gJy4vRGVjb2RlJztcbmltcG9ydCB7IGFzRXJyb3IgfSBmcm9tICcuL1RyeSc7XG5cbi8qKlxuICogVHVybnMgSlMncyBmZXRjaCBpbnRvIFRhc2tzLlxuICovXG5leHBvcnQgY2xhc3MgSHR0cCB7XG4gIC8qKlxuICAgKiBDcmVhdGUgYSB0YXNrIG92ZXIgdGhlIG5hdGl2ZSBmZXRjaCgpIGZ1bmN0aW9uLlxuICAgKiBAcGFyYW0gcmVxdWVzdCB0aGUgcmVxdWVzdFxuICAgKiBAcGFyYW0gaW5pdCB0aGUgcmVxdWVzdCBpbml0XG4gICAqL1xuICBzdGF0aWMgZmV0Y2gocmVxdWVzdDogUmVxdWVzdEluZm8sIGluaXQ/OiBSZXF1ZXN0SW5pdCk6IFRhc2s8RXJyb3IsIFJlc3BvbnNlPiB7XG4gICAgcmV0dXJuIG5ldyBGZXRjaFRhc2socmVxdWVzdCwgaW5pdCk7XG4gIH1cblxuICAvKipcbiAgICogSGVscGVyIGZvciBKU09OIHJlc3BvbnNlcyA6IHVzZXMgcGFzc2VkIGRlY29kZXIgdG8gY29udmVydCBhXG4gICAqIEpTT04gcmVzcG9uc2VcbiAgICogQHBhcmFtIHQgdGhlIGZldGNoIHRhc2tcbiAgICogQHBhcmFtIGQgdGhlIGRlY29kZXJcbiAgICovXG4gIHN0YXRpYyBqc29uQm9keTxSPih0OiBUYXNrPEVycm9yLCBSZXNwb25zZT4sIGQ6IERlY29kZXI8Uj4pOiBUYXNrPEVycm9yLCBSPiB7XG4gICAgcmV0dXJuIEh0dHAuaWZPayh0LCAocikgPT5cbiAgICAgIFRhc2suZnJvbVByb21pc2UoKCkgPT4gci5qc29uKCkpLmFuZFRoZW4oKGpzb246IGFueSkgPT4ge1xuICAgICAgICBjb25zdCBkZWNvZGVkOiBSZXN1bHQ8c3RyaW5nLCBSPiA9IGQuZGVjb2RlVmFsdWUoanNvbik7XG4gICAgICAgIHN3aXRjaCAoZGVjb2RlZC50YWcpIHtcbiAgICAgICAgICBjYXNlICdPayc6XG4gICAgICAgICAgICByZXR1cm4gVGFzay5zdWNjZWVkKGRlY29kZWQudmFsdWUpO1xuICAgICAgICAgIGNhc2UgJ0Vycic6XG4gICAgICAgICAgICByZXR1cm4gVGFzay5mYWlsKG5ldyBFcnJvcihkZWNvZGVkLmVycikpO1xuICAgICAgICB9XG4gICAgICB9KSxcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIEhlbHBlciBmb3Igc3RyaW5nIHJlc3BvbnNlcy5cbiAgICogQHBhcmFtIHQgdGhlIGZldGNoIHRhc2tcbiAgICovXG4gIHN0YXRpYyBzdHJpbmdCb2R5KHQ6IFRhc2s8RXJyb3IsIFJlc3BvbnNlPik6IFRhc2s8RXJyb3IsIHN0cmluZz4ge1xuICAgIHJldHVybiBIdHRwLmlmT2sodCwgKHJlc3BvbnNlKSA9PiBUYXNrLmZyb21Qcm9taXNlKCgpID0+IHJlc3BvbnNlLnRleHQoKSkpO1xuICB9XG5cbiAgLyoqXG4gICAqIEhlbHBlciBmb3IgdHVybmluZyBhIHJlc3BvbnNlIHRoYXQgaXMgbm90IG9rIGludG8gYW4gZXJyb3JcbiAgICogQHBhcmFtIHQgdGhlIHJlc3BvbnNlXG4gICAqIEBwYXJhbSBmIGEgZnVuY3Rpb24gdGhhdCBtYXBzIHRoZSBSZXNwb25zZSB0byBhIHR5cGVcbiAgICovXG4gIHN0YXRpYyBpZk9rPFI+KHQ6IFRhc2s8RXJyb3IsIFJlc3BvbnNlPiwgZjogKHI6IFJlc3BvbnNlKSA9PiBUYXNrPEVycm9yLCBSPik6IFRhc2s8RXJyb3IsIFI+IHtcbiAgICByZXR1cm4gdC5hbmRUaGVuKChyKSA9PiB7XG4gICAgICBpZiAoci5vaykge1xuICAgICAgICByZXR1cm4gZihyKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBUYXNrLmZhaWwobmV3IEVycm9yKGBpbnZhbGlkIHJlc3BvbnNlICR7ci5zdGF0dXN9OiR7ci5zdGF0dXNUZXh0fWApKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxufVxuXG5jbGFzcyBGZXRjaFRhc2sgZXh0ZW5kcyBUYXNrPEVycm9yLCBSZXNwb25zZT4ge1xuICBwcml2YXRlIHJlYWRvbmx5IHJlcXVlc3Q6IFJlcXVlc3RJbmZvO1xuICBwcml2YXRlIHJlYWRvbmx5IGluaXQ/OiBSZXF1ZXN0SW5pdDtcblxuICBjb25zdHJ1Y3RvcihyZXF1ZXN0OiBSZXF1ZXN0SW5mbywgaW5pdD86IFJlcXVlc3RJbml0KSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLnJlcXVlc3QgPSByZXF1ZXN0O1xuICAgIHRoaXMuaW5pdCA9IGluaXQ7XG4gIH1cblxuICBleGVjdXRlKGNhbGxiYWNrOiAocjogUmVzdWx0PEVycm9yLCBSZXNwb25zZT4pID0+IHZvaWQpOiB2b2lkIHtcbiAgICB0cnkge1xuICAgICAgZmV0Y2godGhpcy5yZXF1ZXN0LCB0aGlzLmluaXQpXG4gICAgICAgIC50aGVuKChyZXNwb25zZTogUmVzcG9uc2UpID0+IGNhbGxiYWNrKG9rKHJlc3BvbnNlKSkpXG4gICAgICAgIC5jYXRjaCgoZTogRXJyb3IpID0+IGNhbGxiYWNrKGVycihlKSkpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNhbGxiYWNrKGVycihhc0Vycm9yKGUpKSk7XG4gICAgfVxuICB9XG59XG4iXX0=